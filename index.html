<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TDCç’°å“©åŒ¯ x èˆªç©ºå¡æ¶ˆè²»ç´¯å“©å·¥å…· v12.24 (iOSå®Œç¾ç›¸å®¹ç‰ˆ)</title>

  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* =========================
       CSS æ¨£å¼è¡¨ (v12.24 Final)
       ========================= */
    :root {
      --bg-main: #fffdf9;
      --bg-card: #ffffff;
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --text-header: #334155;
      --text-body: #475569;
      --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --radius-pill: 50px;
      --font-hand: 'Mali', cursive;
      --font-main: 'Varela Round', sans-serif;
    }

    body {
      background-color: var(--bg-main);
      color: var(--text-body);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex; flex-direction: column;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
      background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); }

    /* Header */
    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: relative; 
      box-shadow: var(--shadow-draw); margin-bottom: -10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 100px; border-bottom: 3px dashed #bae6fd;
      z-index: 100;
    }
    .header-icon {
      width: 44px; height: 44px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.2rem; transform: rotate(-5deg); margin-right: 12px;
      flex-shrink: 0;
    }
    .header-title h5 { margin: 0; font-size: 1.1rem; color: var(--primary-dark); line-height: 1.3; }
    .header-title small { color: var(--text-light); font-size: 0.8rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.9rem;
      padding: 8px 14px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 20px;
      transition: 0.1s; white-space: nowrap;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 20px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 101; flex: 1; }
    
    .card-box { background: var(--bg-card); border-radius: var(--radius-box); padding: 20px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: var(--shadow-draw); }

    .form-label { font-weight: 700; color: var(--text-header); margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand); }
    .form-control, .form-select { background-color: #fff !important; border: 2px solid #cbd5e1 !important; color: var(--text-header) !important; padding: 10px 14px; border-radius: 16px; font-size: 1rem; font-weight: 600; height: 48px; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03); }
    .form-control:focus, .form-select:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important; }
    .form-control::placeholder { color: #cbd5e1; font-weight: 500; font-size: 0.9rem; }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); transition: all 0.3s ease; }
    
    /* Visual Guard Style */
    .input-negative {
        color: #ef4444 !important; /* Red */
        font-weight: 900 !important;
        font-size: 1.8rem !important; 
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
    }
    .status-label-negative {
        color: #ef4444;
        font-size: 0.8rem;
        font-weight: 700;
        margin-top: 4px;
        font-family: var(--font-hand);
        display: none; /* Hidden by default */
        animation: fadeIn 0.2s ease;
    }

    .btn-action { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; font-weight: 700; border-radius: var(--radius-pill); padding: 14px; width: 100%; border: none; font-size: 1.1rem; font-family: var(--font-hand); box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25); margin-top: 10px; border: 2px solid #bfdbfe; transition: 0.1s; }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    .switch-group { background: #f8fafc; padding: 10px 14px; border-radius: 16px; border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0; display: flex; align-items: center; justify-content: space-between; height: 100%; white-space: nowrap; cursor: pointer; transition: 0.2s; }
    .switch-group:active { transform: translateY(2px); box-shadow: 0 0 0; }
    .switch-label { font-size: 0.85rem; font-weight: 700; color: var(--text-body); font-family: var(--font-hand); margin-right: 4px; display: flex; align-items: center; gap: 6px; }
    .form-check-input { width: 2.8em; height: 1.5em; background-color: #cbd5e1; border: 2px solid #cbd5e1; cursor: pointer; transition: 0.3s; flex-shrink: 0; pointer-events: none; /* Let container handle click */ }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .result-tag { background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-block; font-family: var(--font-hand); box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(-1deg); }

    .plan-card { padding: 16px; border-radius: 18px; margin-top: 12px; border: 2px solid #f1f5f9; position: relative; background: #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .plan-winner { border-color: var(--primary); background: #f0f9ff; transform: rotate(-0.5deg); }
    .winner-badge { position: absolute; top: -12px; right: 10px; background: #fde047; color: var(--text-header); font-size: 0.75rem; padding: 4px 12px; border-radius: 14px; font-weight: 700; border: 2px solid #fde047; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(3deg); font-family: var(--font-hand); }
    .warning-badge { background: #fee2e2; color: #ef4444; font-size: 0.75rem; padding: 2px 8px; border-radius: 8px; font-weight: 700; border: 1px solid #fecaca; display: inline-block; margin-top: 4px; }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    .card-tpm { font-size: 0.75rem; color: #94a3b8; font-weight: 700; background: #fff; padding: 2px 8px; border-radius: 10px; display: inline-block; border: 1px solid #e2e8f0; }

    .card-actions { margin-top: 10px; display: flex; gap: 8px; }
    .btn-card-action { 
        border: 1px solid #e2e8f0; background: #fff; color: #64748b; 
        border-radius: 50px; padding: 6px 14px; font-size: 0.8rem; font-weight: 700; 
        font-family: var(--font-hand); cursor: pointer; transition: 0.2s; 
        display: flex; align-items: center; gap: 4px; box-shadow: 1px 1px 0 #e2e8f0;
    }
    .btn-card-action:hover { transform: translateY(-1px); }
    .btn-card-action.btn-record-win { background: #3b82f6; color: white; border-color: #2563eb; box-shadow: 1px 1px 0 #2563eb; }
    .btn-card-action.btn-record { color: var(--primary); border-color: #bfdbfe; background: #eff6ff; }

    .btn-correct { border: 1px solid #e2e8f0; background: #fff; color: #94a3b8; border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; font-weight: 700; font-family: var(--font-hand); cursor: pointer; transition: 0.2s; }
    .btn-correct:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }
    .custom-rule-tag { font-size: 0.7rem; color: #fff; background: #a8a29e; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-block; transform: rotate(0deg); box-shadow: none; font-weight: normal; }

    .nccc-alert { background-color: #fffbeb; border: 2px dashed #f59e0b; border-radius: 16px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; color: #92400e; text-align: left; }
    .nccc-btn { display: inline-block; margin-top: 8px; background: #fff; border: 1px solid #f59e0b; color: #d97706; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; text-decoration: none; box-shadow: 2px 2px 0 rgba(245, 158, 11, 0.2); }
    
    #fx-input-group { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{ opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

    .nav-bottom { position: relative; width: 100%; background: #ffffff; border-top: 2px solid #e2e8f0; border-top-left-radius: 24px; border-top-right-radius: 24px; display: flex; justify-content: space-evenly; padding: 15px 0 30px 0; margin-top: 20px; z-index: 90; box-shadow: 0 -4px 20px rgba(0,0,0,0.02); }
    .nav-item { color: var(--text-light); font-size: 0.75rem; font-weight: 700; cursor: pointer; padding: 6px 12px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-family: var(--font-hand); border-radius: 16px; flex: 1; }
    .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-2px); transition: 0.2s; }

    .modal-content { border-radius: 24px; border: 3px solid #bfdbfe; background: #fffdf7; }
    .modal-header { border-bottom: 2px dashed #e2e8f0; padding: 20px; }
    .modal-title { font-weight: 800; color: var(--text-header); font-family: var(--font-hand); }
    .setting-section { background: #fff; padding: 16px; border-radius: 18px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: 2px 2px 0 #f1f5f9; }
    .setting-title { font-size: 0.9rem; font-weight: 700; color: var(--text-header); margin-bottom: 12px; font-family: var(--font-hand); display: flex; align-items: center; gap:6px; }
    .setting-title::before { content:''; display:inline-block; width:4px; height:16px; background:var(--primary); border-radius:4px; }
    .custom-card-item { background: #f8fafc; padding: 10px 12px; border-radius: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e2e8f0; }
    .delete-btn { color: #ef4444; background: #fff; width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #fecaca; box-shadow: 2px 2px 0 #fecaca; }
    
    .update-info { font-family: var(--font-hand); color: #1e293b; font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; text-align: center; background: #f0f9ff; display: inline-block; padding: 8px 20px; border-radius: 50px; border: 2px solid #bfdbfe; box-shadow: 2px 2px 0 #bfdbfe; }
    .disclaimer-text { font-size: 0.9rem; color: #000000; font-weight: 700; text-align: justify; line-height: 1.6; margin-top: 30px; padding: 16px; background: #fff; border: 2px solid #000; border-radius: 16px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
    
    .guide-step { display: flex; gap: 12px; margin-bottom: 20px; }
    .step-num { width: 30px; height: 30px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: var(--font-hand); flex-shrink: 0; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
    .step-content h6 { margin-bottom: 4px; color: var(--primary-dark); }
    .step-content p { font-size: 0.9rem; margin: 0; line-height: 1.5; }
    
    .airline-group-card { background: #fdfdfd; border: 2px solid #bfdbfe; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(191, 219, 254, 0.2); overflow: hidden; }
    .airline-header { background: #eff6ff; padding: 12px 16px; border-bottom: 2px solid #bfdbfe; display: flex; justify-content: space-between; align-items: center; }
    .airline-title { font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; }
    .airline-total { font-weight: 800; color: var(--text-header); font-size: 1.2rem; }
    .airline-body { padding: 16px; }
    .asset-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .asset-info { display: flex; flex-direction: column; }
    .asset-name { font-weight: 700; color: #334155; font-size: 0.9rem; }
    .asset-detail { font-size: 0.75rem; color: #94a3b8; }
    .asset-value { font-weight: 700; color: var(--primary); }
    .btn-asset-del, .btn-asset-edit { color: #cbd5e1; cursor: pointer; padding: 4px; transition: 0.2s; }
    .btn-asset-del:hover { color: #ef4444; }
    .btn-asset-edit:hover { color: var(--primary); }

    .target-input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; background: #f8fafc; padding: 8px; border-radius: 12px; border: 1px dashed #cbd5e1; }
    .input-block-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .input-block-title { font-family: var(--font-hand); font-weight: 700; color: #334155; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    
    .btn-reset-limit {
        font-size: 0.75rem; color: #64748b; background: white; border: 1px solid #cbd5e1;
        border-radius: 12px; padding: 2px 8px; cursor: pointer; transition: 0.2s;
        margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;
    }
    .btn-reset-limit:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }
    
    /* Summary Dashboard Styles */
    .summary-card { background: white; border: 2px solid #e2e8f0; border-radius: 16px; margin-bottom: 8px; padding: 12px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .summary-name { font-weight: 800; color: #334155; font-size: 1rem; margin-bottom: 2px; }
    .summary-spend { font-size: 0.8rem; color: #64748b; font-weight: 600; }
    .summary-miles { font-weight: 800; color: var(--primary); font-family: var(--font-hand); font-size: 1.1rem; }
  </style>
</head>

<body>
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="header-title">
        <h5>TDCç’°å“©åŒ¯ x èˆªç©ºå¡<br>æ¶ˆè²»ç´¯å“©å·¥å…· v12.24</h5>
        <small class="text-secondary fw-bold">âš™ï¸ iOSå®Œç¾ç›¸å®¹ç‰ˆ</small>
      </div>
    </div>
    <button class="btn-header" onclick="openSettings()"><i class="fa-solid fa-gear me-1"></i> è¨­å®š</button>
  </div>

  <div class="container-custom">
    
    <div class="text-center w-100">
       <div class="update-info">
         <i class="fa-solid fa-circle-info me-1 text-primary"></i> 
         è³‡æ–™åº«æœ€å¾Œæ›´æ–°ï¼š<span class="db-date-display text-primary"></span>
       </div>
    </div>

    <!-- Page: Calculator -->
    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" id="switch-box-birthdayMode" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><i class="fa-solid fa-cake-candles"></i> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" id="switch-box-flyMode" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><i class="fa-solid fa-ticket"></i> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-primary"><i class="fa-solid fa-crosshairs me-1"></i> ç´¯ç©ç›®æ¨™ (èˆªç©º/è¨ˆç•«)</label>
          <select id="redemption-target" class="form-select border-primary" style="background-color: #eff6ff !important; border-width: 2px;">
            <option value="ALL">ğŸŒ ä¸æŒ‡å®š (æ‰€æœ‰èˆªå¸)</option>
            <option value="AM_BR">ğŸŒ äºè¬ / é•·æ¦® (AM / BR)</option>
            <option value="CI">ğŸŒ¸ ä¸­è¯èˆªç©º (CI)</option>
          </select>
        </div>

        <div class="row g-2 mb-1">
            <div class="col-6">
              <label class="form-label">å¹£åˆ¥</label>
              <select id="currency" class="form-select" onchange="checkCurrency(this.value)">
                <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
                <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
                <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD</option>
                <option value="other">ğŸŒ å…¶ä»–</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
              <select id="payment" class="form-select">
                <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
                <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
                <option value="apple_pay">ğŸ Apple Pay</option>
                <option value="line_pay">ğŸŸ© LINE Pay</option>
              </select>
            </div>
          </div>

        <div class="mb-3 mt-3">
          <label class="form-label" id="amount-label">æ¶ˆè²»é‡‘é¡ (TWD)</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary font-hand fw-bold" type="button" onclick="toggleSign('amount')" style="font-size: 0.9rem; background-color:#f8fafc;">é€€åˆ· / ä¿®æ­£</button>
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal" oninput="checkInputStyle(this)">
          </div>
          <div id="amount-status" class="status-label-negative">âš ï¸ ä¿®æ­£/é€€åˆ·æ¨¡å¼ (æ²–å¸³)</div>
        </div>

        <div id="fx-input-group" class="mb-3 p-3 rounded-3" style="background: #f0f9ff; border: 2px dashed #bae6fd; display: none;">
            <label class="form-label text-primary">è‡ªè¨‚åŒ¯ç‡</label>
            <div class="input-group mb-2">
                <span class="input-group-text bg-white">1 å¤–å¹£ = </span>
                <input type="number" id="fx-rate-input" class="form-control" placeholder="åŒ¯ç‡" inputmode="decimal" min="0" step="0.0001">
                <span class="input-group-text bg-white">TWD</span>
            </div>
            <a href="https://rate.bot.com.tw/trial/t14" target="_blank" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold mb-2">
                <i class="fa-solid fa-building-columns me-1"></i> ğŸ¦ è‡ºç£éŠ€è¡Œç‰Œå‘ŠåŒ¯ç‡
            </a>
            <div class="text-muted small">
                <i class="fa-solid fa-calculator me-1"></i> 
                å°‡ä»¥ <strong>(å¤–å¹£ x åŒ¯ç‡)</strong> ä½œç‚ºæœ¬é‡‘è¨ˆç®—ï¼Œä¸¦è‡ªå‹•å¤–åŠ  1.5% æ‰‹çºŒè²»ã€‚
            </div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda, åœè»Š)..." style="font-size:0.9rem;">
          <div class="text-muted small mt-1 ms-1"><i class="fa-solid fa-lightbulb text-warning"></i> è¼¸å…¥é—œéµå­—å¯è§¸ç™¼æ‚¨çš„è‡ªè¨‚ä¿®æ­£è¦å‰‡</div>
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <i class="fa-solid fa-calculator ms-2"></i></button>
      </div>

      <div id="result-area">
        <div class="nccc-alert">
          <div class="fw-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i> ç•™æ„å°é¡æ”¯ä»˜ç„¡å›é¥‹</div>
          é€£é–é€Ÿé£Ÿ(éº¥ç•¶å‹/è‚¯å¾·åŸºç­‰)ã€é£²æ–™åº—ã€åœè»Šå ´ã€ä¾¿åˆ©å•†åº—ç­‰é€šè·¯ï¼Œæ¥µé«˜æ©Ÿç‡å±¬æ–¼ã€ŒNCCCå°é¡æ”¯ä»˜ã€ï¼Œé€šå¸¸ç„¡å›é¥‹ã€‚
          <div class="text-center">
            <a href="https://www.nccc.com.tw/wps/wcm/connect/zh/home/BusinessOperations/CardBusiness/MicroPayment" target="_blank" class="nccc-btn">
              <i class="fa-solid fa-magnifying-glass me-1"></i> æŸ¥è©¢ NCCC å®˜æ–¹åå–®
            </a>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <div class="text-end lh-1" id="fx-info" style="display:none;"></div>
        </div>

        <div id="cards-container"></div>
      </div>
      
      <div class="disclaimer-text">
        <i class="fa-solid fa-triangle-exclamation text-danger me-1"></i> ä½¿ç”¨è€…æ‡‰è‡ªè¡Œç•™æ„æœ¬å·¥å…·æ›´æ–°æ—¥æœŸå¯èƒ½ä¸¦éæœ€æ–°å…¬å‘Šå¾Œçš„å…Œæ›ã€ç´¯ç©æ¯”ä¾‹ï¼Œå„˜ç®¡æˆ‘å€‘è£½ä½œæ­¤ç¶²ç«™åŠä½œå‡ºå‡è¨­æ™‚å·²åŠ›æ±‚å¯©æ…ï¼ŒæƒŸæ´»å‹•éç¨‹ä¸­æ¼”ç®—çµæœæ‡‰åªè¦–ä½œæŒ‡æ¨™ï¼Œè€Œéçµ•å°æº–ç¢ºè¨ˆç®—ã€‚è©³æƒ…è«‹åƒè€ƒéŠ€è¡Œæ‰€æä¾›ä¹‹æ´»å‹•èªªæ˜ã€‚<br><br>
        äºå•†å“ç››è¯é–£è‚¡ä»½æœ‰é™å…¬å¸ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼æ¯é›†åœ˜åŠæ——ä¸‹é—œè¯å­å…¬å¸ã€åˆ†å…¬å¸ï¼‰ã€ç¤¾åœ˜æ³•äººè‡ºç£å“©ç¨‹ç ”ç©¶ç¤¾ã€ã€Œç’°å“©åŒ¯ãƒ»å°Šè²´å¸¸æ—…å®¢ä¿±æ¨‚éƒ¨ã€ã€ã€Œç¤¾åœ˜æ³•äººç’°çƒå¸¸æ—…å®¢å”æœƒã€å‡ç„¡é ˆå°ä»»ä½•äººå°±ç”±æ–¼ä½¿ç”¨æˆ–ä¾è³´æºè‡ªæ­¤æ´»å‹•ç¶²ç«™çš„è³‡æ–™è€Œå¼•è‡´æˆ–èˆ‡æ­¤æœ‰é—œçš„ä»»ä½•æå¤±ã€æå®³æˆ–ä»»ä½•å½¢å¼çš„è²»ç”¨ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼ä»»ä½•ç¶“æ¿Ÿæå¤±æˆ–å…¶ä»–ç›´æ¥ã€é–“æ¥æˆ–ç›¸æ‡‰è€Œç”Ÿçš„æå®³ï¼‰æ‰¿æ“”è²¬ä»»ã€‚
      </div>

    </div>

    <!-- Page: Status, Warehouse, Guide -->
    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary"><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœŸç´¯ç© (å¾…çµç®—ç¸½å¸³)</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn btn-sm btn-outline-danger flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">é‡ç½®æœ¬æœŸ</button>
           <button onclick="batchImport()" class="btn btn-sm btn-action flex-grow-1 rounded-pill fw-bold py-1" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); border:none; color:white; box-shadow:2px 2px 0 #047857;">
             <i class="fa-solid fa-rocket me-1"></i> ä¸€éµé€²å€‰
           </button>
        </div>
        <div class="mt-2 text-center">
           <button onclick="exportData()" class="btn btn-sm btn-link text-primary fw-bold" style="text-decoration:none; font-size:0.85rem;">åŒ¯å‡º JSON</button>
        </div>
        <div class="mt-3 text-center">
             <button onclick="clearCustomRules()" class="btn btn-link btn-sm text-secondary" style="text-decoration:none; font-size:0.8rem;">
               <i class="fa-solid fa-rotate-left me-1"></i> é‡ç½®æ‰€æœ‰è‡ªè¨‚ä¿®æ­£
             </button>
        </div>
      </div>
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning" style="color:#b45309;"><i class="fa-solid fa-shield-halved me-2"></i>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
        <small class="text-muted d-block mt-2 text-center font-hand">å°æ–°å¡ç‚ºå¹´åº¦é¡åº¦ï¼Œå…¶ä»–å¡ç‰‡æœƒæ ¹æ“šçµå¸³æ—¥é‡ç½®</small>
      </div>
    </div>

    <div id="page-warehouse" class="page-section" style="display:none;">
        <div class="input-block-card">
            <div class="input-block-title text-primary"><i class="fa-solid fa-plane"></i> å­˜å…¥èˆªç©ºå“©ç¨‹ (åŸç”Ÿ)</div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">èˆªå¸åç¨±</label><input id="native-airline-name" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (å»ºè­°ç”¨ç°¡ç¨±)"></div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">ç›®å‰æŒæœ‰å“©ç¨‹</label><input id="native-current" type="number" class="form-control" placeholder="0"></div>
            <button onclick="addNativeAsset()" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold">å­˜å…¥èˆªç©ºå¸³æˆ¶</button>
        </div>
        <div class="input-block-card">
            <div class="input-block-title text-warning" style="color:#d97706;"><i class="fa-solid fa-right-left"></i> å­˜å…¥è½‰é»ç©åˆ† (é£¯åº—/éŠ€è¡Œ)</div>
            <div class="row g-2 mb-2">
                <div class="col-7"><label class="form-label small mb-1 fw-bold">ç©åˆ†ä¾†æº</label><input id="trans-source-name" class="form-control" placeholder="å¦‚: è¬è±ª, å°æ¨¹é»"></div>
                <div class="col-5"><label class="form-label small mb-1 fw-bold">æŒæœ‰ç©åˆ†</label><input id="trans-current" type="number" class="form-control" placeholder="0"></div>
            </div>
            <div class="mb-2"><label class="form-label small mb-1 fw-bold text-primary">æ¬²å…Œæ›ä¹‹ç›®æ¨™èˆªå¸ (æ­¸æˆ¶ä¾æ“š)</label><input id="trans-target-airline" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (è«‹ä¿æŒåç¨±ä¸€è‡´)"></div>
            <div class="bg-light p-2 rounded border mb-2">
                <label class="small text-muted fw-bold mb-1">å…Œæ›å…¬å¼ (ä¾‹å¦‚: 360é» = 1000å“©)</label>
                <div class="input-group input-group-sm mb-2"><span class="input-group-text">æ¯</span><input id="trans-unit-points" type="number" class="form-control" placeholder="360" min="0"><span class="input-group-text">é» = </span><input id="trans-unit-miles" type="number" class="form-control" placeholder="1000" min="0"><span class="input-group-text">å“©</span></div>
                <div><label class="small text-muted fw-bold">æ»¿é¡åŠ è´ˆ (é¸å¡«)</label><div class="input-group input-group-sm"><span class="input-group-text">æ¯</span><input id="trans-bonus-thres" type="number" class="form-control" placeholder="60000" min="0"><span class="input-group-text">é»è´ˆ</span><input id="trans-bonus-val" type="number" class="form-control" placeholder="5000" min="0"><span class="input-group-text">å“©</span></div></div>
            </div>
            <button onclick="addTransferAsset()" class="btn btn-sm btn-outline-warning w-100 rounded-pill fw-bold" style="color:#b45309; border-color:#d97706;">å­˜å…¥è½‰é»è³‡ç”¢</button>
        </div>
        <div id="warehouse-list"></div>
    </div>

    <!-- Guide Page (Updated) -->
    <div id="page-guide" class="page-section" style="display:none;">
        <div class="card-box">
            <h5 class="mb-4 text-primary"><i class="fa-solid fa-book-open me-2"></i>æ–°æ‰‹æŒ‡å— v12.24</h5>
            <div class="guide-step"><div class="step-num">1</div><div class="step-content"><h6>ç¸½å¸³æ¨¡å¼ (New)</h6><p>ç›£æ§é é¢ç¾åœ¨åªé¡¯ç¤ºå„å¡ç‰‡çš„ç´¯ç©ç¸½å’Œï¼Œç•«é¢æ›´æ¸…çˆ½ã€‚è‹¥éœ€ä¿®æ”¹å–®ç­†éŒ¯èª¤ï¼Œå»ºè­°ç›´æ¥è¼¸å…¥è² æ•¸é€²è¡Œæ²–å¸³ã€‚</p></div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-content"><h6>å¯¦é«”äº¤æ˜“åš´æ ¼åˆ¤å®š</h6><p>ç‚ºé¿å…èª¤åˆ¤ï¼Œå‡¡æ˜¯é€éã€Œå®˜ç¶²ã€æˆ–ã€Œè¨‚æˆ¿ç¶²ã€çš„äº¤æ˜“ï¼Œç³»çµ±æœƒå¼·åˆ¶è¦–ç‚ºã€Œç·šä¸Šäº¤æ˜“ã€ï¼Œå³ä¾¿æ‚¨èª¤é¸å¯¦é«”å¡ä¹Ÿä¸æœƒè§¸ç™¼å¯¦é«”åŠ ç¢¼ã€‚</p></div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-content"><h6>æ™ºæ…§ç«¶æ¥­æ’é™¤</h6><p>åœ¨è¯èˆªå®˜ç¶²è³¼ç¥¨æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•èª¿é™ä»–è¡Œå¡ç‰‡çš„å›é¥‹ç‡ï¼Œç¢ºä¿æ‚¨èƒ½çœ‹åˆ°æœ€æ­£ç¢ºçš„è¯èˆªè¯åå¡å„ªæƒ ã€‚</p></div></div>
            
            <div class="alert alert-light border mt-4">
              <h6 class="fw-bold text-primary"><i class="fa-solid fa-rocket me-2"></i>v12.24 ç‰ˆæœ¬æ›´æ–°æ—¥èªŒ (iOSå®Œç¾ç›¸å®¹ç‰ˆ)</h6>
              <ul class="mb-0 ps-3 small text-secondary" style="line-height: 1.6;">
                <li><strong>åš´æ ¼å¯¦é«”åˆ¤å®šï¼š</strong>ä¿®æ­£ã€Œåœ‹æ³°å®˜ç¶²/è¯èˆªå®˜ç¶²ã€å¤–å¹£äº¤æ˜“è¢«èª¤åˆ¤ç‚ºã€Œæµ·å¤–å¯¦é«”ã€çš„å•é¡Œã€‚</li>
                <li><strong>æ™ºæ…§ç«¶æ¥­æ’é™¤ï¼š</strong>å„ªåŒ–æ¨è–¦é‚è¼¯ï¼Œé¿å…éè¯åå¡åœ¨å®˜ç¶²è³¼ç¥¨æ™‚å‡ºç¾éŒ¯èª¤çš„é«˜å›é¥‹ã€‚</li>
                <li><strong>ç¸½å¸³æ¨¡å¼ï¼š</strong>è¨˜å¸³é é¢æ”¹ç‚ºå¡ç‰‡ç¸½è¦½ï¼Œæ ¸å°æ›´è¼•é¬†ã€‚</li>
                <li><strong>iOS æŒ‰éˆ•ä¿®å¾©ï¼š</strong>è§£æ±º iPhone ä¸Šé–‹é—œç„¡æ³•é»æ“Šçš„å•é¡Œã€‚</li>
              </ul>
            </div>
        </div>
    </div>
  </div>

  <div class="nav-bottom">
    <div class="nav-item active" onclick="switchPage('calc', this)"><i class="fa-solid fa-calculator"></i><br>è¨ˆç®—</div>
    <div class="nav-item" onclick="switchPage('status', this)"><i class="fa-solid fa-chart-simple"></i><br>ç›£æ§</div>
    <div class="nav-item" onclick="switchPage('warehouse', this)"><i class="fa-solid fa-warehouse"></i><br>å€‰åº«</div>
    <div class="nav-item" onclick="switchPage('guide', this)"><i class="fa-solid fa-book"></i><br>æ•™å­¸</div>
  </div>

  <!-- Modals -->
  <!-- Custom Alert Modal -->
  <div class="modal fade" id="customAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body text-center py-4 px-3">
          <i class="fa-solid fa-circle-exclamation text-warning mb-3" style="font-size: 3rem;"></i>
          <p class="mb-0 fw-bold text-secondary" id="alert-msg" style="font-size: 1.05rem; line-height: 1.5;"></p>
        </div>
        <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
          <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold font-hand" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Asset Edit Modal -->
  <div class="modal fade" id="editAssetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ”¹è³‡ç”¢é¤˜é¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <p class="small text-muted mb-2">æ­£åœ¨ä¿®æ”¹ï¼š<span id="edit-asset-name" class="fw-bold text-dark"></span></p>
            <input type="number" id="edit-asset-val" class="form-control text-center fw-bold fs-4 text-primary">
        </div>
        <div class="modal-footer border-0 pt-0 d-flex justify-content-center pb-4 gap-2">
            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold" onclick="saveAssetEdit()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">âš™ï¸ è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="setting-section"><div class="setting-title">åŠ ç¢¼è³‡æ ¼ç¢ºèª (è‡ªå‹•æ‰£ç¹³)</div><div class="switch-group mb-2"><span class="switch-label">åŒ¯è± Live+ è‡ªå‹•æ‰£ç¹³ <small class="text-muted fw-normal">(ç²¾é¸+1%)</small></span><input class="form-check-input" type="checkbox" id="setting-hsbc-autopay" onchange="updateGlobalSetting('hsbc_autopay', this.checked)"></div></div>
          <div class="setting-section"><div class="setting-title">å…§å»ºç¥å¡ (è¤‡é›œé‚è¼¯)</div><div id="builtin-cards-list"></div></div>
          <div class="setting-section"><div class="setting-title">è‡ªè¨‚å¡ç‰‡ (ç°¡æ˜“é‚è¼¯)</div><div id="custom-cards-list" class="mb-3"></div><div class="bg-white p-3 rounded-3 border border-2 border-primary-subtle" style="border-style:dashed;"><label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label><input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨±"><div class="row g-2"><div class="col-6"><input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§" min="0"></div><div class="col-6"><input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–" min="0"></div></div><button onclick="addCustomCard()" class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold font-hand">ç¢ºèªæ–°å¢</button></div></div>
          <div class="setting-section"><div class="setting-title">å¸³å–®çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</div><div id="billing-days-list"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="correctionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ­£å›é¥‹å€ç‡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted mb-3">ä¿®æ­£ <strong><span id="modal-card-name"></span></strong> åœ¨é—œéµå­— <strong>ã€Œ<span id="modal-keyword"></span>ã€</strong> çš„å›é¥‹ã€‚<br>ç³»çµ±å°‡æœƒè¨˜ä½æ­¤è¨­å®šï¼Œä¸‹æ¬¡è‡ªå‹•å¥—ç”¨ã€‚</p>
          <div class="mb-3"><label class="form-label">è«‹è¼¸å…¥æ­£ç¢ºçš„ã€Œå¹¾å…ƒä¸€å“©ã€</label><input type="number" id="modal-new-rate" class="form-control form-control-lg text-center fw-bold text-primary" placeholder="ä¾‹å¦‚: 18" min="0"><div class="form-text text-center font-hand">è¼¸å…¥ 0 ä»£è¡¨ç„¡å›é¥‹ (NCCC/æ’é™¤é …ç›®)</div></div>
          <button onclick="saveCorrection()" class="btn btn-primary w-100 rounded-pill fw-bold">å„²å­˜ä¸¦é‡æ–°è¨ˆç®—</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold" id="confirmModalTitle">âš ï¸ ç¢ºèªå‹•ä½œ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center py-4"><p class="mb-0 text-secondary fw-bold" id="confirm-msg" style="line-height:1.5;"></p></div>
        <div class="modal-footer border-0 pt-0 d-flex justify-content-center gap-3 pb-4"><button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" id="btn-confirm-yes">ç¢ºèª</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* =========================
       å“©ç¨‹æ”»ç•¥ v12.24 (iOSå®Œç¾ç›¸å®¹ç‰ˆ)
       ========================= */

    const DB_UPDATE_DATE = "2026/02/16"; 

    // Builtin Cards
    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true, note: 'é¤é£²è³¼ç‰©ç¥å¡' },
      { id: 'ctbc_ci_inf', name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨ç„¡é™å¡', default: false, note: 'æŒ‡å®š$10 / ç”Ÿæ—¥$6.6' },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true, note: 'è¶Šé£›æœ‰å“© $5/å“©' },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true, note: 'åœ‹å¤– $10/å“©' },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Šå¡', default: true, note: 'æµ·å¤–å¯¦é«” $6/å“©' }
    ];

    // Auto Assets Logic
    const AUTO_ASSETS = {
        'hsbc_live': { target: 'åŒ¯è± Live+ ç¾é‡‘ç©åˆ†', type: 'transfer', ratio: 2, unitPoints:1, unitMiles:2 },
        'hsbc_inf': { target: 'åŒ¯è± æ—…äººç©åˆ†', type: 'transfer', ratio: 1, unitPoints:1, unitMiles:1 },
        'ctbc_ci': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'ctbc_ci_inf': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'taishin_cx': { target: 'äºæ´²è¬é‡Œé€š/åœ‹æ³° (å“©ç¨‹)', type: 'airline', ratio: 1 }
    };

    const DEFAULT_BILLING = { hsbc:6, ctbc:15, taishin:20, other:1 };
    const RATES = { TWD:1, USD:33.5, JPY:0.225, EUR:36, CNY:4.6, KRW:0.025, THB:0.96, SGD:24.5, other: 1 };
    
    // Expanded Keywords & Blocklists
    const LIVE_KEYWORDS = {
        'dining': ['é¤å»³','åƒé£¯','å¤–é€','ubereats','foodpanda','ç‡’è‚‰','ç«é‹','éº»è¾£','å£½å¸','æ—¥å¼','å±…é…’å±‹','é¤é…’é¤¨','é…’å§','å’–å•¡','ç”œé»','ç‰›æ’','éµæ¿ç‡’','æ‹‰éºµ','èŒ¶å…­','å±‹é¦¬','ä¹¾æ¯','buffet','ç‹å“','äº«é´¨','å¤æ…•å°¼','è¥¿å ¤','çŸ³äºŒé‹','é™¶æ¿å±‹','é’èŠ±é©•','é¥—è³“','é¥—é¥—','é–‹é£¯','ç“¦åŸ','é¼æ³°è±','æµ·åº•æ’ˆ','é‡‘å¤§é‹¤','ç¯‰é–“','å£½å¸éƒ','è—å£½å¸','çˆ­é®®','å‰å…†','æ˜å£½å¸','é‡‘è‰²ä¸‰éº¥','æ˜¥å¤§ç›´','è²³æ¨“','æ¶“è±†è…','hooters','å‹ç”°','éº¥ç•¶å‹','æ˜Ÿå·´å…‹','å¿…å‹å®¢','é”ç¾æ¨‚','å¯Œç‹','æ–‡å…¬é¤¨','æ•™çˆ¶ç‰›æ’','å±±æµ·æ¨“','é¹½ä¹‹è¯','ç‰¡ä¸¹','logy','inita','ikea','è«å‡¡å½¼','è²´æ—ä¸–å®¶'],
        'shop': ['momo','pchome','è¦çš®','shopee','amazon','ebay','éœ²å¤©','friday','gomaji','æ·˜å¯¶','uniqlo','zara','h&m','net','gu','nike','adidas','outlet','å°åŒ—101','ä¸‰äº•','å¾®é¢¨','sogo','æ¼¢ç¥','è¯æ³°','æ–°å…‰','skm','att','ç¾éº—è¯','å—ç´¡','çµ±ä¸€æ™‚ä»£','é é›„','äº¬ç«™','citylink','å¤¢æ™‚ä»£','lalaport','é«˜å³¶å±‹','ä¸­å‹','é ä¼','éº—å¯¶','æ¯”æ¼¾','å¤§æ±Ÿ','å·¨åŸ','é æ±','global mall','ç’°çƒ','ç¾©å¤§','å°èŒ‚','å®åŒ¯','ç¾©äº«','noke','å¤§é­¯é–£','æ˜æ›œ','bellavita','å¯¶é›…','ç„¡å°è‰¯å“','muji','å±ˆè‡£æ°','åº·æ˜¯ç¾','æ¾æœ¬æ¸…','å”å‰è¨¶å¾·'],
        'entertainment': ['æ–°å…‰å½±åŸ','å¨ç§€','åœ‹è³“','ç§€æ³°','ç’°çƒå½±åŸ','è¿ªå£«å°¼','å‰åœåŠ›','æ¨‚å¤©ä¸–ç•Œ','legoland','safari','å…’ç«¥æ–°æ¨‚åœ’','x park','å°äººåœ‹','å…­ç¦æ‘','æµ·æ´‹å…¬åœ’','éº—å¯¶æ¨‚åœ’','åŠæ¹–å±±','ä¹æ—','å°šé †','ç¾©å¤§éŠæ¨‚','å·§è™','å‹•ç‰©åœ’','æµ·ç”Ÿé¤¨','å¥‡ç¾åšç‰©é¤¨','å°å®å™¹','é‡æŸ³','åŸ”å¿ƒ','é£›ç‰›','é ‘çš®ä¸–ç•Œ','ç¾è¡“é¤¨','æ—¥æœˆæ½­','å¤ªå¹³å±±','é˜¿é‡Œå±±','å¤§é›ªå±±','å¢¾ä¸','æ£®æ—éŠæ¨‚å€']
    };
    const CTBC_INF_TRAVEL_KEYWORDS = ['agoda','booking','trip','klook','hotels','expedia','airbnb'];
    const CTBC_BOOKING_KEYWORDS = ['agoda','booking','hotels.com','expedia','trip.com','airbnb'];
    const NCCC_FAST_FOOD = ['éº¥ç•¶å‹','è‚¯å¾·åŸº','æ¼¢å ¡ç‹','æ‘©æ–¯','é ‚å‘±å‘±','å¿…å‹å®¢','é”ç¾æ¨‚','æ‹¿å¡é‡Œ','subway'];
    const NCCC_BLACKLIST = ['å…«æ–¹é›²é›†','çˆ­é®®','è·¯æ˜“è','louisa','cama','50åµ','æ¸…å¿ƒ','è¿·å®¢å¤','å¯ä¸å¯','åœè»Š','å˜Ÿå˜Ÿæˆ¿','å°é¡'];
    const COMMON_BLOCK = ['ç®¡ç†è²»','ç¤¾å€','ç¨…','å­¸è²»','æ°´è²»','é›»è²»','ç“¦æ–¯','ç½°','è¦è²»','å¥ä¿','é›»ä¿¡','ä¸­è¯é›»ä¿¡','é å‚³','å°ç£å¤§','å„²å€¼','é å€Ÿ','åˆ†æœŸ'];
    const CTBC_BLOCK = [...COMMON_BLOCK, 'å…¨è¯','px','å…¨æ”¯ä»˜','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','etoro','wise','revolut', ...NCCC_BLACKLIST];
    const HSBC_BLOCK_BASE = [...COMMON_BLOCK, 'å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš', ...NCCC_BLACKLIST];
    const TAISHIN_BLOCK = [...COMMON_BLOCK, 'åˆ†æœŸ','å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åœ‹æ°‘å¹´é‡‘','etag','ä¸‰å•†ç¾é‚¦', ...NCCC_BLACKLIST];

    const CARD_RULES = {
        'ctbc_ci_inf': {
            name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨ç„¡é™å¡',
            calc: (ctx) => {
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' };
                
                // Strict Physical Check: Flights and Travel are always Online
                const isInherentlyOnline = ['flight_ci', 'flight_cx', 'flight_other', 'travel'].includes(ctx.cat);
                const isTruePhysical = !isInherentlyOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay');

                if (ctx.isBirthday && ctx.isForeign && isTruePhysical) {
                    return { miles: Math.trunc(ctx.twdBase/6.6), note: 'ğŸ‚ ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6.6/å“©' };
                }
                const isTravelBooking = CTBC_INF_TRAVEL_KEYWORDS.some(w => ctx.kwKey.includes(w));
                if (ctx.cat.startsWith('flight') || ctx.isForeign || isTravelBooking) {
                    return { miles: Math.trunc(ctx.twdBase/10), note: 'âœˆï¸ æŒ‡å®š/æµ·å¤– $10/å“©' };
                }
                return { miles: Math.trunc(ctx.twdBase/20), note: 'ä¸€èˆ¬æ¶ˆè²» $20/å“©' };
            }
        },
        'hsbc_live': {
            name: 'åŒ¯è± Live+',
            calc: (ctx) => {
                if (ctx.isEUR) return { miles:0, note: '<span class="text-danger fw-bold">ğŸš« æ­ç›Ÿå¯¦é«”ä¸å›é¥‹</span>' };
                if (HSBC_BLOCK_BASE.some(w => ctx.kwKey.includes(w))) return { miles:0, note: '<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' };
                let displayRate = '0.88%'; let displayType = 'ä¸€èˆ¬'; let warning = '';
                const hasAutopay = ctx.db.settings.hsbc_autopay;
                let totalPoints = ctx.twdBase * 0.0088; 
                const isAsian = ['JPY', 'KRW', 'SGD', 'THB', 'CNY'].includes(ctx.curr);
                
                if(ctx.isLiveSelect) { 
                    displayType = 'ç²¾é¸'; displayRate = '3.88%';
                    let bonus1 = ctx.twdBase * 0.03;
                    if(bonus1 > 888) { bonus1 = 888; warning = 'âš ï¸ é€šè·¯åŠ ç¢¼å·²é”ä¸Šé™'; }
                    totalPoints += bonus1;
                    
                    let bonus2Rate = 0;
                    if(isAsian) { bonus2Rate = 0.01; displayType = 'äºæ´²ç²¾é¸'; displayRate = '4.88%'; } 
                    else if(hasAutopay) { bonus2Rate = 0.01; displayRate = '4.88%'; } 
                    
                    if(isAsian && hasAutopay) displayRate = '5.88%'; 
                    if(bonus2Rate > 0) {
                        let bonus2 = ctx.twdBase * 0.01;
                        if(bonus2 > 200) { bonus2 = 200; warning = warning ? 'âš ï¸ é›™é‡åŠ ç¢¼å·²é”ä¸Šé™' : 'âš ï¸ ä»»å‹™åŠ ç¢¼å·²é”ä¸Šé™'; }
                        totalPoints += bonus2;
                    }
                } else { if(hasAutopay) displayRate = '1.88%'; }
                
                let n = `${displayType} ${displayRate} <br><span class="text-muted small">1é»ç¾é‡‘ç©é»â‡„2å“©</span>`;
                if(warning) n = `${displayType} (æ··åˆè²»ç‡)<br><span class="warning-badge">${warning}</span>`;
                return { miles: Math.trunc(totalPoints) * 2, note: n };
            }
        },
        'taishin_cx': {
            name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',
            calc: (ctx) => {
                let isFlyQualifying = false;
                if (TAISHIN_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›® (ç¨…/è²»)</span>', isFlyQualifying };
                let div = ctx.isForeign ? 15 : 22; let n = `ç´„${div}å…ƒ/å“©`;
                const isMobilePay = (ctx.pay === 'apple_pay' || ctx.pay === 'line_pay');
                
                if(ctx.cat === 'flight_cx') { 
                    if (isMobilePay) { div = 22; n = 'âš ï¸ APP+Payç„¡$5 (æ¢æ¬¾æ’é™¤ï¼Œåƒ…ä¸€èˆ¬å›é¥‹)'; } 
                    else if (ctx.isForeign) { div = 15; n = 'âš ï¸ éå°å¹£ä»˜æ¬¾ (ä¾æ¢æ¬¾è¦–ç‚ºæµ·å¤–$15)'; } 
                    else { div = 5; isFlyQualifying = true; n = 'è¶Šé£›(å®˜ç¶²) $5/å“©<br><span class="text-muted small">(ä¾æ¢æ¬¾æ”¶å–æµ·å¤–æ‰‹çºŒè²»)</span>'; }
                } else if(ctx.isFlyMode && ctx.cat !== 'flight_ci') { 
                    if(!isMobilePay && ['agoda','booking','klook','kkday','expedia','hotels','æ˜‡æ†æ˜Œ','é‡‡ç›Ÿ'].some(w=>ctx.kwKey.includes(w))) { 
                        div = 5; isFlyQualifying = true; n = `è¶Šé£›(æŒ‡å®šæ—…éŠ) $5/å“©`; 
                    } else if(!isMobilePay && ctx.isForeign && ctx.pay === 'physical') { 
                        div = 5; isFlyQualifying = true; n = `è¶Šé£›(æµ·å¤–å¯¦é«”) $5/å“©`; 
                    }
                } 
                if (ctx.isFlyMode && isMobilePay && ctx.cat !== 'flight_cx') n += ` <span class="text-danger small">(Payç„¡$5)</span>`;
                return { miles: Math.trunc(ctx.twdBase/div), note: n, isFlyQualifying };
            }
        },
        'hsbc_inf': {
            name: 'åŒ¯è± æ—…äººç„¡é™',
            calc: (ctx) => {
                if (HSBC_BLOCK_BASE.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' };
                let div = ctx.cat.startsWith('flight') ? 10 : (ctx.isForeign ? 10 : 18);
                return { miles: Math.trunc(ctx.twdBase/div), note: `ç´„${div}å…ƒ/å“© (1ç©åˆ†=1å“©)` };
            }
        },
        'ctbc_ci': {
            name: 'ä¸­ä¿¡ è¯èˆªé¼å°Šå¡',
            calc: (ctx) => {
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' };
                
                // Strict Physical Check: Flights and Travel are always Online
                const isInherentlyOnline = ['flight_ci', 'flight_cx', 'flight_other', 'travel'].includes(ctx.cat);
                const isTruePhysical = !isInherentlyOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay');
                
                let div = 18; let n = 'ä¸€èˆ¬ $18/å“©';
                const isCtbcBooking = CTBC_BOOKING_KEYWORDS.some(w => ctx.kwKey.includes(w));
                
                if (ctx.cat === 'flight_ci') { div = 9; n = 'è¯èˆªå®˜ç¶² $9/å“©'; } 
                else if (isCtbcBooking) { div = 9; n = 'æŒ‡å®šè¨‚æˆ¿ç¶² $9/å“©'; }
                else if(ctx.isForeign) {
                    // Logic Fix: Only give birthday bonus if it's strictly a physical transaction
                    if(isTruePhysical) {
                        if(ctx.isBirthday) { div = 6; n = `ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6/å“©`; } 
                        else { div = 9; n = `æµ·å¤–å¯¦é«” $9/å“©`; }
                    } else {
                        // Online or other (even if user selected 'Physical' but cat is flight)
                        div = 18; n = 'æµ·å¤–ç¶²è³¼ $18/å“©';
                    }
                }
                else if(ctx.isForeign && ctx.pay === 'online') { div = 18; n = 'æµ·å¤–ç¶²è³¼ $18/å“©'; }
                
                if(div === 9 || div === 6) n += ` <br><span class="text-danger small" style="font-size:0.7em;">(å«åŠ ç¢¼ä¸Šé™)</span>`;
                return { miles: Math.trunc(ctx.twdBase/div), note: n };
            }
        }
    };

    function showAlert(msg) {
        document.getElementById('alert-msg').innerHTML = msg.replace(/\n/g, '<br>');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('customAlertModal'));
        m.show();
    }

    let pendingDeleteAction = null; 
    function showConfirm(msg, callback, btnText='ç¢ºèª', title='âš ï¸ ç¢ºèªå‹•ä½œ') {
        document.getElementById('confirmModalTitle').innerText = title;
        document.getElementById('confirm-msg').innerHTML = msg.replace(/\n/g, '<br>');
        document.getElementById('btn-confirm-yes').innerText = btnText;
        document.getElementById('btn-confirm-yes').className = `btn rounded-pill px-4 fw-bold ${btnText.includes('ç¢ºèª')?'btn-primary':'btn-danger'}`;
        pendingDeleteAction = callback;
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal'));
        m.show();
    }
    document.getElementById('btn-confirm-yes').addEventListener('click', function() { 
        if(pendingDeleteAction) pendingDeleteAction(); 
        bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal')).hide(); 
    });

    const DB_KEY = 'MILES_APP_V12_6_DATA'; 
    const RULES_KEY = 'MILES_APP_RULES';
    let correctionTarget = { id: null, name: null };
    let editAssetTargetIdx = null;
    let editRecordTargetId = null; 
    let currentEditRate = 0; 

    function toggleSign(id) {
        const el = document.getElementById(id);
        let val = parseFloat(el.value);
        if(isNaN(val)) val = 0;
        el.value = val * -1;
        checkInputStyle(el);
        if(id === 'edit-rec-spend') autoCalcPoints(el.value);
    }
    
    function toggleSwitch(id) {
        const checkbox = document.getElementById(id);
        checkbox.checked = !checkbox.checked;
    }

    function checkInputStyle(el) {
        const val = parseFloat(el.value);
        const statusId = el.id + '-status';
        const statusEl = document.getElementById(statusId);
        if(val < 0) {
            el.classList.add('input-negative');
            if(statusEl) statusEl.style.display = 'block';
        } else {
            el.classList.remove('input-negative');
            if(statusEl) statusEl.style.display = 'none';
        }
    }

    function cleanUpOldRecords(db) {
        if (!db.records) return false;
        const now = new Date();
        let isModified = false;
        for (let key in db.records) {
            const [yearStr, monthStr] = key.split('-');
            if (yearStr && monthStr) {
                const diffMonths = (now.getFullYear() - parseInt(yearStr)) * 12 + (now.getMonth() + 1 - parseInt(monthStr));
                if (diffMonths > 12) { delete db.records[key]; isModified = true; }
            }
        }
        return isModified;
    }

    function checkAndCreateAutoAssets(db) {
        let created = false;
        db.settings.enabledBuiltins.forEach(cardId => {
            const rule = AUTO_ASSETS[cardId];
            if(rule) {
                const exists = db.warehouse.some(a => a.targetAirline === rule.target);
                if(!exists) {
                    db.warehouse.push({ type: rule.type, targetAirline: rule.target, name: rule.target + (rule.type==='transfer'?'':' (è‡ªå‹•å»ºç«‹)'), current: 0, ratio: rule.ratio, unitPoints: rule.unitPoints||1, unitMiles: rule.unitMiles||1, bonusThres: 0, bonusVal: 0 });
                    created = true;
                }
            }
        });
        return created;
    }

    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if(!raw) return initDB();
      const db = JSON.parse(raw);
      if(typeof db.settings.hsbc_autopay === 'undefined') db.settings.hsbc_autopay = true;
      if(!db.warehouse) db.warehouse = [];
      if(!db.airlineGoals) db.airlineGoals = {};
      let modified = false;
      if(cleanUpOldRecords(db)) modified = true;
      if(checkAndCreateAutoAssets(db)) modified = true;
      if(modified) saveDB(db);
      return db;
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function initDB() { 
        let db = { settings: { enabledBuiltins: BUILTIN_DEFS.filter(c => c.default).map(c => c.id), billingDays: { ...DEFAULT_BILLING }, hsbc_autopay: true }, customCards: [], records: {}, limits: {}, warehouse: [], airlineGoals: {} };
        checkAndCreateAutoAssets(db);
        return db;
    }
    function loadRules() { const raw = localStorage.getItem(RULES_KEY); return raw ? JSON.parse(raw) : {}; }
    function saveRules(data) { localStorage.setItem(RULES_KEY, JSON.stringify(data)); }

    function checkCurrency(val) {
      const label = document.getElementById('amount-label'); const input = document.getElementById('amount'); const fxGroup = document.getElementById('fx-input-group'); const fxRateInput = document.getElementById('fx-rate-input');
      if (val === 'TWD') { label.innerText = 'æ¶ˆè²»é‡‘é¡ (TWD)'; input.placeholder = '0'; fxGroup.style.display = 'none'; } 
      else { label.innerText = `æ¶ˆè²»é‡‘é¡ (${val})`; input.placeholder = 'å¤–å¹£é‡‘é¡'; fxGroup.style.display = 'block'; if(RATES[val]) fxRateInput.value = RATES[val]; }
    }

    function calculate() {
      try {
          const db = loadDB(); const rules = loadRules();
          const amt = parseFloat(document.getElementById('amount').value);
          
          if(isNaN(amt) || amt === 0) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ (å¯ç‚ºè² æ•¸é€²è¡Œæ‰£æ¬¾)ï¼');
          
          const target = document.getElementById('redemption-target').value;

          const ctx = {
              db: db, curr: document.getElementById('currency').value, cat: document.getElementById('category').value, pay: document.getElementById('payment').value,
              kwKey: (document.getElementById('keyword-input').value || '').trim().toLowerCase(),
              isBirthday: document.getElementById('birthdayMode').checked, 
              isFlyMode: document.getElementById('flyMode').checked,
              isForeign: document.getElementById('currency').value !== 'TWD', 
              isEUR: document.getElementById('currency').value === 'EUR',
              twdBase: 0, twdSpend: 0, isLiveSelect: false
          };

          if (ctx.isForeign) {
              const fxInput = document.getElementById('fx-rate-input');
              // Safety check: ensure element exists and has value
              if(!fxInput || !fxInput.value) return showAlert('è«‹è¼¸å…¥åŒ¯ç‡ï¼');
              const userRate = parseFloat(fxInput.value);
              if(isNaN(userRate) || userRate <= 0) return showAlert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æœ‰æ•ˆåŒ¯ç‡ï¼');
              ctx.twdBase = Math.round(amt * userRate); ctx.twdSpend = Math.round(ctx.twdBase * 1.015);
          } else { ctx.twdBase = Math.round(amt); ctx.twdSpend = ctx.twdBase; }

          if(ctx.cat === 'dining') ctx.isLiveSelect = true;
          else if(LIVE_KEYWORDS['dining'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['shop'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['entertainment'].some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;
          if(NCCC_FAST_FOOD.some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;

          let tags = [];
          if(ctx.isForeign) tags.push('åœ‹å¤–'); if(ctx.pay === 'line_pay') tags.push('LinePay');
          
          const fxInfo = document.getElementById('fx-info');
          fxInfo.style.display = 'block'; 
          fxInfo.innerHTML = `<div class="small text-muted">æœ¬é‡‘ NT$${ctx.twdBase.toLocaleString()}</div><div class="fw-bold text-dark">æˆæœ¬ NT$${ctx.twdSpend.toLocaleString()}</div>`;
          
          document.getElementById('scenario-tag').innerText = tags.length ? tags.join(' + ') : 'ä¸€èˆ¬æ¶ˆè²»';

          let results = [];
          function resolveMiles(cardId, defaultCalcFn) {
             const ruleKey = `${ctx.kwKey}|${cardId}`;
             if(ctx.kwKey && rules[ruleKey] !== undefined) {
                 const customDiv = rules[ruleKey];
                 if(customDiv === 0) return { miles: 0, note: 'ğŸš« è‡ªè¨‚: ç„¡å›é¥‹', isCustom: true };
                 return { miles: Math.trunc(ctx.twdBase / customDiv), note: `âš™ï¸ è‡ªè¨‚: ${customDiv}å…ƒ/å“©`, isCustom: true };
             }
             return defaultCalcFn();
          }

          db.settings.enabledBuiltins.forEach(cardId => {
              if (target !== 'ALL') {
                  if(target === 'CI' && cardId === 'taishin_cx') return; 
                  if(target === 'AM_BR' && (cardId === 'ctbc_ci' || cardId === 'ctbc_ci_inf')) return; 
              }
              if(CARD_RULES[cardId]) { results.push({ id: cardId, name: CARD_RULES[cardId].name, ...resolveMiles(cardId, () => CARD_RULES[cardId].calc(ctx)) }); }
          });
          db.customCards.forEach(c => {
             results.push({ id: c.id, name: c.name, ...resolveMiles(c.id, () => { let div = ctx.isForeign ? c.forRate : c.domRate; if(!div || div <= 0) div = 999; return { miles: Math.trunc(ctx.twdBase / div), note: `è¨­å®š${div}å…ƒ/å“©` }; }), type: 'custom' });
          });

          results.forEach(r => { r.tpm = r.miles > 0 ? (ctx.twdSpend / r.miles) : 999; });
          
          if (amt < 0) {
              results.sort((a,b) => a.miles - b.miles);
          } else {
              results.sort((a,b) => b.miles - a.miles);
          }
          
          window.currentResults = results.map(r => ({ ...r, twdSpend: ctx.twdSpend, twdBase: ctx.twdBase, isFlyQualifying: r.isFlyQualifying }));
          renderResults(results, ctx.twdSpend);
      } catch (e) {
          console.error(e);
          showAlert('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤ä»£ç¢¼: ' + e.message);
      }
    }

    function renderResults(list, spend) {
      const con = document.getElementById('cards-container'); 
      con.innerHTML = ''; 
      document.getElementById('result-area').style.display = 'block';
      
      if(list.length === 0) { con.innerHTML = '<div class="text-center p-3 text-muted">æ²’æœ‰ç¬¦åˆç›®æ¨™çš„å¡ç‰‡</div>'; return; }
      
      list.forEach((c, idx) => {
        const isWinner = idx === 0; 
        const div = document.createElement('div'); 
        div.className = `plan-card ${isWinner ? 'plan-winner' : ''}`;
        let badge = isWinner ? `<span class="winner-badge"><i class="fa-solid fa-crown"></i> WINNER</span>` : '';
        let customTag = c.isCustom ? '<span class="custom-rule-tag">è‡ªè¨‚è¦å‰‡</span>' : '';
        let recordBtnClass = isWinner ? 'btn-record-win' : 'btn-record'; 
        let recordBtnIcon = isWinner ? 'ğŸ†' : 'ğŸ“';
        
        div.innerHTML = `
        ${badge}
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="d-flex align-items-center mb-1"><h4 class="card-name mb-0">${c.name}</h4>${customTag}</div>
                <div class="text-muted small font-hand">${c.note}</div>
                <div class="card-actions">
                    <button class="btn-card-action ${recordBtnClass}" onclick="confirmRecord(${idx})">${recordBtnIcon} è¨˜å¸³</button>
                    <button class="btn-correct" onclick="openCorrection('${c.id}','${c.name}')"><i class="fa-solid fa-pen"></i> ä¿®æ­£</button>
                </div>
            </div>
            <div class="text-end">
                <div class="card-miles">${c.miles.toLocaleString()} <small style="font-size:0.5em; color:#64748b;">å“©</small></div>
                <div class="card-tpm">${Math.abs(c.tpm) < 200 ? Math.abs(c.tpm).toFixed(1) : '>200'} å…ƒ/å“©</div>
            </div>
        </div>`;
        con.appendChild(div);
      });
    }

    function getLimitKeyHelper(db, id, dateObj) {
        if(id === 'taishin_cx') { return `${dateObj.getFullYear()}-${id}`; } 
        else {
            let day = db.settings.billingDays[id.split('_')[0]] || db.settings.billingDays['other'] || 1;
            const monthOffset = (dateObj.getDate() > day) ? 1 : 0;
            const d = new Date(dateObj.getFullYear(), dateObj.getMonth() + monthOffset, 1);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${id}`;
        }
    }

    function confirmRecord(resultIdx) {
      const resultData = window.currentResults[resultIdx]; if(!resultData) return;
      const { id, name, miles, twdSpend, twdBase, isFlyQualifying } = resultData;
      let pointsToSave = miles; let unitText = 'å“©';
      if(id === 'hsbc_live') { pointsToSave = Math.trunc(miles / 2); unitText = 'ç©åˆ†'; } else if (id === 'hsbc_inf') { unitText = 'ç©åˆ†'; }

      showConfirm(`ç¢ºå®šè¨˜å¸³ï¼Ÿ\nå¡ç‰‡ï¼š${name}\nç´¯ç©ï¼š${pointsToSave} ${unitText} (æœªå…¥åº«)\næˆæœ¬ï¼š$${twdSpend}`, () => {
          const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
          if(!db.records[monthKey]) db.records[monthKey] = {};
          const recordId = `${id}_${Date.now()}`;
          db.records[monthKey][recordId] = { id: id, miles: pointsToSave, spend: twdBase, name: name, unit: unitText }; 

          const limitKey = getLimitKeyHelper(db, id, now);
          if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0 };
          let shouldAddSpend = true;
          if(id === 'taishin_cx' && !isFlyQualifying) shouldAddSpend = false;
          if(shouldAddSpend) db.limits[limitKey].spend += twdBase; 
          db.limits[limitKey].points += pointsToSave;
          saveDB(db); updateStatusUI(); 
      }, 'ç¢ºèªè¨˜å¸³', 'ğŸ“ ç¢ºèªè¨˜å¸³');
    }

    function batchImport() {
        const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        if(!db.records[monthKey] || Object.keys(db.records[monthKey]).length === 0) { return showAlert('ç›®å‰æ²’æœ‰å¾…çµç®—çš„ç´€éŒ„ï¼'); }
        let importCount = 0; let totalPoints = 0;
        showConfirm('ç¢ºå®šè¦åŸ·è¡Œã€Œä¸€éµé€²å€‰ã€å—ï¼Ÿ\nç³»çµ±å°‡è‡ªå‹•æ­¸æˆ¶ä¸¦æ¸…ç©ºå¾…çµç®—æ¸…å–®ã€‚', () => {
            for(let key in db.records[monthKey]) {
                const rec = db.records[monthKey][key];
                const autoRule = AUTO_ASSETS[rec.id];
                if(autoRule) {
                    let targetAsset = db.warehouse.find(a => a.targetAirline === autoRule.target);
                    if(targetAsset) { 
                        targetAsset.current = parseFloat(targetAsset.current) + rec.miles; 
                        importCount++; 
                        totalPoints += rec.miles; 
                    }
                }
            }
            db.records[monthKey] = {}; saveDB(db); updateStatusUI(); renderWarehouse(); showAlert(`âœ… çµç®—å®Œæˆï¼\nå…± ${importCount} ç­†ç´€éŒ„å·²å­˜å…¥å€‰åº«ã€‚`);
        }, 'ä¸€éµé€²å€‰', 'ğŸš€ ç¢ºèªé€²å€‰');
    }

    function clearCurrentStats() { 
        showConfirm('ç¢ºå®šè¦é‡ç½®æœ¬æœŸæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\n(é€™æœƒå°‡æœ¬æœˆç›¸é—œçš„é¡åº¦å…¨éƒ¨é€€é‚„)', () => { 
            const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            if(db.records[monthKey]) {
                for(let id in db.records[monthKey]) {
                    const rec = db.records[monthKey][id];
                    const limitKey = getLimitKeyHelper(db, rec.id, now);
                    if(db.limits[limitKey]) { 
                        db.limits[limitKey].spend -= rec.spend; 
                        db.limits[limitKey].points -= rec.miles; 
                        if(db.limits[limitKey].spend < 0) db.limits[limitKey].spend = 0; 
                    }
                }
                db.records[monthKey] = {}; saveDB(db); updateStatusUI(); 
            }
        }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªé‡ç½®'); 
    }

    function switchPage(p, btn) {
        document.querySelectorAll('.page-section').forEach(e => e.style.display='none'); 
        document.getElementById(`page-${p}`).style.display='block'; 
        
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 
        if(btn) btn.classList.add('active'); 
        
        if(p==='status') updateStatusUI(); 
        if(p==='warehouse') renderWarehouse(); 
        window.scrollTo(0,0); 
    }

    function resetOneLimit(limitKey) { showConfirm('ç¢ºå®šè¦å°‡æ­¤å¡ç‰‡çš„ç´¯ç©é¡åº¦æ­¸é›¶å—ï¼Ÿ\n(ä¸æœƒåˆªé™¤æ­·å²è¨˜å¸³æ˜ç´°)', () => { const db = loadDB(); if(db.limits[limitKey]) { db.limits[limitKey].spend = 0; db.limits[limitKey].points = 0; saveDB(db); updateStatusUI(); } }, 'æ­¸é›¶', 'ğŸ”„ ç¢ºèªæ­¸é›¶'); }

    // Summary Dashboard Mode
    function updateStatusUI() {
      const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const statusCon = document.getElementById('status-container'); 
      const monthData = db.records[monthKey] || {};
      
      // Aggregation Logic
      const agg = {};
      for(let key in monthData) {
          const r = monthData[key];
          if(!agg[r.id]) { agg[r.id] = { name: r.name, spend: 0, miles: 0, unit: r.unit }; }
          agg[r.id].spend += r.spend;
          agg[r.id].miles += r.miles;
      }

      let html = '';
      if(Object.keys(agg).length === 0) html = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´€éŒ„ (å¾…çµç®—)</div>';
      else {
        html = '<div>';
        for(let id in agg) {
            const item = agg[id];
            const isSpendNeg = item.spend < 0;
            html += `
            <div class="summary-card">
                <div>
                    <div class="summary-name">${item.name}</div>
                    <div class="summary-spend ${isSpendNeg?'text-danger':''}">$${item.spend.toLocaleString()}</div>
                </div>
                <div class="text-end">
                    <div class="summary-miles">${item.miles.toLocaleString()} <small class="text-secondary" style="font-size:0.6em">${item.unit}</small></div>
                </div>
            </div>`;
        }
        html += '</div>';
      }
      statusCon.innerHTML = html;

      // Limit Bar Logic
      const limitsCon = document.getElementById('limits-container'); 
      let limitHtml = '';
      let allCards = [];
      db.settings.enabledBuiltins.forEach(id => { const def = BUILTIN_DEFS.find(d => d.id === id); if(def) allCards.push({ id: def.id, name: def.name, limit: getCardLimit(def.id) }); });
      db.customCards.forEach(c => { allCards.push({ id: c.id, name: c.name, limit: 999999 }); });

      if (allCards.length === 0) limitHtml = '<div class="text-center text-muted small py-2">ç„¡ç›£æ§ä¸­çš„å¡ç‰‡ï¼Œè«‹è‡³è¨­å®šé–‹å•Ÿ</div>';
      else {
          allCards.forEach(card => {
              const limitKey = getLimitKeyHelper(db, card.id, now);
              const record = db.limits[limitKey] || { spend:0 };
              const current = record.spend;
              let limitDisplay = card.limit === 999999 ? 'âˆ' : `$${card.limit.toLocaleString()}`;
              let pct = card.limit === 999999 ? 0 : Math.min(100, Math.round((current / card.limit) * 100));
              let color = pct > 80 ? (pct>=100?'bg-danger':'bg-warning') : 'bg-success';
              limitHtml += `<div class="mb-3"><div class="d-flex justify-content-between small mb-1 align-items-center"><div><strong>${card.name}</strong></div><div class="d-flex align-items-center"><span class="me-2">$${current.toLocaleString()} / ${limitDisplay}</span><button class="btn-reset-limit" onclick="resetOneLimit('${limitKey}')"><i class="fa-solid fa-rotate-right"></i></button></div></div><div class="progress" style="height: 8px; border-radius:4px; background:#e2e8f0;"><div class="progress-bar ${color}" style="width: ${pct}%;"></div></div></div>`;
          });
      }
      limitsCon.innerHTML = limitHtml;
    }

    function getCardLimit(id) { if(id === 'hsbc_live') return 29600; if(id === 'ctbc_ci_inf') return 600000; if(id === 'taishin_cx') return 1000000; if(id === 'ctbc_ci') return 1440000; return 999999; }

    function openSettings() { renderSettings(); const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('settingsModal')); m.show(); }
    function renderSettings() {
      const db = loadDB(); document.getElementById('setting-hsbc-autopay').checked = db.settings.hsbc_autopay;
      const builtinCon = document.getElementById('builtin-cards-list'); builtinCon.innerHTML = ''; BUILTIN_DEFS.forEach(def => { const isOn = db.settings.enabledBuiltins.includes(def.id); builtinCon.innerHTML += `<div class="switch-group mb-2"><span class="switch-label">${def.name} <small class="text-muted">(${def.note})</small></span><input class="form-check-input" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')"></div>`; });
      const customCon = document.getElementById('custom-cards-list'); customCon.innerHTML = ''; if(db.customCards.length === 0) customCon.innerHTML = '<div class="text-muted small text-center mb-2">å°šç„¡è‡ªè¨‚å¡ç‰‡</div>'; db.customCards.forEach((c, idx) => { customCon.innerHTML += `<div class="custom-card-item"><div><div class="fw-bold">${c.name}</div><div class="small text-muted">åœ‹å…§ ${c.domRate} / åœ‹å¤– ${c.forRate}</div></div><div class="delete-btn" onclick="delCustomCard(${idx})"><i class="fa-solid fa-trash"></i></div></div>`; });
      const billCon = document.getElementById('billing-days-list'); billCon.innerHTML = ''; const banks = { hsbc:'åŒ¯è±', ctbc:'ä¸­ä¿¡', taishin:'å°æ–°', other:'å…¶ä»–' }; for(let key in banks) { billCon.innerHTML += `<div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded border"><span class="fw-bold text-secondary font-hand">${banks[key]}</span><input type="number" class="form-control form-control-sm w-25 text-center" value="${db.settings.billingDays[key]||1}" min="1" max="31" onchange="updateBilling('${key}', this.value)"></div>`; }
    }
    function updateGlobalSetting(key, val) { const db = loadDB(); db.settings[key] = val; saveDB(db); }
    function toggleBuiltin(id) { const db = loadDB(); const idx = db.settings.enabledBuiltins.indexOf(id); if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1); else db.settings.enabledBuiltins.push(id); saveDB(db); updateStatusUI(); }
    function addCustomCard() { const name = document.getElementById('new-card-name').value; const dom = parseFloat(document.getElementById('new-card-dom').value); const fore = parseFloat(document.getElementById('new-card-for').value); if(!name || isNaN(dom) || isNaN(fore)) return showAlert('è«‹å¡«å¯«å®Œæ•´'); if(dom <= 0 || fore <= 0) return showAlert('è²»ç‡ä¸å¯ç‚ºé›¶æˆ–è² æ•¸'); const db = loadDB(); db.customCards.push({ id: `cust_${Date.now()}`, name, domRate: dom, forRate: fore }); saveDB(db); renderSettings(); document.getElementById('new-card-name').value = ''; document.getElementById('new-card-dom').value = ''; document.getElementById('new-card-for').value = ''; }
    function delCustomCard(idx) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µè‡ªè¨‚å¡ç‰‡å—ï¼Ÿ', () => { const db = loadDB(); db.customCards.splice(idx, 1); saveDB(db); renderSettings(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    function updateBilling(key, val) { const v=parseInt(val); if(v<1 || v>31) return showAlert('çµå¸³æ—¥éœ€ä»‹æ–¼1~31ä¹‹é–“'); const db = loadDB(); db.settings.billingDays[key] = v || 1; saveDB(db); updateStatusUI(); }
    function $(id) { return document.getElementById(id); }

    // Warehouse Logic
    function renderWarehouse() {
        const db = loadDB(); const list = document.getElementById('warehouse-list'); list.innerHTML = '';
        if(db.warehouse.length === 0) { list.innerHTML = '<div class="text-muted text-center py-4">å€‰åº«æ˜¯ç©ºçš„</div>'; return; }
        
        // Group by Airline
        const groups = {};
        db.warehouse.forEach((asset, idx) => {
            const key = asset.targetAirline;
            if(!groups[key]) groups[key] = { total: 0, items: [] };
            
            // Calculate equivalent miles
            let equiv = 0;
            if(asset.type === 'airline') { equiv = asset.current; } 
            else { 
               // Simple estimation for display
               const ratio = (asset.unitMiles / asset.unitPoints);
               equiv = Math.floor(asset.current * ratio);
            }
            groups[key].total += equiv;
            groups[key].items.push({ ...asset, idx });
        });

        for(let key in groups) {
            const g = groups[key];
            let itemsHtml = '';
            g.items.forEach(item => {
                itemsHtml += `
                <div class="asset-item">
                    <div class="asset-info">
                        <div class="asset-name">${item.name}</div>
                        <div class="asset-detail text-muted">æŒæœ‰: ${item.current.toLocaleString()} / ä¼°å€¼: ${Math.floor(item.current * (item.unitMiles/item.unitPoints)).toLocaleString()} å“©</div>
                    </div>
                    <div>
                        <i class="fa-solid fa-pen btn-asset-edit me-2" onclick="openEditAsset(${item.idx})"></i>
                        <i class="fa-solid fa-trash-can btn-asset-del" onclick="delAsset(${item.idx})"></i>
                    </div>
                </div>`;
            });

            const div = document.createElement('div'); div.className = 'airline-group-card';
            div.innerHTML = `
            <div class="airline-header"><div class="airline-title"><i class="fa-solid fa-plane-up me-2"></i>${key}</div><div class="airline-total">${g.total.toLocaleString()} <small style="font-size:0.5em;">å“©(ä¼°)</small></div></div>
            <div class="airline-body">${itemsHtml}</div>`;
            list.appendChild(div);
        }
    }
    
    function addNativeAsset() {
        const name = $('native-airline-name').value; const val = parseFloat($('native-current').value);
        if(!name || isNaN(val)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'airline', targetAirline: name, name: name, current: val, unitPoints:1, unitMiles:1 });
        saveDB(db); renderWarehouse(); $('native-airline-name').value=''; $('native-current').value='';
    }
    
    function addTransferAsset() {
        const src = $('trans-source-name').value; const val = parseFloat($('trans-current').value); const target = $('trans-target-airline').value;
        const uP = parseFloat($('trans-unit-points').value); const uM = parseFloat($('trans-unit-miles').value);
        if(!src || !target || isNaN(val) || isNaN(uP) || isNaN(uM)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'transfer', targetAirline: target, name: src, current: val, unitPoints: uP, unitMiles: uM });
        saveDB(db); renderWarehouse(); $('trans-source-name').value=''; $('trans-current').value='';
    }

    function delAsset(idx) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™é …è³‡ç”¢å—ï¼Ÿ', () => { const db = loadDB(); db.warehouse.splice(idx, 1); saveDB(db); renderWarehouse(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    
    function openEditAsset(idx) { editAssetTargetIdx = idx; const db = loadDB(); const asset = db.warehouse[idx]; document.getElementById('edit-asset-name').innerText = asset.name; document.getElementById('edit-asset-val').value = asset.current; const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('editAssetModal')); m.show(); }
    
    function saveAssetEdit() { const val = parseFloat(document.getElementById('edit-asset-val').value); if(isNaN(val)) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼'); const db = loadDB(); db.warehouse[editAssetTargetIdx].current = val; saveDB(db); renderWarehouse(); bootstrap.Modal.getOrCreateInstance(document.getElementById('editAssetModal')).hide(); }

    function openCorrection(id, name) { correctionTarget = { id, name }; const k = document.getElementById('keyword-input').value; if(!k) return showAlert('è«‹å…ˆåœ¨ä¸»ç•«é¢è¼¸å…¥ã€Œé—œéµå­—ã€æ‰èƒ½è¨­å®šä¿®æ­£è¦å‰‡'); document.getElementById('modal-card-name').innerText = name; document.getElementById('modal-keyword').innerText = k; document.getElementById('modal-new-rate').value = ''; const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('correctionModal')); m.show(); }
    
    function saveCorrection() { const rate = parseFloat(document.getElementById('modal-new-rate').value); if(isNaN(rate)) return showAlert('è«‹è¼¸å…¥æ•¸å€¼'); const k = document.getElementById('modal-keyword').innerText; const ruleKey = `${k}|${correctionTarget.id}`; const rules = loadRules(); rules[ruleKey] = rate; saveRules(rules); bootstrap.Modal.getOrCreateInstance(document.getElementById('correctionModal')).hide(); calculate(); }
    
    function clearCustomRules() { showConfirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ã€Œä¿®æ­£å›é¥‹ã€çš„è‡ªè¨‚è¦å‰‡å—ï¼Ÿ', () => { localStorage.removeItem(RULES_KEY); showAlert('å·²æ¸…é™¤æ‰€æœ‰è‡ªè¨‚è¦å‰‡'); }, 'æ¸…é™¤', 'âš ï¸ ç¢ºèªæ¸…é™¤'); }
    
    function exportData() { const data = { db: loadDB(), rules: loadRules() }; const blob = new Blob([JSON.stringify(data,null,2)], {type : 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `miles_backup_${Date.now()}.json`; a.click(); }

    function updateKeywordPlaceholder() {
        const cat = document.getElementById('category').value;
        const kw = document.getElementById('keyword-input');
        if(cat === 'flight_ci') kw.placeholder = 'ä¾‹å¦‚: è¯èˆªå®˜ç¶², CI...';
        else if(cat === 'flight_cx') kw.placeholder = 'ä¾‹å¦‚: åœ‹æ³°å®˜ç¶², CX...';
        else kw.placeholder = 'è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda, åœè»Š)...';
    }

    window.onload = function() { 
        updateStatusUI(); 
        document.querySelectorAll('.db-date-display').forEach(el => el.innerText = DB_UPDATE_DATE); 
        checkCurrency('TWD'); 
    };
  </script>
</body>
</html>

