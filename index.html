<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TDCç’°å“©åŒ¯ x èˆªç©ºå¡æ¶ˆè²»ç´¯å“©å·¥å…· v12.9 (çµ‚æ¥µè‡ªç”±ç‰ˆ)</title>

  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* =========================
       CSS æ¨£å¼è¡¨ (v12.9 Final)
       ========================= */
    :root {
      --bg-main: #fffdf9;
      --bg-card: #ffffff;
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --text-header: #334155;
      --text-body: #475569;
      --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --radius-pill: 50px;
      --font-hand: 'Mali', cursive;
      --font-main: 'Varela Round', sans-serif;
      --nav-height: 80px;
    }

    body {
      background-color: var(--bg-main);
      color: var(--text-body);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex; flex-direction: column;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
      background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); }

    /* Header */
    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: relative; 
      box-shadow: var(--shadow-draw); margin-bottom: -10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 100px; border-bottom: 3px dashed #bae6fd;
      z-index: 100;
    }
    .header-icon {
      width: 44px; height: 44px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.2rem; transform: rotate(-5deg); margin-right: 12px;
      flex-shrink: 0;
    }
    .header-title h5 { margin: 0; font-size: 1.1rem; color: var(--primary-dark); line-height: 1.3; }
    .header-title small { color: var(--text-light); font-size: 0.8rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.9rem;
      padding: 8px 14px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 20px;
      transition: 0.1s; white-space: nowrap;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 20px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 101; flex: 1; }
    
    .card-box { background: var(--bg-card); border-radius: var(--radius-box); padding: 20px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: var(--shadow-draw); }

    .form-label { font-weight: 700; color: var(--text-header); margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand); }
    .form-control, .form-select { background-color: #fff !important; border: 2px solid #cbd5e1 !important; color: var(--text-header) !important; padding: 10px 14px; border-radius: 16px; font-size: 1rem; font-weight: 600; height: 48px; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03); }
    .form-control:focus, .form-select:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important; }
    .form-control::placeholder { color: #cbd5e1; font-weight: 500; font-size: 0.9rem; }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); }
    
    .btn-action { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; font-weight: 700; border-radius: var(--radius-pill); padding: 14px; width: 100%; border: none; font-size: 1.1rem; font-family: var(--font-hand); box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25); margin-top: 10px; border: 2px solid #bfdbfe; transition: 0.1s; }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    .switch-group { background: #f8fafc; padding: 10px 14px; border-radius: 16px; border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0; display: flex; align-items: center; justify-content: space-between; height: 100%; white-space: nowrap; cursor: pointer; }
    .switch-label { font-size: 0.85rem; font-weight: 700; color: var(--text-body); font-family: var(--font-hand); margin-right: 4px; display: flex; align-items: center; gap: 6px; }
    .form-check-input { width: 2.8em; height: 1.5em; background-color: #cbd5e1; border: 2px solid #cbd5e1; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .result-tag { background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-block; font-family: var(--font-hand); box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(-1deg); }

    .plan-card { padding: 16px; border-radius: 18px; margin-top: 12px; border: 2px solid #f1f5f9; position: relative; background: #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .plan-winner { border-color: var(--primary); background: #f0f9ff; transform: rotate(-0.5deg); }
    .winner-badge { position: absolute; top: -12px; right: 10px; background: #fde047; color: var(--text-header); font-size: 0.75rem; padding: 4px 12px; border-radius: 14px; font-weight: 700; border: 2px solid #fde047; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(3deg); font-family: var(--font-hand); }
    .warning-badge { background: #fee2e2; color: #ef4444; font-size: 0.75rem; padding: 2px 8px; border-radius: 8px; font-weight: 700; border: 1px solid #fecaca; display: inline-block; margin-top: 4px; }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    .card-tpm { font-size: 0.75rem; color: #94a3b8; font-weight: 700; background: #fff; padding: 2px 8px; border-radius: 10px; display: inline-block; border: 1px solid #e2e8f0; }

    /* Control Buttons in Card */
    .card-actions { margin-top: 10px; display: flex; gap: 8px; }
    .btn-card-action { 
        border: 1px solid #e2e8f0; background: #fff; color: #64748b; 
        border-radius: 50px; padding: 6px 14px; font-size: 0.8rem; font-weight: 700; 
        font-family: var(--font-hand); cursor: pointer; transition: 0.2s; 
        display: flex; align-items: center; gap: 4px; box-shadow: 1px 1px 0 #e2e8f0;
    }
    .btn-card-action:hover { transform: translateY(-1px); }
    .btn-card-action.btn-record-win { background: #3b82f6; color: white; border-color: #2563eb; box-shadow: 1px 1px 0 #2563eb; }
    .btn-card-action.btn-record { color: var(--primary); border-color: #bfdbfe; background: #eff6ff; }

    .custom-rule-tag { font-size: 0.7rem; color: #fff; background: #a8a29e; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-block; transform: rotate(0deg); box-shadow: none; font-weight: normal; }

    .nccc-alert { background-color: #fffbeb; border: 2px dashed #f59e0b; border-radius: 16px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; color: #92400e; text-align: left; }
    .nccc-btn { display: inline-block; margin-top: 8px; background: #fff; border: 1px solid #f59e0b; color: #d97706; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; text-decoration: none; box-shadow: 2px 2px 0 rgba(245, 158, 11, 0.2); }
    
    #fx-input-group { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{ opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

    .nav-bottom { position: relative; width: 100%; background: #ffffff; border-top: 2px solid #e2e8f0; border-top-left-radius: 24px; border-top-right-radius: 24px; display: flex; justify-content: space-evenly; padding: 15px 0 30px 0; margin-top: 20px; z-index: 90; box-shadow: 0 -4px 20px rgba(0,0,0,0.02); }
    .nav-item { color: var(--text-light); font-size: 0.75rem; font-weight: 700; cursor: pointer; padding: 6px 12px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-family: var(--font-hand); border-radius: 16px; flex: 1; }
    .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-2px); transition: 0.2s; }

    .modal-content { border-radius: 24px; border: 3px solid #bfdbfe; background: #fffdf7; }
    .modal-header { border-bottom: 2px dashed #e2e8f0; padding: 20px; }
    .modal-title { font-weight: 800; color: var(--text-header); font-family: var(--font-hand); }
    .setting-section { background: #fff; padding: 16px; border-radius: 18px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: 2px 2px 0 #f1f5f9; }
    .setting-title { font-size: 0.9rem; font-weight: 700; color: var(--text-header); margin-bottom: 12px; font-family: var(--font-hand); display: flex; align-items: center; gap:6px; }
    .setting-title::before { content:''; display:inline-block; width:4px; height:16px; background:var(--primary); border-radius:4px; }
    .custom-card-item { background: #f8fafc; padding: 10px 12px; border-radius: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e2e8f0; }
    .delete-btn { color: #ef4444; background: #fff; width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #fecaca; box-shadow: 2px 2px 0 #fecaca; }
    
    .update-info { font-family: var(--font-hand); color: #1e293b; font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; text-align: center; background: #f0f9ff; display: inline-block; padding: 8px 20px; border-radius: 50px; border: 2px solid #bfdbfe; box-shadow: 2px 2px 0 #bfdbfe; }
    .disclaimer-text { font-size: 0.9rem; color: #000000; font-weight: 700; text-align: justify; line-height: 1.6; margin-top: 30px; padding: 16px; background: #fff; border: 2px solid #000; border-radius: 16px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
    
    .guide-step { display: flex; gap: 12px; margin-bottom: 20px; }
    .step-num { width: 30px; height: 30px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: var(--font-hand); flex-shrink: 0; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
    .step-content h6 { margin-bottom: 4px; color: var(--primary-dark); }
    .step-content p { font-size: 0.9rem; margin: 0; line-height: 1.5; }
    
    .airline-group-card { background: #fdfdfd; border: 2px solid #bfdbfe; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(191, 219, 254, 0.2); overflow: hidden; }
    .airline-header { background: #eff6ff; padding: 12px 16px; border-bottom: 2px solid #bfdbfe; display: flex; justify-content: space-between; align-items: center; }
    .airline-title { font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; }
    .airline-total { font-weight: 800; color: var(--text-header); font-size: 1.2rem; }
    .airline-body { padding: 16px; }
    .asset-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .asset-info { display: flex; flex-direction: column; }
    .asset-name { font-weight: 700; color: #334155; font-size: 0.9rem; }
    .asset-detail { font-size: 0.75rem; color: #94a3b8; }
    .asset-value { font-weight: 700; color: var(--primary); }
    .btn-asset-del, .btn-asset-edit { color: #cbd5e1; cursor: pointer; padding: 4px; transition: 0.2s; }
    .btn-asset-del:hover { color: #ef4444; }
    .btn-asset-edit:hover { color: var(--primary); }

    .target-input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; background: #f8fafc; padding: 8px; border-radius: 12px; border: 1px dashed #cbd5e1; }
    .input-block-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .input-block-title { font-family: var(--font-hand); font-weight: 700; color: #334155; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  </style>
</head>

<body>
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="header-title">
        <h5>TDCç’°å“©åŒ¯ x èˆªç©ºå¡<br>æ¶ˆè²»ç´¯å“©å·¥å…· v12.9</h5>
        <small class="text-secondary fw-bold">âš™ï¸ çµ‚æ¥µè‡ªç”±ç‰ˆ</small>
      </div>
    </div>
    <button class="btn-header" onclick="openSettings()"><i class="fa-solid fa-gear me-1"></i> è¨­å®š</button>
  </div>

  <div class="container-custom">
    
    <div class="text-center w-100">
       <div class="update-info">
         <i class="fa-solid fa-circle-info me-1 text-primary"></i> 
         è³‡æ–™åº«æœ€å¾Œæ›´æ–°ï¼š<span class="db-date-display text-primary"></span>
       </div>
    </div>

    <!-- Page: Calculator -->
    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><i class="fa-solid fa-cake-candles"></i> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><i class="fa-solid fa-ticket"></i> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-primary"><i class="fa-solid fa-crosshairs me-1"></i> ç´¯ç©ç›®æ¨™ (èˆªç©º/è¨ˆç•«)</label>
          <select id="redemption-target" class="form-select border-primary" style="background-color: #eff6ff !important; border-width: 2px;">
            <option value="AM_BR">ğŸŒ äºè¬ / é•·æ¦® (AM / BR)</option>
            <option value="CI">ğŸŒ¸ ä¸­è¯èˆªç©º (CI)</option>
          </select>
        </div>

        <div class="row g-2 mb-1">
            <div class="col-6">
              <label class="form-label">å¹£åˆ¥</label>
              <select id="currency" class="form-select" onchange="checkCurrency(this.value)">
                <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
                <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
                <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD</option>
                <option value="other">ğŸŒ å…¶ä»–</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
              <select id="payment" class="form-select">
                <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
                <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
                <option value="apple_pay">ğŸ Apple Pay</option>
                <option value="line_pay">ğŸŸ© LINE Pay</option>
              </select>
            </div>
          </div>

        <div class="mb-3 mt-3">
          <label class="form-label" id="amount-label">æ¶ˆè²»é‡‘é¡ (TWD)</label>
          <div class="input-group">
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal" min="0">
          </div>
        </div>

        <div id="fx-input-group" class="mb-3 p-3 rounded-3" style="background: #f0f9ff; border: 2px dashed #bae6fd; display: none;">
            <label class="form-label text-primary">è‡ªè¨‚åŒ¯ç‡</label>
            <div class="input-group mb-2">
                <span class="input-group-text bg-white">1 å¤–å¹£ = </span>
                <input type="number" id="fx-rate-input" class="form-control" placeholder="åŒ¯ç‡" inputmode="decimal" min="0" step="0.0001">
                <span class="input-group-text bg-white">TWD</span>
            </div>
            <a href="https://rate.bot.com.tw/trial/t14" target="_blank" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold mb-2">
                <i class="fa-solid fa-building-columns me-1"></i> ğŸ¦ è‡ºç£éŠ€è¡Œç‰Œå‘ŠåŒ¯ç‡
            </a>
            <div class="text-muted small">
                <i class="fa-solid fa-calculator me-1"></i> 
                å°‡ä»¥ <strong>(å¤–å¹£ x åŒ¯ç‡)</strong> ä½œç‚ºæœ¬é‡‘è¨ˆç®—ï¼Œä¸¦è‡ªå‹•å¤–åŠ  1.5% æ‰‹çºŒè²»ã€‚
            </div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda, åœè»Š)..." style="font-size:0.9rem;">
          <div class="text-muted small mt-1 ms-1"><i class="fa-solid fa-lightbulb text-warning"></i> è¼¸å…¥é—œéµå­—å¯è§¸ç™¼æ‚¨çš„è‡ªè¨‚ä¿®æ­£è¦å‰‡</div>
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <i class="fa-solid fa-calculator ms-2"></i></button>
      </div>

      <div id="result-area">
        <div class="nccc-alert">
          <div class="fw-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i> ç•™æ„å°é¡æ”¯ä»˜ç„¡å›é¥‹</div>
          é€£é–é€Ÿé£Ÿ(éº¥ç•¶å‹/è‚¯å¾·åŸºç­‰)ã€é£²æ–™åº—ã€åœè»Šå ´ã€ä¾¿åˆ©å•†åº—ç­‰é€šè·¯ï¼Œæ¥µé«˜æ©Ÿç‡å±¬æ–¼ã€ŒNCCCå°é¡æ”¯ä»˜ã€ï¼Œé€šå¸¸ç„¡å›é¥‹ã€‚
          <div class="text-center">
            <a href="https://www.nccc.com.tw/wps/wcm/connect/zh/home/BusinessOperations/CardBusiness/MicroPayment" target="_blank" class="nccc-btn">
              <i class="fa-solid fa-magnifying-glass me-1"></i> æŸ¥è©¢ NCCC å®˜æ–¹åå–®
            </a>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <div class="text-end lh-1" id="fx-info" style="display:none;"></div>
        </div>

        <div id="cards-container"></div>
      </div>
      
      <div class="disclaimer-text">
        <i class="fa-solid fa-triangle-exclamation text-danger me-1"></i> ä½¿ç”¨è€…æ‡‰è‡ªè¡Œç•™æ„æœ¬å·¥å…·æ›´æ–°æ—¥æœŸå¯èƒ½ä¸¦éæœ€æ–°å…¬å‘Šå¾Œçš„å…Œæ›ã€ç´¯ç©æ¯”ä¾‹ï¼Œå„˜ç®¡æˆ‘å€‘è£½ä½œæ­¤ç¶²ç«™åŠä½œå‡ºå‡è¨­æ™‚å·²åŠ›æ±‚å¯©æ…ï¼ŒæƒŸæ´»å‹•éç¨‹ä¸­æ¼”ç®—çµæœæ‡‰åªè¦–ä½œæŒ‡æ¨™ï¼Œè€Œéçµ•å°æº–ç¢ºè¨ˆç®—ã€‚è©³æƒ…è«‹åƒè€ƒéŠ€è¡Œæ‰€æä¾›ä¹‹æ´»å‹•èªªæ˜ã€‚<br><br>
        äºå•†å“ç››è¯é–£è‚¡ä»½æœ‰é™å…¬å¸ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼æ¯é›†åœ˜åŠæ——ä¸‹é—œè¯å­å…¬å¸ã€åˆ†å…¬å¸ï¼‰ã€ç¤¾åœ˜æ³•äººè‡ºç£å“©ç¨‹ç ”ç©¶ç¤¾ã€ã€Œç’°å“©åŒ¯ãƒ»å°Šè²´å¸¸æ—…å®¢ä¿±æ¨‚éƒ¨ã€ã€ã€Œç¤¾åœ˜æ³•äººç’°çƒå¸¸æ—…å®¢å”æœƒã€å‡ç„¡é ˆå°ä»»ä½•äººå°±ç”±æ–¼ä½¿ç”¨æˆ–ä¾è³´æºè‡ªæ­¤æ´»å‹•ç¶²ç«™çš„è³‡æ–™è€Œå¼•è‡´æˆ–èˆ‡æ­¤æœ‰é—œçš„ä»»ä½•æå¤±ã€æå®³æˆ–ä»»ä½•å½¢å¼çš„è²»ç”¨ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼ä»»ä½•ç¶“æ¿Ÿæå¤±æˆ–å…¶ä»–ç›´æ¥ã€é–“æ¥æˆ–ç›¸æ‡‰è€Œç”Ÿçš„æå®³ï¼‰æ‰¿æ“”è²¬ä»»ã€‚
      </div>

    </div>

    <!-- Page: Status, Warehouse, Guide -->
    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary"><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœŸç´¯ç©</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn btn-sm btn-outline-danger flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">é‡ç½®æœ¬æœŸ</button>
           <button onclick="exportData()" class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">åŒ¯å‡º JSON</button>
        </div>
        <div class="mt-3 text-center">
             <button onclick="clearCustomRules()" class="btn btn-link btn-sm text-secondary" style="text-decoration:none; font-size:0.8rem;">
               <i class="fa-solid fa-rotate-left me-1"></i> é‡ç½®æ‰€æœ‰è‡ªè¨‚ä¿®æ­£
             </button>
        </div>
      </div>
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning" style="color:#b45309;"><i class="fa-solid fa-shield-halved me-2"></i>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
        <small class="text-muted d-block mt-2 text-center font-hand">å°æ–°å¡ç‚ºå¹´åº¦é¡åº¦ï¼Œå…¶ä»–å¡ç‰‡æœƒæ ¹æ“šçµå¸³æ—¥é‡ç½®</small>
      </div>
    </div>

    <div id="page-warehouse" class="page-section" style="display:none;">
        <div class="input-block-card">
            <div class="input-block-title text-primary"><i class="fa-solid fa-plane"></i> å­˜å…¥èˆªç©ºå“©ç¨‹ (åŸç”Ÿ)</div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">èˆªå¸åç¨±</label><input id="native-airline-name" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (å»ºè­°ç”¨ç°¡ç¨±)"></div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">ç›®å‰æŒæœ‰å“©ç¨‹</label><input id="native-current" type="number" class="form-control" placeholder="0" min="0"></div>
            <button onclick="addNativeAsset()" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold">å­˜å…¥èˆªç©ºå¸³æˆ¶</button>
        </div>
        <div class="input-block-card">
            <div class="input-block-title text-warning" style="color:#d97706;"><i class="fa-solid fa-right-left"></i> å­˜å…¥è½‰é»ç©åˆ† (é£¯åº—/éŠ€è¡Œ)</div>
            <div class="row g-2 mb-2">
                <div class="col-7"><label class="form-label small mb-1 fw-bold">ç©åˆ†ä¾†æº</label><input id="trans-source-name" class="form-control" placeholder="å¦‚: è¬è±ª, å°æ¨¹é»"></div>
                <div class="col-5"><label class="form-label small mb-1 fw-bold">æŒæœ‰ç©åˆ†</label><input id="trans-current" type="number" class="form-control" placeholder="0" min="0"></div>
            </div>
            <div class="mb-2"><label class="form-label small mb-1 fw-bold text-primary">æ¬²å…Œæ›ä¹‹ç›®æ¨™èˆªå¸ (æ­¸æˆ¶ä¾æ“š)</label><input id="trans-target-airline" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (è«‹ä¿æŒåç¨±ä¸€è‡´)"></div>
            <div class="bg-light p-2 rounded border mb-2">
                <label class="small text-muted fw-bold mb-1">å…Œæ›å…¬å¼ (ä¾‹å¦‚: 360é» = 1000å“©)</label>
                <div class="input-group input-group-sm mb-2"><span class="input-group-text">æ¯</span><input id="trans-unit-points" type="number" class="form-control" placeholder="360" min="0"><span class="input-group-text">é» = </span><input id="trans-unit-miles" type="number" class="form-control" placeholder="1000" min="0"><span class="input-group-text">å“©</span></div>
                <div><label class="small text-muted fw-bold">æ»¿é¡åŠ è´ˆ (é¸å¡«)</label><div class="input-group input-group-sm"><span class="input-group-text">æ¯</span><input id="trans-bonus-thres" type="number" class="form-control" placeholder="60000" min="0"><span class="input-group-text">é»è´ˆ</span><input id="trans-bonus-val" type="number" class="form-control" placeholder="5000" min="0"><span class="input-group-text">å“©</span></div></div>
            </div>
            <button onclick="addTransferAsset()" class="btn btn-sm btn-outline-warning w-100 rounded-pill fw-bold" style="color:#b45309; border-color:#d97706;">å­˜å…¥è½‰é»è³‡ç”¢</button>
        </div>
        <div id="warehouse-list"></div>
    </div>

    <!-- Guide Page (Updated) -->
    <div id="page-guide" class="page-section" style="display:none;">
        <div class="card-box">
            <h5 class="mb-4 text-primary"><i class="fa-solid fa-book-open me-2"></i>æ–°æ‰‹æŒ‡å— v12.9</h5>
            <div class="guide-step"><div class="step-num">1</div><div class="step-content"><h6>Zero Config é›¶è¨­å®š</h6><p>åªè¦åœ¨ã€Œè¨­å®šã€å•Ÿç”¨å¡ç‰‡ï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨å€‰åº«å»ºç«‹å°æ‡‰çš„ç©åˆ†/å“©ç¨‹å¸³æˆ¶ï¼Œç„¡é ˆæ‰‹å‹•è¼¸å…¥ã€‚</p></div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-content"><h6>è‡ªç”±è¨˜å¸³ (New)</h6><p>è¨ˆç®—å®Œæˆå¾Œï¼Œ<strong>æ‚¨å¯ä»¥é»æ“Šä»»ä¸€å¼µå¡ç‰‡ä¸Šçš„ã€Œè¨˜å¸³ã€æŒ‰éˆ•</strong>ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡è©²å¡ç‰‡çš„æ•¸æ“šå­˜å…¥å°æ‡‰å€‰åº«ã€‚è‹¥ç‚ºåŒ¯è± Live+ï¼Œä¾ç„¶æœƒè‡ªå‹•é™¤ä»¥ 2 æ›ç®—å›ç©åˆ†ï¼</p></div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-content"><h6>è³‡ç”¢ç®¡ç†</h6><p>åœ¨å€‰åº«é é¢ï¼Œæ‚¨å¯ä»¥éš¨æ™‚é»æ“Šã€Œâœï¸ ä¿®æ”¹ã€æŒ‰éˆ•ä¾†æ­¸é›¶æˆ–èª¿æ•´å·²å…Œæ›çš„é»æ•¸ã€‚</p></div></div>
            
            <div class="alert alert-light border mt-4">
              <h6 class="fw-bold text-primary"><i class="fa-solid fa-rocket me-2"></i>v12.9 ç‰ˆæœ¬æ›´æ–°æ—¥èªŒ (çµ‚æ¥µè‡ªç”±ç‰ˆ)</h6>
              <ul class="mb-0 ps-3 small text-secondary" style="line-height: 1.6;">
                <li><strong>è‡ªç”±è¨˜å¸³ï¼š</strong>ä¸å†å¼·åˆ¶é–å®šç¬¬ä¸€åï¼Œé–‹æ”¾é»æ“Šä»»æ„å¡ç‰‡é€²è¡Œè¨˜å¸³ã€‚</li>
                <li><strong>åŒ¯è±åˆ†æµï¼š</strong>Live+ èˆ‡æ—…äººç©åˆ†ç¾åœ¨æœƒåˆ†åˆ¥å­˜å…¥ä¸åŒçš„å€‰åº«å¸³æˆ¶ï¼Œå¸³å‹™æ›´æ¸…æ™°ã€‚</li>
                <li><strong>UI ä¿®å¾©ï¼š</strong>è¨˜å¸³æ™‚ç¢ºèªè¦–çª—æ¨™é¡Œå·²ä¿®æ­£ç‚ºã€Œç¢ºèªè¨˜å¸³ã€ã€‚</li>
                <li><strong>è‡ªå‹•åŒ–ï¼š</strong>å»¶çºŒ v12.8 çš„è‡ªå‹•å»ºå€‰èˆ‡æ™ºæ…§åæ¨é‚è¼¯ã€‚</li>
              </ul>
            </div>
        </div>
    </div>
  </div>

  <div class="nav-bottom">
    <div class="nav-item active" onclick="switchPage('calc')"><i class="fa-solid fa-calculator"></i><br>è¨ˆç®—</div>
    <div class="nav-item" onclick="switchPage('status')"><i class="fa-solid fa-chart-simple"></i><br>ç›£æ§</div>
    <div class="nav-item" onclick="switchPage('warehouse')"><i class="fa-solid fa-warehouse"></i><br>å€‰åº«</div>
    <div class="nav-item" onclick="switchPage('guide')"><i class="fa-solid fa-book"></i><br>æ•™å­¸</div>
  </div>

  <!-- Modals -->
  <!-- Custom Alert Modal -->
  <div class="modal fade" id="customAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body text-center py-4 px-3">
          <i class="fa-solid fa-circle-exclamation text-warning mb-3" style="font-size: 3rem;"></i>
          <p class="mb-0 fw-bold text-secondary" id="alert-msg" style="font-size: 1.05rem; line-height: 1.5;"></p>
        </div>
        <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
          <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold font-hand" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Asset Edit Modal -->
  <div class="modal fade" id="editAssetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ”¹è³‡ç”¢é¤˜é¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <p class="small text-muted mb-2">æ­£åœ¨ä¿®æ”¹ï¼š<span id="edit-asset-name" class="fw-bold text-dark"></span></p>
            <input type="number" id="edit-asset-val" class="form-control text-center fw-bold fs-4 text-primary" min="0">
        </div>
        <div class="modal-footer border-0 pt-0 d-flex justify-content-center pb-4 gap-2">
            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold" onclick="saveAssetEdit()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">âš™ï¸ è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="setting-section"><div class="setting-title">åŠ ç¢¼è³‡æ ¼ç¢ºèª (è‡ªå‹•æ‰£ç¹³)</div><div class="switch-group mb-2"><span class="switch-label">åŒ¯è± Live+ è‡ªå‹•æ‰£ç¹³ <small class="text-muted fw-normal">(ç²¾é¸+1%)</small></span><input class="form-check-input" type="checkbox" id="setting-hsbc-autopay" onchange="updateGlobalSetting('hsbc_autopay', this.checked)"></div></div>
          <div class="setting-section"><div class="setting-title">å…§å»ºç¥å¡ (è¤‡é›œé‚è¼¯)</div><div id="builtin-cards-list"></div></div>
          <div class="setting-section"><div class="setting-title">è‡ªè¨‚å¡ç‰‡ (ç°¡æ˜“é‚è¼¯)</div><div id="custom-cards-list" class="mb-3"></div><div class="bg-white p-3 rounded-3 border border-2 border-primary-subtle" style="border-style:dashed;"><label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label><input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨±"><div class="row g-2"><div class="col-6"><input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§" min="0"></div><div class="col-6"><input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–" min="0"></div></div><button onclick="addCustomCard()" class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold font-hand">ç¢ºèªæ–°å¢</button></div></div>
          <div class="setting-section"><div class="setting-title">å¸³å–®çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</div><div id="billing-days-list"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="correctionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ­£å›é¥‹å€ç‡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted mb-3">ä¿®æ­£ <strong><span id="modal-card-name"></span></strong> åœ¨é—œéµå­— <strong>ã€Œ<span id="modal-keyword"></span>ã€</strong> çš„å›é¥‹ã€‚<br>ç³»çµ±å°‡æœƒè¨˜ä½æ­¤è¨­å®šï¼Œä¸‹æ¬¡è‡ªå‹•å¥—ç”¨ã€‚</p>
          <div class="mb-3"><label class="form-label">è«‹è¼¸å…¥æ­£ç¢ºçš„ã€Œå¹¾å…ƒä¸€å“©ã€</label><input type="number" id="modal-new-rate" class="form-control form-control-lg text-center fw-bold text-primary" placeholder="ä¾‹å¦‚: 18" min="0"><div class="form-text text-center font-hand">è¼¸å…¥ 0 ä»£è¡¨ç„¡å›é¥‹ (NCCC/æ’é™¤é …ç›®)</div></div>
          <button onclick="saveCorrection()" class="btn btn-primary w-100 rounded-pill fw-bold">å„²å­˜ä¸¦é‡æ–°è¨ˆç®—</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold" id="confirmModalTitle">âš ï¸ ç¢ºèªå‹•ä½œ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center py-4"><p class="mb-0 text-secondary fw-bold" id="confirm-msg" style="line-height:1.5;"></p></div>
        <div class="modal-footer border-0 pt-0 d-flex justify-content-center gap-3 pb-4"><button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" id="btn-confirm-yes">ç¢ºèª</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* =========================
       å“©ç¨‹æ”»ç•¥ v12.9 (çµ‚æ¥µè‡ªç”±ç‰ˆï¼šè‡ªç”±è¨˜å¸³ + åŒ¯è±åˆ†æµ)
       ========================= */

    const DB_UPDATE_DATE = "2026/02/13"; 

    // Builtin Definitions
    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true, note: 'é¤é£²è³¼ç‰©ç¥å¡' },
      { id: 'ctbc_ci_inf', name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨ç„¡é™å¡', default: false, note: 'æŒ‡å®š$10 / ç”Ÿæ—¥$6.6' },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true, note: 'è¶Šé£›æœ‰å“© $5/å“©' },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true, note: 'åœ‹å¤– $10/å“©' },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Šå¡', default: true, note: 'æµ·å¤–å¯¦é«” $6/å“©' }
    ];

    // ğŸŒŸ è‡ªå‹•å»ºå€‰è¦å‰‡ (v12.9 Split Assets)
    const AUTO_ASSETS = {
        'hsbc_live': { target: 'åŒ¯è± Live+ ç¾é‡‘ç©åˆ†', type: 'transfer', ratio: 2, unitPoints:1, unitMiles:2 },
        'hsbc_inf': { target: 'åŒ¯è± æ—…äººç©åˆ†', type: 'transfer', ratio: 1, unitPoints:1, unitMiles:1 },
        'ctbc_ci': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'ctbc_ci_inf': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'taishin_cx': { target: 'äºæ´²è¬é‡Œé€š/åœ‹æ³° (å“©ç¨‹)', type: 'airline', ratio: 1 }
    };

    const DEFAULT_BILLING = { hsbc:6, ctbc:15, taishin:20, other:1 };
    const RATES = { TWD:1, USD:33.5, JPY:0.225, EUR:36, CNY:4.6, KRW:0.025, THB:0.96, SGD:24.5, other: 1 };
    
    // Keywords (Same as before)
    const LIVE_KEYWORDS = { 'dining': ['é¤å»³','åƒé£¯','å¤–é€','ubereats','foodpanda','ç‡’è‚‰','ç«é‹','éº»è¾£','å£½å¸','æ—¥å¼','å±…é…’å±‹','é¤é…’é¤¨','é…’å§','å’–å•¡','ç”œé»','ç‰›æ’','éµæ¿ç‡’','æ‹‰éºµ','èŒ¶å…­','å±‹é¦¬','ä¹¾æ¯','buffet','ç‹å“','äº«é´¨','å¤æ…•å°¼','è¥¿å ¤','çŸ³äºŒé‹','é™¶æ¿å±‹','é’èŠ±é©•','é¥—è³“','é¥—é¥—','é–‹é£¯','ç“¦åŸ','é¼æ³°è±','æµ·åº•æ’ˆ','é‡‘å¤§é‹¤','ç¯‰é–“','å£½å¸éƒ','è—å£½å¸','çˆ­é®®','å‰å…†','æ˜å£½å¸','é‡‘è‰²ä¸‰éº¥','æ˜¥å¤§ç›´','è²³æ¨“','æ¶“è±†è…','hooters','å‹ç”°','éº¥ç•¶å‹','æ˜Ÿå·´å…‹','å¿…å‹å®¢','é”ç¾æ¨‚','å¯Œç‹','æ–‡å…¬é¤¨','æ•™çˆ¶ç‰›æ’','å±±æµ·æ¨“','é¹½ä¹‹è¯','ç‰¡ä¸¹','logy','inita','ikea','è«å‡¡å½¼','è²´æ—ä¸–å®¶'], 'shop': ['momo','pchome','è¦çš®','shopee','amazon','ebay','éœ²å¤©','friday','gomaji','æ·˜å¯¶','uniqlo','zara','h&m','net','gu','nike','adidas','outlet','å°åŒ—101','ä¸‰äº•','å¾®é¢¨','sogo','æ¼¢ç¥','è¯æ³°','æ–°å…‰','skm','att','ç¾éº—è¯','å—ç´¡','çµ±ä¸€æ™‚ä»£','é é›„','äº¬ç«™','citylink','å¤¢æ™‚ä»£','lalaport','é«˜å³¶å±‹','ä¸­å‹','é ä¼','éº—å¯¶','æ¯”æ¼¾','å¤§æ±Ÿ','å·¨åŸ','é æ±','global mall','ç’°çƒ','ç¾©å¤§','å°èŒ‚','å®åŒ¯','ç¾©äº«','noke','å¤§é­¯é–£','æ˜æ›œ','bellavita','å¯¶é›…','ç„¡å°è‰¯å“','muji','å±ˆè‡£æ°','åº·æ˜¯ç¾','æ¾æœ¬æ¸…','å”å‰è¨¶å¾·'], 'entertainment': ['æ–°å…‰å½±åŸ','å¨ç§€','åœ‹è³“','ç§€æ³°','ç’°çƒå½±åŸ','è¿ªå£«å°¼','å‰åœåŠ›','æ¨‚å¤©ä¸–ç•Œ','legoland','safari','å…’ç«¥æ–°æ¨‚åœ’','x park','å°äººåœ‹','å…­ç¦æ‘','æµ·æ´‹å…¬åœ’','éº—å¯¶æ¨‚åœ’','åŠæ¹–å±±','ä¹æ—','å°šé †','ç¾©å¤§éŠæ¨‚','å·§è™','å‹•ç‰©åœ’','æµ·ç”Ÿé¤¨','å¥‡ç¾åšç‰©é¤¨','å°å®å™¹','é‡æŸ³','åŸ”å¿ƒ','é£›ç‰›','é ‘çš®ä¸–ç•Œ','ç¾è¡“é¤¨','æ—¥æœˆæ½­','å¤ªå¹³å±±','é˜¿é‡Œå±±','å¤§é›ªå±±','å¢¾ä¸','æ£®æ—éŠæ¨‚å€'] };
    const CTBC_INF_TRAVEL_KEYWORDS = ['agoda','booking','trip','klook','hotels','expedia','airbnb'];
    const CTBC_BOOKING_KEYWORDS = ['agoda','booking','hotels.com','expedia','trip.com','airbnb'];
    const NCCC_FAST_FOOD = ['éº¥ç•¶å‹','è‚¯å¾·åŸº','æ¼¢å ¡ç‹','æ‘©æ–¯','é ‚å‘±å‘±','å¿…å‹å®¢','é”ç¾æ¨‚','æ‹¿å¡é‡Œ','subway'];
    const NCCC_BLACKLIST = ['å…«æ–¹é›²é›†','çˆ­é®®','è·¯æ˜“è','louisa','cama','50åµ','æ¸…å¿ƒ','è¿·å®¢å¤','å¯ä¸å¯','åœè»Š','å˜Ÿå˜Ÿæˆ¿','å°é¡'];
    const COMMON_BLOCK = ['ç®¡ç†è²»','ç¤¾å€','ç¨…','å­¸è²»','æ°´è²»','é›»è²»','ç“¦æ–¯','ç½°','è¦è²»','å¥ä¿','é›»ä¿¡','ä¸­è¯é›»ä¿¡','é å‚³','å°ç£å¤§','å„²å€¼','é å€Ÿ','åˆ†æœŸ'];
    const CTBC_BLOCK = [...COMMON_BLOCK, 'å…¨è¯','px','å…¨æ”¯ä»˜','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','etoro','wise','revolut', ...NCCC_BLACKLIST];
    const HSBC_BLOCK_BASE = [...COMMON_BLOCK, 'å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš', ...NCCC_BLACKLIST];
    const TAISHIN_BLOCK = [...COMMON_BLOCK, 'åˆ†æœŸ','å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åœ‹æ°‘å¹´é‡‘','etag','ä¸‰å•†ç¾é‚¦', ...NCCC_BLACKLIST];

    const CARD_RULES = {
        'ctbc_ci_inf': { name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨ç„¡é™å¡', calc: (ctx) => { if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' }; if (ctx.isBirthday && ctx.isForeign && ctx.pay === 'physical') { return { miles: Math.floor(ctx.twdBase/6.6), note: 'ğŸ‚ ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6.6/å“©<br><span class="small text-muted">(æ”»ç•¥: åˆ·60è¬æ‹¿æ»¿)</span>' }; } const isTravelBooking = CTBC_INF_TRAVEL_KEYWORDS.some(w => ctx.kwKey.includes(w)); if (ctx.cat.startsWith('flight') || ctx.isForeign || isTravelBooking) { return { miles: Math.floor(ctx.twdBase/10), note: 'âœˆï¸ æŒ‡å®š/æµ·å¤– $10/å“©<br><span class="small text-muted">(æ”»ç•¥: åˆ·60è¬æ‹¿æ»¿)</span>' }; } return { miles: Math.floor(ctx.twdBase/20), note: 'ä¸€èˆ¬æ¶ˆè²» $20/å“©' }; } },
        'hsbc_live': { name: 'åŒ¯è± Live+', calc: (ctx) => { if (ctx.isEUR) return { miles:0, note: '<span class="text-danger fw-bold">ğŸš« æ­ç›Ÿå¯¦é«”ä¸å›é¥‹</span>' }; if (HSBC_BLOCK_BASE.some(w => ctx.kwKey.includes(w))) return { miles:0, note: '<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' }; let displayRate = '0.88%'; let displayType = 'ä¸€èˆ¬'; let warning = ''; const hasAutopay = ctx.db.settings.hsbc_autopay; let totalPoints = ctx.twdBase * 0.0088; const isAsian = ['JPY', 'KRW', 'SGD', 'THB', 'CNY'].includes(ctx.curr); if(ctx.isLiveSelect) { displayType = 'ç²¾é¸'; displayRate = '3.88%'; let bonus1 = ctx.twdBase * 0.03; if(bonus1 > 888) { bonus1 = 888; warning = 'âš ï¸ é€šè·¯åŠ ç¢¼å·²é”ä¸Šé™'; } totalPoints += bonus1; let bonus2Rate = 0; if(isAsian) { bonus2Rate = 0.01; displayType = 'äºæ´²ç²¾é¸'; displayRate = '4.88%'; } else if(hasAutopay) { bonus2Rate = 0.01; displayRate = '4.88%'; } if(isAsian && hasAutopay) displayRate = '5.88%'; if(bonus2Rate > 0) { let bonus2 = ctx.twdBase * 0.01; if(bonus2 > 200) { bonus2 = 200; warning = warning ? 'âš ï¸ é›™é‡åŠ ç¢¼å·²é”ä¸Šé™' : 'âš ï¸ ä»»å‹™åŠ ç¢¼å·²é”ä¸Šé™'; } totalPoints += bonus2; } } else { if(hasAutopay) displayRate = '1.88%'; } let n = `${displayType} ${displayRate} <br><span class="text-muted small">1é»ç¾é‡‘ç©é»â‡„2å“©</span>`; if(warning) n = `${displayType} (æ··åˆè²»ç‡)<br><span class="warning-badge">${warning}</span>`; return { miles: Math.floor(totalPoints) * 2, note: n }; } },
        'taishin_cx': { name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ', calc: (ctx) => { let isFlyQualifying = false; if (TAISHIN_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›® (ç¨…/è²»)</span>', isFlyQualifying }; let div = ctx.isForeign ? 15 : 22; let n = `ç´„${div}å…ƒ/å“©`; const isMobilePay = (ctx.pay === 'apple_pay' || ctx.pay === 'line_pay'); if(ctx.cat === 'flight_cx') { if (isMobilePay) { div = 22; n = 'âš ï¸ APP+Payç„¡$5 (æ¢æ¬¾æ’é™¤ï¼Œåƒ…ä¸€èˆ¬å›é¥‹)'; } else if (ctx.isForeign) { div = 15; n = 'âš ï¸ éå°å¹£ä»˜æ¬¾ (ä¾æ¢æ¬¾è¦–ç‚ºæµ·å¤–$15)'; } else { div = 5; isFlyQualifying = true; n = 'è¶Šé£›(å®˜ç¶²) $5/å“©<br><span class="text-muted small">(ä¾æ¢æ¬¾æ”¶å–æµ·å¤–æ‰‹çºŒè²»)</span>'; } } else if(ctx.isFlyMode) { if(!isMobilePay && ['agoda','booking','klook','kkday','expedia','hotels','æ˜‡æ†æ˜Œ','é‡‡ç›Ÿ'].some(w=>ctx.kwKey.includes(w))) { div = 5; isFlyQualifying = true; n = `è¶Šé£›(æŒ‡å®šæ—…éŠ) $5/å“©`; } else if(!isMobilePay && ctx.isForeign && ctx.pay === 'physical') { div = 5; isFlyQualifying = true; n = `è¶Šé£›(æµ·å¤–å¯¦é«”) $5/å“©`; } } if (ctx.isFlyMode && isMobilePay && ctx.cat !== 'flight_cx') n += ` <span class="text-danger small">(Payç„¡$5)</span>`; return { miles: Math.floor(ctx.twdBase/div), note: n, isFlyQualifying }; } },
        'hsbc_inf': { name: 'åŒ¯è± æ—…äººç„¡é™', calc: (ctx) => { if (HSBC_BLOCK_BASE.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' }; let div = ctx.cat.startsWith('flight') ? 10 : (ctx.isForeign ? 10 : 18); return { miles: Math.floor(ctx.twdBase/div), note: `ç´„${div}å…ƒ/å“© (1ç©åˆ†=1å“©)` }; } },
        'ctbc_ci': { name: 'ä¸­ä¿¡ è¯èˆªé¼å°Šå¡', calc: (ctx) => { if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>' }; let div = 18; let n = 'ä¸€èˆ¬ $18/å“©'; const isCtbcBooking = CTBC_BOOKING_KEYWORDS.some(w => ctx.kwKey.includes(w)); if (ctx.cat === 'flight_ci') { div = 9; n = 'è¯èˆªå®˜ç¶² $9/å“©'; } else if (isCtbcBooking) { div = 9; n = 'æŒ‡å®šè¨‚æˆ¿ç¶² $9/å“©'; } else if(ctx.isForeign && (ctx.pay === 'physical' || ctx.pay === 'apple_pay')) { if(ctx.isBirthday) { div = 6; n = `ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6/å“©`; } else { div = 9; n = `æµ·å¤–å¯¦é«” $9/å“©`; } } else if(ctx.isForeign && ctx.pay === 'online') { div = 18; n = 'æµ·å¤–ç¶²è³¼ $18/å“©'; } if(div === 9 || div === 6) n += ` <br><span class="text-danger small" style="font-size:0.7em;">(å«åŠ ç¢¼ä¸Šé™)</span>`; return { miles: Math.floor(ctx.twdBase/div), note: n }; } }
    };

    // UI & Logic
    function showAlert(msg) {
        document.getElementById('alert-msg').innerHTML = msg.replace(/\n/g, '<br>');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('customAlertModal'));
        m.show();
    }

    let pendingDeleteAction = null; 
    // ğŸŒŸ æ¨™é¡Œåƒæ•¸ (v12.9)
    function showConfirm(msg, callback, btnText='ç¢ºèª', title='âš ï¸ ç¢ºèªå‹•ä½œ') {
        document.getElementById('confirmModalTitle').innerText = title;
        document.getElementById('confirm-msg').innerHTML = msg.replace(/\n/g, '<br>');
        document.getElementById('btn-confirm-yes').innerText = btnText;
        document.getElementById('btn-confirm-yes').className = `btn rounded-pill px-4 fw-bold ${btnText.includes('ç¢ºèª')?'btn-primary':'btn-danger'}`;
        pendingDeleteAction = callback;
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal'));
        m.show();
    }
    document.getElementById('btn-confirm-yes').addEventListener('click', function() { 
        if(pendingDeleteAction) pendingDeleteAction(); 
        bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal')).hide(); 
    });

    const DB_KEY = 'MILES_APP_V12_6_DATA'; 
    const RULES_KEY = 'MILES_APP_RULES';
    let correctionTarget = { id: null, name: null };
    let editAssetTargetIdx = null;

    function cleanUpOldRecords(db) {
        if (!db.records) return false;
        const now = new Date();
        let isModified = false;
        for (let key in db.records) {
            const [yearStr, monthStr] = key.split('-');
            if (yearStr && monthStr) {
                const diffMonths = (now.getFullYear() - parseInt(yearStr)) * 12 + (now.getMonth() + 1 - parseInt(monthStr));
                if (diffMonths > 12) { delete db.records[key]; isModified = true; }
            }
        }
        return isModified;
    }

    function checkAndCreateAutoAssets(db) {
        let created = false;
        db.settings.enabledBuiltins.forEach(cardId => {
            const rule = AUTO_ASSETS[cardId];
            if(rule) {
                const exists = db.warehouse.some(a => a.targetAirline === rule.target);
                if(!exists) {
                    db.warehouse.push({ 
                        type: rule.type, 
                        targetAirline: rule.target, 
                        name: rule.target + (rule.type==='transfer'?'':' (è‡ªå‹•å»ºç«‹)'), 
                        current: 0, 
                        ratio: rule.ratio, 
                        unitPoints: rule.unitPoints||1, 
                        unitMiles: rule.unitMiles||1,
                        bonusThres: 0, bonusVal: 0 
                    });
                    created = true;
                }
            }
        });
        return created;
    }

    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if(!raw) return initDB();
      const db = JSON.parse(raw);
      if(typeof db.settings.hsbc_autopay === 'undefined') db.settings.hsbc_autopay = true;
      if(!db.warehouse) db.warehouse = [];
      if(!db.airlineGoals) db.airlineGoals = {};
      
      let modified = false;
      if(cleanUpOldRecords(db)) modified = true;
      if(checkAndCreateAutoAssets(db)) modified = true;
      
      if(modified) saveDB(db);
      return db;
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function initDB() { 
        let db = { settings: { enabledBuiltins: BUILTIN_DEFS.filter(c => c.default).map(c => c.id), billingDays: { ...DEFAULT_BILLING }, hsbc_autopay: true }, customCards: [], records: {}, limits: {}, warehouse: [], airlineGoals: {} };
        checkAndCreateAutoAssets(db);
        return db;
    }
    function loadRules() { const raw = localStorage.getItem(RULES_KEY); return raw ? JSON.parse(raw) : {}; }
    function saveRules(data) { localStorage.setItem(RULES_KEY, JSON.stringify(data)); }

    function checkCurrency(val) {
      const label = $('amount-label'); const input = $('amount'); const fxGroup = $('fx-input-group'); const fxRateInput = $('fx-rate-input');
      if (val === 'TWD') { label.innerText = 'æ¶ˆè²»é‡‘é¡ (TWD)'; input.placeholder = '0'; fxGroup.style.display = 'none'; } 
      else { label.innerText = `æ¶ˆè²»é‡‘é¡ (${val})`; input.placeholder = 'å¤–å¹£é‡‘é¡'; fxGroup.style.display = 'block'; if(RATES[val]) fxRateInput.value = RATES[val]; }
    }

    function calculate() {
      const db = loadDB(); const rules = loadRules();
      const amt = parseFloat($('amount').value);
      if(isNaN(amt) || amt <= 0) return showAlert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æœ‰æ•ˆé‡‘é¡ï¼');
      
      const ctx = {
          db: db, curr: $('currency').value, cat: $('category').value, pay: $('payment').value,
          kwKey: ($('keyword-input').value || '').trim().toLowerCase(),
          isBirthday: $('birthdayMode').checked, isFlyMode: $('flyMode').checked,
          isForeign: $('currency').value !== 'TWD', isEUR: $('currency').value === 'EUR',
          twdBase: 0, twdSpend: 0, isLiveSelect: false
      };

      if (ctx.isForeign) {
          const userRate = parseFloat($('fx-rate-input').value);
          if(isNaN(userRate) || userRate <= 0) return showAlert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æœ‰æ•ˆåŒ¯ç‡ï¼');
          ctx.twdBase = Math.round(amt * userRate); ctx.twdSpend = Math.round(ctx.twdBase * 1.015);
      } else {
          ctx.twdBase = Math.round(amt); ctx.twdSpend = ctx.twdBase;
      }

      if(ctx.cat === 'dining') ctx.isLiveSelect = true;
      else if(LIVE_KEYWORDS['dining'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['shop'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['entertainment'].some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;
      if(NCCC_FAST_FOOD.some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;

      let tags = [];
      if(ctx.isForeign) tags.push('åœ‹å¤–');
      if(ctx.pay === 'line_pay') tags.push('LinePay');
      $('fx-info').style.display = 'block'; $('fx-info').innerHTML = `<div class="small text-muted">æœ¬é‡‘ NT$${ctx.twdBase.toLocaleString()}</div><div class="fw-bold text-dark">æˆæœ¬ NT$${ctx.twdSpend.toLocaleString()}</div>`;
      $('scenario-tag').innerText = tags.length ? tags.join(' + ') : 'ä¸€èˆ¬æ¶ˆè²»';

      let results = [];
      function resolveMiles(cardId, defaultCalcFn) {
         const ruleKey = `${ctx.kwKey}|${cardId}`;
         if(ctx.kwKey && rules[ruleKey] !== undefined) {
             const customDiv = rules[ruleKey];
             if(customDiv === 0) return { miles: 0, note: 'ğŸš« è‡ªè¨‚: ç„¡å›é¥‹', isCustom: true };
             return { miles: Math.floor(ctx.twdBase / customDiv), note: `âš™ï¸ è‡ªè¨‚: ${customDiv}å…ƒ/å“©`, isCustom: true };
         }
         return defaultCalcFn();
      }

      db.settings.enabledBuiltins.forEach(cardId => {
          if(CARD_RULES[cardId]) { results.push({ id: cardId, name: CARD_RULES[cardId].name, ...resolveMiles(cardId, () => CARD_RULES[cardId].calc(ctx)) }); }
      });
      db.customCards.forEach(c => {
         results.push({ id: c.id, name: c.name, ...resolveMiles(c.id, () => { let div = ctx.isForeign ? c.forRate : c.domRate; if(!div || div <= 0) div = 999; return { miles: Math.floor(ctx.twdBase / div), note: `è¨­å®š${div}å…ƒ/å“©` }; }), type: 'custom' });
      });

      results.forEach(r => { r.tpm = r.miles > 0 ? (ctx.twdSpend / r.miles) : 999; });
      results.sort((a,b) => b.miles - a.miles);
      
      // ğŸŒŸ å°‡çµæœå­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œä¾›è‡ªç”±è¨˜å¸³ä½¿ç”¨ (v12.9)
      window.currentResults = results.map(r => ({ ...r, twdSpend: ctx.twdSpend, twdBase: ctx.twdBase, isFlyQualifying: r.isFlyQualifying }));
      
      renderResults(results, ctx.twdSpend);
    }

    function renderResults(list, spend) {
      const con = $('cards-container'); con.innerHTML = ''; $('result-area').style.display = 'block';
      if(list.length === 0) { con.innerHTML = '<div class="text-center p-3 text-muted">æ²’æœ‰å•Ÿç”¨çš„å¡ç‰‡</div>'; return; }
      
      list.forEach((c, idx) => {
        const isWinner = idx === 0;
        const div = document.createElement('div');
        div.className = `plan-card ${isWinner ? 'plan-winner' : ''}`;
        let badge = isWinner ? `<span class="winner-badge"><i class="fa-solid fa-crown"></i> WINNER</span>` : '';
        let customTag = c.isCustom ? '<span class="custom-rule-tag">è‡ªè¨‚è¦å‰‡</span>' : '';
        
        // ğŸŒŸ æ–°å¢ï¼šæ¯å¼µå¡ç‰‡çš„è¨˜å¸³æŒ‰éˆ• (v12.9)
        let recordBtnClass = isWinner ? 'btn-record-win' : 'btn-record';
        let recordBtnIcon = isWinner ? 'ğŸ†' : 'ğŸ“';
        let recordBtnText = isWinner ? 'è¨˜å¸³' : 'è¨˜å¸³';

        div.innerHTML = `
          ${badge}
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="d-flex align-items-center mb-1"><h4 class="card-name mb-0">${c.name}</h4>${customTag}</div>
              <div class="text-muted small font-hand">${c.note}</div>
              <div class="card-actions">
                 <button class="btn-card-action ${recordBtnClass}" onclick="confirmRecord(${idx})">${recordBtnIcon} ${recordBtnText}</button>
                 <button class="btn-correct" onclick="openCorrection('${c.id}','${c.name}')"><i class="fa-solid fa-pen"></i> ä¿®æ­£</button>
              </div>
            </div>
            <div class="text-end">
              <div class="card-miles">${c.miles.toLocaleString()} <small style="font-size:0.5em; color:#64748b;">å“©</small></div>
              <div class="card-tpm">${c.tpm < 200 ? c.tpm.toFixed(1) : '>200'} å…ƒ/å“©</div>
            </div>
          </div>`;
        con.appendChild(div);
      });
    }

    function renderWarehouse() {
        const db = loadDB(); const con = $('warehouse-list'); con.innerHTML = '';
        if(db.warehouse.length === 0) { con.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡è³‡ç”¢ï¼Œè«‹ç¢ºèªå·²å•Ÿç”¨å¡ç‰‡</div>'; return; }

        const groups = {};
        db.warehouse.forEach((asset, index) => {
            const key = asset.targetAirline.trim().toUpperCase(); 
            if(!groups[key]) groups[key] = { totalEffective: 0, assets: [], target: db.airlineGoals[key] || 0 };
            let effective = 0; const current = parseFloat(asset.current);
            if(asset.type === 'airline') { effective = current; } 
            else {
                const uPoints = parseFloat(asset.unitPoints) || parseFloat(asset.ratio) || 1; 
                const uMiles = parseFloat(asset.unitMiles) || 1;
                const blocks = Math.floor(current / uPoints); effective = blocks * uMiles;
                if(asset.bonusThres > 0 && asset.bonusVal > 0) { const bonusCount = Math.floor(current / asset.bonusThres); effective += (bonusCount * asset.bonusVal); }
            }
            groups[key].totalEffective += effective; groups[key].assets.push({ ...asset, originalIndex: index, effective });
        });

        for (const [airline, group] of Object.entries(groups)) {
            const pct = group.target > 0 ? Math.min(100, Math.round((group.totalEffective / group.target) * 100)) : 0;
            const color = pct >= 100 ? 'bg-success' : (pct >= 80 ? 'bg-warning' : 'bg-primary');
            const remaining = Math.max(0, group.target - group.totalEffective);

            let assetsHtml = '';
            group.assets.forEach(a => {
                let formulaText = a.type !== 'airline' ? `<small class="text-muted d-block" style="font-size:0.7rem;">(${a.unitPoints||a.ratio||1}é»=${a.unitMiles||1}å“©)</small>` : '';
                assetsHtml += `<div class="asset-item"><div class="asset-info"><span class="asset-name">${a.name}</span><span class="asset-detail">æŒæœ‰ ${parseInt(a.current).toLocaleString()} ${a.type!=='airline'?'é»':''}</span>${formulaText}</div><div class="d-flex align-items-center"><i class="fa-solid fa-pen btn-asset-edit me-2" onclick="openEditAsset(${a.originalIndex})"></i><span class="asset-value me-2">${a.effective.toLocaleString()} å“©</span><i class="fa-solid fa-trash-can btn-asset-del" onclick="delWarehouseAsset(${a.originalIndex})"></i></div></div>`;
            });

            con.innerHTML += `<div class="airline-group-card"><div class="airline-header"><div class="airline-title"><i class="fa-solid fa-plane-up me-2"></i>${airline}</div><div class="airline-total">${group.totalEffective.toLocaleString()} å“©</div></div><div class="airline-body"><div class="target-input-group"><label class="small fw-bold mb-0 text-nowrap">ç›®æ¨™:</label><input type="number" class="form-control form-control-sm border-0 bg-transparent fw-bold text-end" value="${group.target > 0 ? group.target : ''}" placeholder="è¨­å®šç›®æ¨™" min="0" onchange="updateAirlineGoal('${airline}', this.value)"></div><div class="progress mb-2" style="height: 8px; border-radius: 4px; background: #e2e8f0;"><div class="progress-bar ${color}" style="width: ${pct}%"></div></div><div class="text-end small text-muted fw-bold mb-3">${group.target > 0 ? (pct>=100 ? 'ğŸ‰ ç›®æ¨™é”æˆï¼' : `é‚„å·® ${remaining.toLocaleString()} å“©`) : 'è«‹è¨­å®šç›®æ¨™'}</div><div class="assets-list">${assetsHtml}</div></div></div>`;
        }
    }

    function addNativeAsset() {
        const name = $('native-airline-name').value.trim(); const current = parseFloat($('native-current').value);
        if(!name || isNaN(current)) return showAlert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); if(current < 0) return showAlert('å“©ç¨‹ä¸èƒ½ç‚ºè² æ•¸ï¼');
        const db = loadDB(); db.warehouse.push({ type: 'airline', targetAirline: name, name: name + ' (å¸³æˆ¶)', current, ratio: 1, bonusThres: 0, bonusVal: 0 }); saveDB(db);
        $('native-airline-name').value = ''; $('native-current').value = ''; renderWarehouse();
    }

    function addTransferAsset() {
        const name = $('trans-source-name').value; const targetAirline = $('trans-target-airline').value.trim(); const current = parseFloat($('trans-current').value);
        const unitPoints = parseFloat($('trans-unit-points').value); const unitMiles = parseFloat($('trans-unit-miles').value);
        const bonusThres = parseFloat($('trans-bonus-thres').value) || 0; const bonusVal = parseFloat($('trans-bonus-val').value) || 0;
        if(!name || !targetAirline || isNaN(current) || isNaN(unitPoints) || isNaN(unitMiles)) return showAlert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š (åŒ…å«å…Œæ›å…¬å¼)');
        if(current < 0 || unitPoints <= 0 || unitMiles < 0 || bonusThres < 0 || bonusVal < 0) return showAlert('ç©åˆ†èˆ‡å…Œæ›æ•¸å€¼ä¸å¯ç‚ºè² æ•¸ï¼Œä¸”æ¯ X é»ä¸å¯ç‚º 0ï¼');
        const db = loadDB(); db.warehouse.push({ type: 'transfer', targetAirline, name, current, unitPoints, unitMiles, bonusThres, bonusVal }); saveDB(db);
        $('trans-source-name').value = ''; $('trans-current').value = ''; $('trans-target-airline').value = ''; $('trans-unit-points').value = ''; $('trans-unit-miles').value = ''; $('trans-bonus-thres').value = ''; $('trans-bonus-val').value = ''; renderWarehouse();
    }

    function delWarehouseAsset(idx) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡ç”¢å—ï¼Ÿ', () => { const db = loadDB(); db.warehouse.splice(idx, 1); saveDB(db); renderWarehouse(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    function delHistoryRecord(id) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ­·å²ç´€éŒ„å—ï¼Ÿ\n(é€™ä¹Ÿæœƒæ‰£é™¤ç›¸æ‡‰çš„ä¸Šé™é¡åº¦)', () => { const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; if (db.records[monthKey] && db.records[monthKey][id]) { delete db.records[monthKey][id]; saveDB(db); updateStatusUI(); } }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    function updateAirlineGoal(airline, val) { const v = parseInt(val); if(v < 0) return showAlert('ç›®æ¨™ä¸å¯ç‚ºè² æ•¸'); const db = loadDB(); db.airlineGoals[airline] = v || 0; saveDB(db); renderWarehouse(); }

    function openEditAsset(idx) {
        editAssetTargetIdx = idx; const db = loadDB(); const asset = db.warehouse[idx]; if(!asset) return;
        document.getElementById('edit-asset-name').innerText = asset.name; document.getElementById('edit-asset-val').value = asset.current;
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('editAssetModal')); m.show();
    }
    function saveAssetEdit() {
        const val = parseFloat(document.getElementById('edit-asset-val').value);
        if(isNaN(val) || val < 0) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼ (>=0)');
        const db = loadDB(); if(db.warehouse[editAssetTargetIdx]) { db.warehouse[editAssetTargetIdx].current = val; saveDB(db); bootstrap.Modal.getOrCreateInstance(document.getElementById('editAssetModal')).hide(); renderWarehouse(); }
    }

    function openCorrection(id, name) {
        const kw = ($('keyword-input').value || '').trim();
        if(!kw) { return showAlert('è«‹æ³¨æ„ï¼š\n\næ‚¨å¿…é ˆå…ˆåœ¨ã€Œæ¶ˆè²»é¡åˆ¥/å‚™è¨»ã€æ¬„ä½è¼¸å…¥ä¸€å€‹é—œéµå­— (ä¾‹å¦‚: éº¥ç•¶å‹)ï¼Œç³»çµ±æ‰èƒ½é‡å°è©²é—œéµå­—è¨­å®šå°ˆå±¬çš„å›é¥‹è¦å‰‡ã€‚'); }
        correctionTarget = { id, name }; $('modal-card-name').innerText = name; $('modal-keyword').innerText = kw; $('modal-new-rate').value = '';
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('correctionModal')); m.show();
    }
    function saveCorrection() {
        const kw = ($('keyword-input').value || '').trim(); const val = parseFloat($('modal-new-rate').value);
        if(isNaN(val) || val < 0) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•¸å€¼ (0 ä»£è¡¨ç„¡å›é¥‹)');
        const rules = loadRules(); rules[`${kw.toLowerCase()}|${correctionTarget.id}`] = val; saveRules(rules);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('correctionModal')).hide(); calculate();
    }
    function clearCustomRules() { showConfirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ‰‹å‹•ä¿®æ­£çš„è¦å‰‡å—ï¼Ÿ', () => { localStorage.removeItem(RULES_KEY); calculate(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }

    function getBillingCycle(cardPrefix, billingDay) {
      const now = new Date(); const monthOffset = (now.getDate() > billingDay) ? 1 : 0;
      const d = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    // ğŸŒŸ è¨˜å¸³é‚è¼¯ (v12.9: æ¥æ”¶ Index åƒæ•¸)
    function confirmRecord(resultIdx) {
      const resultData = window.currentResults[resultIdx];
      if(!resultData) return;
      
      const { id, name, miles, twdSpend, twdBase, isFlyQualifying } = resultData;
      let extraNote = '';
      const autoRule = AUTO_ASSETS[id];
      if(autoRule) {
          if(id === 'hsbc_live') { extraNote = `<br><span class="text-primary small">(æ™ºæ…§æ›ç®—: ${miles}å“© Ã· 2 = ${Math.round(miles/2)}ç©åˆ†)</span>`; }
          else { extraNote = `<br><span class="text-primary small">(å°‡å­˜å…¥: ${autoRule.target})</span>`; }
      }

      showConfirm(`ç¢ºå®šè¨˜å¸³ï¼Ÿ\nå¡ç‰‡ï¼š${name}\nç´¯ç©ï¼š${miles} å“©\næˆæœ¬ï¼š$${twdSpend}${extraNote}`, () => {
          const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
          
          if(!db.records[monthKey]) db.records[monthKey] = {};
          if(!db.records[monthKey][id]) db.records[monthKey][id] = { miles:0, spend:0, name };
          db.records[monthKey][id].miles += miles; db.records[monthKey][id].spend += twdSpend;

          let limitKey = '';
          if(id === 'taishin_cx') { limitKey = `${now.getFullYear()}-${id}`; if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0, startDay: 1 }; } 
          else { let day = db.settings.billingDays[id.split('_')[0]] || db.settings.billingDays['other'] || 1; limitKey = `${getBillingCycle(null, day)}-${id}`; if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0, startDay: day }; }
          if(!(id === 'taishin_cx' && !isFlyQualifying)) db.limits[limitKey].spend += twdBase; 
          db.limits[limitKey].points += miles;
          
          if(autoRule) {
              let targetAsset = db.warehouse.find(a => a.targetAirline === autoRule.target);
              if(targetAsset) {
                  let pointsToAdd = miles;
                  if(id === 'hsbc_live') { pointsToAdd = Math.round(miles / 2); } 
                  targetAsset.current = parseFloat(targetAsset.current) + pointsToAdd;
              }
          }
          saveDB(db); updateStatusUI(); renderWarehouse();
      }, 'ç¢ºèªè¨˜å¸³', 'ğŸ“ ç¢ºèªè¨˜å¸³');
    }

    function updateStatusUI() {
      const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const statusCon = $('status-container'); const monthData = db.records[monthKey] || {};
      let html = '';
      if(Object.keys(monthData).length === 0) html = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´€éŒ„</div>';
      else {
        html = '<ul class="list-group list-group-flush">';
        for(let id in monthData) { html += `<li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 border-bottom border-dashed"><span class="fw-bold text-secondary">${monthData[id].name}</span><div class="d-flex align-items-center"><span class="fw-bold text-primary me-3" style="font-family:var(--font-hand);">+${monthData[id].miles}</span><i class="fa-solid fa-trash-can text-muted" style="cursor:pointer; font-size:0.9rem;" onclick="delHistoryRecord('${id}')"></i></div></li>`; }
        html += '</ul>';
      }
      statusCon.innerHTML = html;

      const limitsCon = $('limits-container'); let limitHtml = '';
      const targets = [{ id: 'hsbc_live', name: 'åŒ¯è± Live+', limit: 29600 }, { id: 'ctbc_ci_inf', name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨ç„¡é™å¡', limit: 600000 }, { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ', limit: 1000000 }, { id: 'ctbc_ci', name: 'ä¸­ä¿¡ è¯èˆªé¼å°Šå¡', limit: 1440000 }];
      let anyShown = false;

      targets.forEach(t => {
        if(!db.settings.enabledBuiltins.includes(t.id)) return;
        anyShown = true; let current = 0; let noteText = '';
        if(t.id === 'taishin_cx') {
            const record = db.limits[`${now.getFullYear()}-${t.id}`] || { spend:0 };
            current = record.spend; noteText = 'æœ¬å¹´åº¦ç´¯ç©';
        } else {
            const day = db.settings.billingDays[t.id.split('_')[0]] || 1;
            const record = db.limits[`${getBillingCycle(null, day)}-${t.id}`] || { spend:0 };
            current = record.spend; noteText = `çµå¸³æ—¥: ${day}è™Ÿ`;
        }
        const percent = Math.min(100, Math.round((current / t.limit) * 100));
        let color = percent > 80 ? (percent>=100?'bg-danger':'bg-warning') : 'bg-success';
        limitHtml += `<div class="mb-3"><div class="d-flex justify-content-between small mb-1"><strong>${t.name}</strong><span>$${current.toLocaleString()} / $${t.limit.toLocaleString()}</span></div><div class="progress" style="height: 8px; border-radius:4px; background:#e2e8f0;"><div class="progress-bar ${color}" style="width: ${percent}%;"></div></div><div class="text-end text-muted mt-1" style="font-size:0.7rem;">${noteText}</div></div>`;
      });
      if (!anyShown) limitHtml = '<div class="text-center text-muted small py-2">ç„¡ç›£æ§ä¸­çš„å¡ç‰‡ï¼Œè«‹è‡³è¨­å®šé–‹å•Ÿ</div>';
      limitsCon.innerHTML = limitHtml;
    }

    function openSettings() { 
        renderSettings(); 
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('settingsModal'));
        m.show(); 
    }
    function renderSettings() {
      const db = loadDB(); $('setting-hsbc-autopay').checked = db.settings.hsbc_autopay;
      const builtinCon = $('builtin-cards-list'); builtinCon.innerHTML = '';
      BUILTIN_DEFS.forEach(def => {
        const isOn = db.settings.enabledBuiltins.includes(def.id);
        builtinCon.innerHTML += `<div class="switch-group mb-2"><span class="switch-label">${def.name} <small class="text-muted">(${def.note})</small></span><input class="form-check-input" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')"></div>`;
      });
      const customCon = $('custom-cards-list'); customCon.innerHTML = '';
      if(db.customCards.length === 0) customCon.innerHTML = '<div class="text-muted small text-center mb-2">å°šç„¡è‡ªè¨‚å¡ç‰‡</div>';
      db.customCards.forEach((c, idx) => { customCon.innerHTML += `<div class="custom-card-item"><div><div class="fw-bold">${c.name}</div><div class="small text-muted">åœ‹å…§ ${c.domRate} / åœ‹å¤– ${c.forRate}</div></div><div class="delete-btn" onclick="delCustomCard(${idx})"><i class="fa-solid fa-trash"></i></div></div>`; });
      const billCon = $('billing-days-list'); billCon.innerHTML = '';
      const banks = { hsbc:'åŒ¯è±', ctbc:'ä¸­ä¿¡', taishin:'å°æ–°', other:'å…¶ä»–' };
      for(let key in banks) { billCon.innerHTML += `<div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded border"><span class="fw-bold text-secondary font-hand">${banks[key]}</span><input type="number" class="form-control form-control-sm w-25 text-center" value="${db.settings.billingDays[key]||1}" min="1" max="31" onchange="updateBilling('${key}', this.value)"></div>`; }
    }

    function updateGlobalSetting(key, val) { const db = loadDB(); db.settings[key] = val; saveDB(db); }
    function toggleBuiltin(id) { const db = loadDB(); const idx = db.settings.enabledBuiltins.indexOf(id); if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1); else db.settings.enabledBuiltins.push(id); saveDB(db); updateStatusUI(); }
    function addCustomCard() { 
        const name = $('new-card-name').value; const dom = parseFloat($('new-card-dom').value); const fore = parseFloat($('new-card-for').value); 
        if(!name || isNaN(dom) || isNaN(fore)) return showAlert('è«‹å¡«å¯«å®Œæ•´ï¼Œä¸”è²»ç‡å¿…é ˆç‚ºæ•¸å­—'); 
        if(dom <= 0 || fore <= 0) return showAlert('è²»ç‡ä¸å¯ç‚ºé›¶æˆ–è² æ•¸');
        const db = loadDB(); db.customCards.push({ id: `cust_${Date.now()}`, name, domRate: dom, forRate: fore }); saveDB(db); renderSettings(); $('new-card-name').value = ''; $('new-card-dom').value = ''; $('new-card-for').value = ''; 
    }
    function delCustomCard(idx) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µè‡ªè¨‚å¡ç‰‡å—ï¼Ÿ', () => { const db = loadDB(); db.customCards.splice(idx, 1); saveDB(db); renderSettings(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    function updateBilling(key, val) { const v=parseInt(val); if(v<1 || v>31) return showAlert('çµå¸³æ—¥éœ€ä»‹æ–¼1~31ä¹‹é–“'); const db = loadDB(); db.settings.billingDays[key] = v || 1; saveDB(db); updateStatusUI(); }
    function $(id) { return document.getElementById(id); }
    function toggleSwitch(id) { /* UI only */ }
    function switchPage(p) { document.querySelectorAll('.page-section').forEach(e => e.style.display='none'); $(`page-${p}`).style.display='block'; document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); event.currentTarget.classList.add('active'); if(p==='status') updateStatusUI(); if(p==='warehouse') renderWarehouse(); window.scrollTo(0,0); }
    function clearCurrentStats() { showConfirm('ç¢ºå®šè¦é‡ç½®æœ¬æœŸæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ', () => { const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; db.records[monthKey] = {}; saveDB(db); updateStatusUI(); }, 'åˆªé™¤', 'âš ï¸ ç¢ºèªåˆªé™¤'); }
    function exportData() { const db = loadDB(); const blob = new Blob([JSON.stringify(db,null,2)], {type : 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'miles_backup_v12_9.json'; a.click(); }
    
    window.onload = function() { 
        updateStatusUI(); 
        document.querySelectorAll('.db-date-display').forEach(el => el.innerText = DB_UPDATE_DATE); 
        checkCurrency('TWD'); 
    };
  </script>
</body>
</html>


