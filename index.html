<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TDCç’°å“©åŒ¯ x èˆªç©ºå¡æ¶ˆè²»ç´¯å“©å·¥å…· v12.31</title>

  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* =========================
       CSS æ¨£å¼è¡¨ (v12.31 Re-issue)
       ========================= */
    :root {
      --bg-main: #fffdf9;
      --bg-card: #ffffff;
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --text-header: #334155;
      --text-body: #475569;
      --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --font-hand: 'Mali', cursive;
      --font-main: 'Varela Round', sans-serif;
      /* Morandi Palette */
      --m-sage: #84a59d; --m-clay: #f5cac3; --m-dusty: #95b8d1; --m-terra: #e5989b; --m-slate: #6d6875; --m-sand: #f2e9e4; --m-stone: #a5a58d;
    }

    body {
      background-color: var(--bg-main);
      color: var(--text-body);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex; flex-direction: column;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
      background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 100px;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); }

    /* Header */
    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: sticky; top: 0;
      box-shadow: var(--shadow-draw); margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 90px; border-bottom: 3px dashed #bae6fd;
      z-index: 100;
    }
    .header-icon {
      width: 40px; height: 40px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.1rem; transform: rotate(-5deg); margin-right: 10px;
      flex-shrink: 0;
    }
    .header-title h5 { margin: 0; font-size: 1rem; color: var(--primary-dark); line-height: 1.2; }
    .header-title small { color: var(--text-light); font-size: 0.75rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.8rem;
      padding: 6px 12px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 16px;
      transition: 0.1s; white-space: nowrap;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 10px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; flex: 1; }
    
    .card-box { background: var(--bg-card); border-radius: var(--radius-box); padding: 20px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: var(--shadow-draw); }

    .form-label { font-weight: 700; color: var(--text-header); margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand); }
    .form-control, .form-select { background-color: #fff !important; border: 2px solid #cbd5e1 !important; color: var(--text-header) !important; padding: 10px 14px; border-radius: 16px; font-size: 1rem; font-weight: 600; height: 48px; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03); }
    .form-control:focus, .form-select:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important; }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); transition: all 0.3s ease; }
    
    .input-negative { color: #ef4444 !important; font-weight: 900 !important; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    .status-label-negative { color: #ef4444; font-size: 0.8rem; font-weight: 700; margin-top: 4px; font-family: var(--font-hand); display: none; animation: fadeIn 0.2s ease; }

    .btn-action { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; font-weight: 700; border-radius: 50px; padding: 14px; width: 100%; border: none; font-size: 1.1rem; font-family: var(--font-hand); box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25); margin-top: 10px; border: 2px solid #bfdbfe; transition: 0.1s; }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    .switch-group { background: #f8fafc; padding: 10px 14px; border-radius: 16px; border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0; display: flex; align-items: center; justify-content: space-between; height: 100%; white-space: nowrap; cursor: pointer; transition: 0.2s; }
    .form-check-input { width: 2.8em; height: 1.5em; background-color: #cbd5e1; border: 2px solid #cbd5e1; cursor: pointer; pointer-events: none; }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .result-tag { background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-block; font-family: var(--font-hand); box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(-1deg); }
    #fx-info { font-family: var(--font-hand); }

    .plan-card { padding: 16px; border-radius: 18px; margin-top: 12px; border: 2px solid #f1f5f9; position: relative; background: #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .plan-winner { border-color: var(--primary); background: #f0f9ff; transform: rotate(-0.5deg); }
    .winner-badge { position: absolute; top: -12px; right: 10px; background: #fde047; color: var(--text-header); font-size: 0.75rem; padding: 4px 12px; border-radius: 14px; font-weight: 700; border: 2px solid #fde047; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(3deg); font-family: var(--font-hand); }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    
    .btn-card-action { 
        border: 1px solid #e2e8f0; background: #fff; color: #64748b; 
        border-radius: 50px; padding: 6px 14px; font-size: 0.8rem; font-weight: 700; 
        font-family: var(--font-hand); cursor: pointer; transition: 0.2s; 
        display: flex; align-items: center; gap: 4px; box-shadow: 1px 1px 0 #e2e8f0;
    }
    .btn-card-action.btn-record-win { background: #3b82f6; color: white; border-color: #2563eb; box-shadow: 1px 1px 0 #2563eb; }
    
    .btn-correct { border: 1px solid #e2e8f0; background: #fff; color: #94a3b8; border-radius: 50px; padding: 6px 12px; font-size: 0.8rem; font-weight: 700; font-family: var(--font-hand); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
    .btn-correct:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }

    /* Warehouse Styles */
    .input-block-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .input-block-title { font-family: var(--font-hand); font-weight: 700; color: #334155; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
    .asset-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .airline-group-card { background: #fdfdfd; border: 2px solid #bfdbfe; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(191, 219, 254, 0.2); overflow: hidden; }
    .airline-header { background: #eff6ff; padding: 12px 16px; border-bottom: 2px solid #bfdbfe; display: flex; justify-content: space-between; align-items: center; }
    .airline-title { font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; }
    .airline-total { font-weight: 800; color: var(--text-header); font-size: 1.2rem; }
    .btn-asset-del { color: #cbd5e1; cursor: pointer; padding: 4px; }
    .btn-asset-del:hover { color: #ef4444; }

    #fx-input-group { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{ opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

    .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 2px solid #e2e8f0; border-top-left-radius: 24px; border-top-right-radius: 24px; display: flex; justify-content: space-evenly; padding: 12px 0 25px 0; z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
    .nav-item { color: var(--text-light); font-size: 0.7rem; font-weight: 700; cursor: pointer; padding: 6px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-family: var(--font-hand); border-radius: 16px; flex: 1; }
    .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-3px); transition: 0.2s; }
    .nav-badge { position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; border: 2px solid #fff; }

    .list-group-card { background: #fff; border: 2px solid #bfdbfe; border-radius: 18px; margin-bottom: 16px; overflow: hidden; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .list-group-header { background: #eff6ff; padding: 10px 16px; border-bottom: 2px solid #bfdbfe; font-weight: 800; color: var(--primary-dark); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
    .list-item { padding: 12px 16px; border-bottom: 1px dashed #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .list-item:last-child { border-bottom: none; }
    .item-meta { font-size: 0.8rem; color: #64748b; font-weight: 600; display: flex; flex-direction: column; }
    .item-val { font-family: var(--font-hand); font-weight: 700; text-align: right; }
    .btn-item-del { color: #ef4444; background: #fee2e2; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; margin-left: 10px; border: 1px solid #fecaca; }

    .summary-card { background: white; border: 2px solid #e2e8f0; border-radius: 16px; margin-bottom: 8px; padding: 12px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .summary-name { font-weight: 800; color: #334155; font-size: 1rem; margin-bottom: 2px; }
    .summary-spend { font-size: 0.8rem; color: #64748b; font-weight: 600; }
    .summary-miles { font-weight: 800; color: var(--primary); font-family: var(--font-hand); font-size: 1.1rem; }
    
    /* Guide Slide (Morandi High-End) */
    .guide-slide { background: #fff; border-radius: 32px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid #fff; }
    .slide-sage { background-color: var(--m-sage); color: #fff; }
    .slide-dusty { background-color: var(--m-dusty); color: #fff; }
    .slide-clay { background-color: var(--m-clay); color: #5e503f; }
    .slide-slate { background-color: var(--m-slate); color: #fff; }
    .slide-stone { background-color: var(--m-stone); color: #fff; }
    .slide-terra { background-color: var(--m-terra); color: #fff; }
    .g-title { font-family: 'Noto Sans TC', sans-serif; font-weight: 900; font-size: 1.8rem; line-height: 1.2; margin-bottom: 1rem; }
    .g-text { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; font-size: 0.95rem; line-height: 1.6; opacity: 0.95; }
    .g-badge { display: inline-block; background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 900; margin-bottom: 10px; letter-spacing: 1px; }
    .g-box { background: rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.3); }
    .g-list li { margin-bottom: 8px; list-style: none; position: relative; padding-left: 15px; }
    .g-list li::before { content:'â€¢'; position:absolute; left:0; font-weight:bold; }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="header-title">
        <h5>TDC èˆªç©ºç´¯å“©å·¥å…·<br>v12.31</h5>
        <small class="text-secondary fw-bold">âš™ï¸ å°ˆæ¥­æœƒè¨ˆç‰ˆ</small>
      </div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn-header text-primary" onclick="openGuide()"><i class="fa-solid fa-book-open me-1"></i> æ•™å­¸</button>
        <button class="btn-header" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
    </div>
  </div>

  <div class="container-custom">
    
    <!-- Page 1: Calculator -->
    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" id="switch-box-birthdayMode" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><i class="fa-solid fa-cake-candles"></i> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" id="switch-box-flyMode" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><i class="fa-solid fa-ticket"></i> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-primary"><i class="fa-solid fa-crosshairs me-1"></i> ç´¯ç©ç›®æ¨™</label>
          <select id="redemption-target" class="form-select border-primary" style="background-color: #eff6ff !important; border-width: 2px;">
            <option value="ALL">ğŸŒ ä¸æŒ‡å®š (æ‰€æœ‰èˆªå¸)</option>
            <option value="AM_BR">ğŸŒ äºè¬ / é•·æ¦® (AM / BR)</option>
            <option value="CI">ğŸŒ¸ ä¸­è¯èˆªç©º (CI)</option>
          </select>
        </div>

        <div class="row g-2 mb-1">
            <div class="col-5">
              <label class="form-label">å¹£åˆ¥</label>
              <select id="currency-type" class="form-select" onchange="toggleFxInput(this.value)">
                <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option>
                <option value="FOREIGN">ğŸŒ å¤–å¹£</option>
              </select>
            </div>
            <div class="col-7">
              <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
              <select id="payment" class="form-select">
                <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
                <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
                <option value="apple_pay">ğŸ Apple Pay</option>
                <option value="line_pay">ğŸŸ© LINE Pay</option>
              </select>
            </div>
        </div>

        <!-- Dynamic FX Input -->
        <div id="fx-input-group" class="mt-2 mb-2 p-3 rounded-3" style="background: #f0f9ff; border: 2px dashed #bae6fd; display: none;">
            <label class="form-label text-primary small">è«‹è¼¸å…¥ç•¶ä¸‹åŒ¯ç‡ (ç³»çµ±è‡ªå‹•åŠ è¨ˆ1.5%)</label>
            <div class="input-group mb-2">
                <span class="input-group-text bg-white">1 å¤–å¹£ = </span>
                <input type="number" id="fx-rate-input" class="form-control" placeholder="è¼¸å…¥åŒ¯ç‡" inputmode="decimal" min="0" step="0.0001">
                <span class="input-group-text bg-white">TWD</span>
            </div>
            <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold" style="font-size:0.8rem;">
                <i class="fa-solid fa-building-columns me-1"></i> æŸ¥è©¢è‡ºéŠ€ç‰Œå‘ŠåŒ¯ç‡
            </a>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label" id="amount-label">æ¶ˆè²»é‡‘é¡ (TWD)</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary font-hand fw-bold" type="button" onclick="toggleSign('amount')" style="font-size: 0.9rem; background-color:#f8fafc;">é€€åˆ· / ä¿®æ­£</button>
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal" oninput="checkInputStyle(this)">
          </div>
          <div id="amount-status" class="status-label-negative">âš ï¸ ä¿®æ­£/é€€åˆ·æ¨¡å¼ (æ²–å¸³)</div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda)..." style="font-size:0.9rem;">
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <i class="fa-solid fa-calculator ms-2"></i></button>
      </div>

      <div id="result-area">
        <div class="nccc-alert">
          <div class="fw-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i> ç•™æ„å°é¡æ”¯ä»˜ç„¡å›é¥‹</div>
          é€£é–é€Ÿé£Ÿã€ä¾¿åˆ©å•†åº—ç­‰é€šè·¯ï¼Œæ¥µé«˜æ©Ÿç‡å±¬æ–¼ã€ŒNCCCå°é¡æ”¯ä»˜ã€ç„¡å›é¥‹ã€‚
        </div>
        
        <!-- Cost Summary -->
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <div class="text-end lh-1" id="fx-info" style="display:none;"></div>
        </div>

        <div id="cards-container"></div>
      </div>
    </div>

    <!-- Page 2: Transaction List -->
    <div id="page-list" class="page-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-3 px-1">
            <h5 class="text-primary mb-0"><i class="fa-solid fa-list-check me-2"></i>å¾…çµç®—æ˜ç´°</h5>
            <span class="badge bg-secondary rounded-pill" id="pending-count">0 ç­†</span>
        </div>
        <div id="transaction-list-container"></div>
        <div class="text-center mt-4">
            <p class="text-muted small">ç¢ºèªç„¡èª¤å¾Œï¼Œè«‹è‡³ã€Œç›£æ§ã€åˆ†é åŸ·è¡Œé€²å€‰ã€‚</p>
        </div>
    </div>

    <!-- Page 3: Status & Limits -->
    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary"><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœŸç¸½å¸³ (Dashboard)</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn btn-sm btn-outline-danger flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">å…¨éƒ¨é‡ç½®</button>
           <button onclick="batchImport()" class="btn btn-sm btn-action flex-grow-1 rounded-pill fw-bold py-1" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); border:none; color:white; box-shadow:2px 2px 0 #047857;">
             <i class="fa-solid fa-rocket me-1"></i> ä¸€éµé€²å€‰
           </button>
        </div>
      </div>
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning" style="color:#b45309;"><i class="fa-solid fa-shield-halved me-2"></i>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
      </div>
    </div>

    <!-- Page 4: Warehouse (Dual Cards) -->
    <div id="page-warehouse" class="page-section" style="display:none;">
        <div class="input-block-card">
            <div class="input-block-title text-primary"><i class="fa-solid fa-plane"></i> å­˜å…¥èˆªç©ºå“©ç¨‹ (åŸç”Ÿ)</div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">èˆªå¸åç¨±</label><input id="native-airline-name" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (å»ºè­°ç”¨ç°¡ç¨±)"></div>
            <div class="mb-3"><label class="form-label small mb-1 fw-bold">ç›®å‰æŒæœ‰å“©ç¨‹</label><input id="native-current" type="number" class="form-control" placeholder="0"></div>
            <button onclick="addNativeAsset()" class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-bold">å­˜å…¥èˆªç©ºå¸³æˆ¶</button>
        </div>
        
        <div class="input-block-card">
            <div class="input-block-title text-warning" style="color:#d97706;"><i class="fa-solid fa-right-left"></i> å­˜å…¥è½‰é»ç©åˆ† (é£¯åº—/éŠ€è¡Œ)</div>
            <div class="row g-2 mb-2">
                <div class="col-7"><label class="form-label small mb-1 fw-bold">ç©åˆ†ä¾†æº</label><input id="trans-source-name" class="form-control" placeholder="å¦‚: è¬è±ª, å°æ¨¹é»"></div>
                <div class="col-5"><label class="form-label small mb-1 fw-bold">æŒæœ‰ç©åˆ†</label><input id="trans-current" type="number" class="form-control" placeholder="0"></div>
            </div>
            <div class="mb-2"><label class="form-label small mb-1 fw-bold text-primary">æ¬²å…Œæ›ä¹‹ç›®æ¨™èˆªå¸ (æ­¸æˆ¶ä¾æ“š)</label><input id="trans-target-airline" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (è«‹ä¿æŒåç¨±ä¸€è‡´)"></div>
            <div class="bg-light p-2 rounded border mb-2">
                <label class="small text-muted fw-bold mb-1">å…Œæ›å…¬å¼ (ä¾‹å¦‚: 360é» = 1000å“©)</label>
                <div class="input-group input-group-sm mb-2"><span class="input-group-text">æ¯</span><input id="trans-unit-points" type="number" class="form-control" placeholder="360" min="0"><span class="input-group-text">é» = </span><input id="trans-unit-miles" type="number" class="form-control" placeholder="1000" min="0"><span class="input-group-text">å“©</span></div>
                <div><label class="small text-muted fw-bold">æ»¿é¡åŠ è´ˆ (é¸å¡«)</label><div class="input-group input-group-sm"><span class="input-group-text">æ¯</span><input id="trans-bonus-thres" type="number" class="form-control" placeholder="60000" min="0"><span class="input-group-text">é»è´ˆ</span><input id="trans-bonus-val" type="number" class="form-control" placeholder="5000" min="0"><span class="input-group-text">å“©</span></div></div>
            </div>
            <button onclick="addTransferAsset()" class="btn btn-sm btn-outline-warning w-100 rounded-pill fw-bold" style="color:#b45309; border-color:#d97706;">å­˜å…¥è½‰é»è³‡ç”¢</button>
        </div>
        <div id="warehouse-list"></div>
    </div>

  </div>

  <!-- Bottom Nav -->
  <div class="nav-bottom">
    <div class="nav-item active" onclick="switchPage('calc', this)"><i class="fa-solid fa-calculator"></i>è¨ˆç®—</div>
    <div class="nav-item" onclick="switchPage('list', this)">
        <div style="position:relative;">
            <i class="fa-solid fa-clipboard-list"></i>
            <div id="nav-badge-list" class="nav-badge" style="display:none;">0</div>
        </div>
        æ˜ç´°
    </div>
    <div class="nav-item" onclick="switchPage('status', this)"><i class="fa-solid fa-chart-simple"></i>ç›£æ§</div>
    <div class="nav-item" onclick="switchPage('warehouse', this)"><i class="fa-solid fa-warehouse"></i>å€‰åº«</div>
  </div>

  <!-- Correction Modal -->
  <div class="modal fade" id="correctionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ­£å›é¥‹å€ç‡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p class="small text-muted mb-3">ä¿®æ­£ <strong><span id="modal-card-name"></span></strong> åœ¨é—œéµå­— <strong>ã€Œ<span id="modal-keyword"></span>ã€</strong> çš„å›é¥‹ã€‚</p>
          <div class="mb-3"><label class="form-label">è«‹è¼¸å…¥æ­£ç¢ºçš„ã€Œå¹¾å…ƒä¸€å“©ã€</label><input type="number" id="modal-new-rate" class="form-control form-control-lg text-center fw-bold text-primary" placeholder="ä¾‹å¦‚: 18" min="0"><div class="form-text text-center font-hand">è¼¸å…¥ 0 ä»£è¡¨ç„¡å›é¥‹</div></div>
          <button onclick="saveCorrection()" class="btn btn-primary w-100 rounded-pill fw-bold">å„²å­˜ä¸¦é‡æ–°è¨ˆç®—</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Guide Modal (Complete Morandi) -->
  <div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" style="background:transparent; border:none; box-shadow:none;">
        <div class="modal-body p-0" id="guide-content"></div>
        <div class="text-center mt-3">
            <button class="btn btn-light rounded-circle" data-bs-dismiss="modal" style="width:50px; height:50px; opacity:0.8;"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">âš™ï¸ è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="setting-section"><div class="setting-title">åŠ ç¢¼è³‡æ ¼ç¢ºèª</div><div class="switch-group mb-2"><span class="switch-label">åŒ¯è± Live+ è‡ªå‹•æ‰£ç¹³ <small class="text-muted fw-normal">(ç²¾é¸+1%)</small></span><input class="form-check-input" type="checkbox" id="setting-hsbc-autopay" onchange="updateGlobalSetting('hsbc_autopay', this.checked)"></div></div>
          <div class="setting-section"><div class="setting-title">å…§å»ºç¥å¡</div><div id="builtin-cards-list"></div></div>
          <div class="setting-section"><div class="setting-title">è‡ªè¨‚å¡ç‰‡</div><div id="custom-cards-list" class="mb-3"></div><div class="bg-white p-3 rounded-3 border border-2 border-primary-subtle" style="border-style:dashed;"><label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label><input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨±"><div class="row g-2"><div class="col-6"><input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§" min="0"></div><div class="col-6"><input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–" min="0"></div></div><button onclick="addCustomCard()" class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold font-hand">ç¢ºèªæ–°å¢</button></div></div>
          <div class="setting-section"><div class="setting-title">å¸³å–®çµå¸³æ—¥</div><div id="billing-days-list"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts / Asset Edit -->
  <div class="modal fade" id="customAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body text-center py-4 px-3">
          <i class="fa-solid fa-circle-exclamation text-warning mb-3" style="font-size: 3rem;"></i>
          <p class="mb-0 fw-bold text-secondary" id="alert-msg" style="font-size: 1.05rem; line-height: 1.5;"></p>
        </div>
        <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
          <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold font-hand" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editAssetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âœï¸ ä¿®æ”¹è³‡ç”¢é¤˜é¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <p class="small text-muted mb-2">æ­£åœ¨ä¿®æ”¹ï¼š<span id="edit-asset-name" class="fw-bold text-dark"></span></p>
            <input type="number" id="edit-asset-val" class="form-control text-center fw-bold fs-4 text-primary">
        </div>
        <div class="modal-footer border-0 pt-0 d-flex justify-content-center pb-4 gap-2">
            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold" onclick="saveAssetEdit()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* =========================
       TDC Miles Tool v12.28
       ========================= */

    const DB_KEY = 'MILES_APP_V12_6_DATA'; 
    const RULES_KEY = 'MILES_APP_RULES';
    let correctionTarget = { id: null, name: null };
    let editAssetTargetIdx = null;
    
    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true },
      { id: 'ctbc_ci_inf', name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨', default: false },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š', default: true }
    ];
    const AUTO_ASSETS = {
        'hsbc_live': { target: 'åŒ¯è± Live+ ç¾é‡‘ç©åˆ†', type: 'transfer', ratio: 2, unitPoints:1, unitMiles:2 },
        'hsbc_inf': { target: 'åŒ¯è± æ—…äººç©åˆ†', type: 'transfer', ratio: 1, unitPoints:1, unitMiles:1 },
        'ctbc_ci': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'ctbc_ci_inf': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'taishin_cx': { target: 'äºæ´²è¬é‡Œé€š/åœ‹æ³° (å“©ç¨‹)', type: 'airline', ratio: 1 }
    };
    
    const DEFAULT_BILLING = { hsbc:6, ctbc:15, taishin:20, other:1 };
    const LIVE_KEYWORDS = { 'dining':['é¤å»³','åƒé£¯','å¤–é€','ubereats','foodpanda','ç‡’è‚‰','ç«é‹','éº»è¾£','å£½å¸','æ—¥å¼','å±…é…’å±‹','é¤é…’é¤¨','é…’å§','å’–å•¡','ç”œé»','ç‰›æ’','éµæ¿ç‡’','æ‹‰éºµ','èŒ¶å…­','å±‹é¦¬','ä¹¾æ¯','buffet','ç‹å“','äº«é´¨','å¤æ…•å°¼','è¥¿å ¤','çŸ³äºŒé‹','é™¶æ¿å±‹','é’èŠ±é©•','é¥—è³“','é¥—é¥—','é–‹é£¯','ç“¦åŸ','é¼æ³°è±','æµ·åº•æ’ˆ','é‡‘å¤§é‹¤','ç¯‰é–“','å£½å¸éƒ','è—å£½å¸','çˆ­é®®','å‰å…†','æ˜å£½å¸','é‡‘è‰²ä¸‰éº¥','æ˜¥å¤§ç›´','è²³æ¨“','æ¶“è±†è…','hooters','å‹ç”°','éº¥ç•¶å‹','æ˜Ÿå·´å…‹','å¿…å‹å®¢','é”ç¾æ¨‚','å¯Œç‹','æ–‡å…¬é¤¨','æ•™çˆ¶ç‰›æ’','å±±æµ·æ¨“','é¹½ä¹‹è¯','ç‰¡ä¸¹','logy','inita','ikea','è«å‡¡å½¼','è²´æ—ä¸–å®¶'], 'shop':['momo','pchome','è¦çš®','shopee','amazon','ebay','éœ²å¤©','friday','gomaji','æ·˜å¯¶','uniqlo','zara','h&m','net','gu','nike','adidas','outlet','å°åŒ—101','ä¸‰äº•','å¾®é¢¨','sogo','æ¼¢ç¥','è¯æ³°','æ–°å…‰','skm','att','ç¾éº—è¯','å—ç´¡','çµ±ä¸€æ™‚ä»£','é é›„','äº¬ç«™','citylink','å¤¢æ™‚ä»£','lalaport','é«˜å³¶å±‹','ä¸­å‹','é ä¼','éº—å¯¶','æ¯”æ¼¾','å¤§æ±Ÿ','å·¨åŸ','é æ±','global mall','ç’°çƒ','ç¾©å¤§','å°èŒ‚','å®åŒ¯','ç¾©äº«','noke','å¤§é­¯é–£','æ˜æ›œ','bellavita','å¯¶é›…','ç„¡å°è‰¯å“','muji','å±ˆè‡£æ°','åº·æ˜¯ç¾','æ¾æœ¬æ¸…','å”å‰è¨¶å¾·'], 'entertainment':['æ–°å…‰å½±åŸ','å¨ç§€','åœ‹è³“','ç§€æ³°','ç’°çƒå½±åŸ','è¿ªå£«å°¼','å‰åœåŠ›','æ¨‚å¤©ä¸–ç•Œ','legoland','safari','å…’ç«¥æ–°æ¨‚åœ’','x park','å°äººåœ‹','å…­ç¦æ‘','æµ·æ´‹å…¬åœ’','éº—å¯¶æ¨‚åœ’','åŠæ¹–å±±','ä¹æ—','å°šé †','ç¾©å¤§éŠæ¨‚','å·§è™','å‹•ç‰©åœ’','æµ·ç”Ÿé¤¨','å¥‡ç¾åšç‰©é¤¨','å°å®å™¹','é‡æŸ³','åŸ”å¿ƒ','é£›ç‰›','é ‘çš®ä¸–ç•Œ','ç¾è¡“é¤¨','æ—¥æœˆæ½­','å¤ªå¹³å±±','é˜¿é‡Œå±±','å¤§é›ªå±±','å¢¾ä¸','æ£®æ—éŠæ¨‚å€'] };
    const STRICT_ONLINE = ['flight_ci','flight_cx','flight_other','travel'];
    const CTBC_BLOCK = ['å…¨è¯','px','å…¨æ”¯ä»˜','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','etoro','wise','revolut','éº¥ç•¶å‹','è‚¯å¾·åŸº','æ¼¢å ¡ç‹','æ‘©æ–¯'];
    const HSBC_BLOCK_BASE = ['å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš','éº¥ç•¶å‹','è‚¯å¾·åŸº'];
    const HSBC_LIVE_BLOCK = ['å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš'];
    const TAISHIN_BLOCK = ['åˆ†æœŸ','å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åœ‹æ°‘å¹´é‡‘','etag','ä¸‰å•†ç¾é‚¦','éº¥ç•¶å‹','è‚¯å¾·åŸº'];

    const CARD_RULES = {
        'ctbc_ci_inf': {
            name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨',
            calc: (ctx) => {
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>' };
                const isOnline = STRICT_ONLINE.includes(ctx.cat) || ctx.pay === 'online';
                const isTruePhysical = !isOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay');
                if (ctx.isBirthday && ctx.isForeign && isTruePhysical) return { miles: Math.trunc(ctx.twdBase/6.6), note: 'ğŸ‚ ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6.6' };
                if (ctx.cat.startsWith('flight') || ctx.isForeign || ['agoda','booking','trip'].some(w=>ctx.kwKey.includes(w))) return { miles: Math.trunc(ctx.twdBase/10), note: 'âœˆï¸ æŒ‡å®š/æµ·å¤– $10' };
                return { miles: Math.trunc(ctx.twdBase/20), note: 'ä¸€èˆ¬ $20' };
            }
        },
        'hsbc_live': {
            name: 'åŒ¯è± Live+',
            calc: (ctx) => {
                if (ctx.isEUR) return { miles:0, note: '<span class="text-danger">ğŸš« æ­ç›Ÿå¯¦é«”ä¸å›é¥‹</span>' };
                if (HSBC_LIVE_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note: '<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>' };
                if (['apple_pay','line_pay'].includes(ctx.pay)) return { miles:0, note: 'ğŸš« ç¶å®šè¡Œå‹•æ”¯ä»˜ç„¡åŠ ç¢¼' };
                
                let displayType = 'ä¸€èˆ¬', bonus = 0, isAsian = ['JPY','KRW','SGD','THB','CNY'].includes(ctx.curr);
                let base = ctx.twdBase * 0.0088;
                if(ctx.isLiveSelect) { 
                    displayType = 'ç²¾é¸'; bonus += ctx.twdBase * 0.03; if(bonus>888) bonus=888;
                    if(ctx.db.settings.hsbc_autopay) { let b2 = ctx.twdBase * 0.01; if(b2>200) b2=200; bonus+=b2; }
                    if(isAsian) { let b2 = ctx.twdBase * 0.01; if(b2>200) b2=200; bonus+=b2; displayType='äºæ´²ç²¾é¸'; }
                } else if(ctx.db.settings.hsbc_autopay) { displayType='ä¸€èˆ¬+ä»»å‹™'; base += ctx.twdBase * 0.01; }
                return { miles: Math.trunc(base + bonus) * 2, note: `${displayType} <small>1é»=2å“©</small>` };
            }
        },
        'taishin_cx': {
            name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',
            calc: (ctx) => {
                if (TAISHIN_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>' };
                let div = ctx.isForeign ? 15 : 22, n = `ç´„${div}å…ƒ/å“©`;
                let isMobilePay = (ctx.pay === 'apple_pay' || ctx.pay === 'line_pay');
                if(ctx.cat === 'flight_cx') { 
                    if(isMobilePay) { div=22; n='Payç„¡åŠ ç¢¼'; } else if(ctx.isForeign) { div=15; n='éå°å¹£ä»˜æ¬¾'; } else { div=5; n='è¶Šé£›(å®˜ç¶²) $5'; }
                } else if(ctx.isFlyMode && ctx.cat !== 'flight_ci') {
                    if(!isMobilePay && (['agoda','booking','klook'].some(w=>ctx.kwKey.includes(w)) || (ctx.isForeign && ctx.pay==='physical'))) { div=5; n='è¶Šé£›(å¯¦é«”/æ—…éŠ) $5'; }
                }
                return { miles: Math.trunc(ctx.twdBase/div), note: n };
            }
        },
        'hsbc_inf': {
            name: 'åŒ¯è± æ—…äººç„¡é™',
            calc: (ctx) => {
                if (['éº¥ç•¶å‹', ...HSBC_BLOCK_BASE].some(w => ctx.kwKey.includes(w))) return { miles:0, note:'ğŸš« éå›é¥‹' };
                let div = (ctx.cat.startsWith('flight') || ctx.isForeign) ? 10 : 18;
                return { miles: Math.trunc(ctx.twdBase/div), note: `$${div}å…ƒ/å“©` };
            }
        },
        'ctbc_ci': {
            name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š',
            calc: (ctx) => {
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'ğŸš« éå›é¥‹' };
                const isOnline = STRICT_ONLINE.includes(ctx.cat) || ctx.pay === 'online';
                const isTruePhysical = !isOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay');
                let div = 18, n = 'ä¸€èˆ¬ $18';
                if(ctx.cat === 'flight_ci') { div=9; n='è¯èˆªå®˜ç¶² $9'; }
                else if(ctx.isForeign) {
                    if(isTruePhysical) { div = ctx.isBirthday ? 6 : 9; n = ctx.isBirthday ? 'ç”Ÿæ—¥å¯¦é«” $6' : 'æµ·å¤–å¯¦é«” $9'; }
                    else { div=18; n='æµ·å¤–ç¶²è³¼ $18'; }
                }
                return { miles: Math.trunc(ctx.twdBase/div), note: n };
            }
        }
    };

    // System
    function loadDB() {
        const raw = localStorage.getItem(DB_KEY);
        if(!raw) return { settings: { enabledBuiltins: ['hsbc_live','taishin_cx','ctbc_ci','hsbc_inf','ctbc_ci_inf'], billingDays: { ...DEFAULT_BILLING }, hsbc_autopay: true }, customCards: [], records: {}, limits: {}, warehouse: [] };
        const db = JSON.parse(raw);
        if(!db.records) db.records = {}; 
        if(!db.warehouse) db.warehouse = [];
        return db;
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function loadRules() { const raw = localStorage.getItem(RULES_KEY); return raw ? JSON.parse(raw) : {}; }
    function saveRules(data) { localStorage.setItem(RULES_KEY, JSON.stringify(data)); }

    function autoFixMissingCards() {
        const db = loadDB();
        let modified = false;
        if (!db.settings.enabledBuiltins.includes('hsbc_inf')) { db.settings.enabledBuiltins.push('hsbc_inf'); modified = true; }
        if (modified) saveDB(db);
    }

    // UI Logic
    function toggleFxInput(val) {
        const fxGroup = document.getElementById('fx-input-group');
        const amountLabel = document.getElementById('amount-label');
        const amountInput = document.getElementById('amount');
        if (val === 'FOREIGN') {
            fxGroup.style.display = 'block';
            amountLabel.innerText = 'æ¶ˆè²»é‡‘é¡ (å¤–å¹£)';
            amountInput.placeholder = 'è¼¸å…¥å¤–å¹£é‡‘é¡';
        } else {
            fxGroup.style.display = 'none';
            amountLabel.innerText = 'æ¶ˆè²»é‡‘é¡ (TWD)';
            amountInput.placeholder = 'è¼¸å…¥å°å¹£é‡‘é¡';
        }
    }

    function toggleSign(id) {
        const el = document.getElementById(id);
        let val = parseFloat(el.value);
        if(isNaN(val)) val = 0;
        el.value = val * -1;
        checkInputStyle(el);
    }
    
    function toggleSwitch(id) {
        const checkbox = document.getElementById(id);
        checkbox.checked = !checkbox.checked;
    }

    function checkInputStyle(el) {
        const val = parseFloat(el.value);
        const statusId = el.id + '-status';
        const statusEl = document.getElementById(statusId);
        if(val < 0) {
            el.classList.add('input-negative');
            if(statusEl) statusEl.style.display = 'block';
        } else {
            el.classList.remove('input-negative');
            if(statusEl) statusEl.style.display = 'none';
        }
    }

    // Calculation
    let currentResults = [];
    function calculate() {
        const db = loadDB();
        const rules = loadRules();
        const amt = parseFloat(document.getElementById('amount').value);
        if(isNaN(amt) || amt === 0) return showAlert('è«‹è¼¸å…¥é‡‘é¡ï¼');
        
        const currType = document.getElementById('currency-type').value;
        let twdBase = amt;
        let twdSpend = amt;
        let rate = 1;

        if (currType === 'FOREIGN') {
            const rateInput = document.getElementById('fx-rate-input').value;
            if(!rateInput) return showAlert('è«‹è¼¸å…¥å¤–å¹£åŒ¯ç‡ï¼');
            rate = parseFloat(rateInput);
            twdBase = Math.round(amt * rate);
            twdSpend = Math.round(twdBase * 1.015);
        }

        const ctx = {
            db: db, curr: currType==='FOREIGN'?'USD':'TWD',
            cat: document.getElementById('category').value,
            pay: document.getElementById('payment').value,
            kwKey: (document.getElementById('keyword-input').value || '').trim().toLowerCase(),
            isBirthday: document.getElementById('birthdayMode').checked,
            isFlyMode: document.getElementById('flyMode').checked,
            isForeign: currType === 'FOREIGN',
            isEUR: false, 
            twdBase: twdBase, twdSpend: twdSpend, isLiveSelect: false
        };

        if(ctx.cat === 'dining') ctx.isLiveSelect = true;
        else if(LIVE_KEYWORDS['dining'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['shop'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['entertainment'].some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;
        if(ctx.kwKey.includes('éº¥ç•¶å‹')) ctx.isLiveSelect = true; 

        // Update FX Info Panel
        const fxInfo = document.getElementById('fx-info');
        const scenarioTag = document.getElementById('scenario-tag');
        if(ctx.isForeign) {
            scenarioTag.innerText = 'å¤–å¹£æ¶ˆè²»';
            fxInfo.style.display = 'block';
            fxInfo.innerHTML = `<div class="small text-muted">æŠ˜åˆå°å¹£ $${twdBase.toLocaleString()}</div><div class="fw-bold text-dark">æˆæœ¬ $${twdSpend.toLocaleString()} <small class="text-secondary">(å«1.5%)</small></div>`;
        } else {
            scenarioTag.innerText = 'ä¸€èˆ¬æ¶ˆè²»';
            fxInfo.style.display = 'none';
        }

        currentResults = [];
        
        const resolveMiles = (cardId, defCalc) => {
            const ruleKey = `${ctx.kwKey}|${cardId}`;
            if(ctx.kwKey && rules[ruleKey] !== undefined) {
                const customDiv = rules[ruleKey];
                return customDiv===0 ? { miles:0, note:'âš™ï¸ è‡ªè¨‚: ç„¡å›é¥‹' } : { miles: Math.trunc(ctx.twdBase/customDiv), note:`âš™ï¸ è‡ªè¨‚: $${customDiv}/å“©` };
            }
            return defCalc();
        };

        db.settings.enabledBuiltins.forEach(cardId => {
            if(CARD_RULES[cardId]) {
                const res = resolveMiles(cardId, () => CARD_RULES[cardId].calc(ctx));
                currentResults.push({ id: cardId, name: CARD_RULES[cardId].name, ...res, twdSpend, twdBase });
            }
        });
        db.customCards.forEach(c => {
            const res = resolveMiles(c.id, () => {
                let div = ctx.isForeign ? c.forRate : c.domRate;
                return { miles: Math.trunc(ctx.twdBase/div), note: `è‡ªè¨‚ $${div}/å“©` };
            });
            currentResults.push({ id: c.id, name: c.name, ...res, twdSpend, twdBase });
        });

        currentResults.sort((a,b) => b.miles - a.miles);
        renderResults(currentResults);
    }

    function renderResults(list) {
        const con = document.getElementById('cards-container'); con.innerHTML = '';
        document.getElementById('result-area').style.display = 'block';
        list.forEach((c, idx) => {
            const isWinner = idx === 0;
            const btnClass = isWinner ? 'btn-record-win' : '';
            const tpm = c.miles > 0 ? (c.twdSpend / c.miles).toFixed(1) : '-';
            
            const div = document.createElement('div'); div.className = `plan-card ${isWinner ? 'plan-winner' : ''}`;
            div.innerHTML = `
            ${isWinner ? '<span class="winner-badge">WINNER</span>' : ''}
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-name">${c.name}</h4>
                    <div class="text-muted small font-hand">${c.note}</div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn-card-action ${btnClass}" onclick="recordTx(${idx})">ğŸ“ è¨˜å¸³</button>
                        <button class="btn-correct" onclick="openCorrection('${c.id}','${c.name}')"><i class="fa-solid fa-pen"></i> ä¿®æ­£</button>
                    </div>
                </div>
                <div class="text-end">
                    <div class="card-miles">${c.miles.toLocaleString()} <small style="font-size:0.5em">å“©</small></div>
                    <div class="text-muted small fw-bold">${tpm} å…ƒ/å“©</div>
                </div>
            </div>`;
            con.appendChild(div);
        });
    }

    function recordTx(idx) {
        const item = currentResults[idx];
        const db = loadDB();
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        
        if(!db.records[monthKey]) db.records[monthKey] = {};
        const txId = `tx_${Date.now()}`;
        
        let unitText = 'å“©'; let points = item.miles;
        if(item.id==='hsbc_live') { points = Math.trunc(item.miles/2); unitText='ç©åˆ†'; }
        else if(item.id==='hsbc_inf') { unitText='ç©åˆ†'; }

        db.records[monthKey][txId] = {
            id: item.id, name: item.name, spend: item.twdBase, miles: points, unit: unitText,
            note: document.getElementById('keyword-input').value || 'ä¸€èˆ¬æ¶ˆè²»'
        };

        const limitKey = getLimitKey(db, item.id, now);
        if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0 };
        if(item.id!=='taishin_cx' || item.miles > item.twdBase/20) {
             db.limits[limitKey].spend += item.twdBase;
        }
        
        saveDB(db);
        updateUI();
        showAlert(`âœ… å·²åŠ å…¥å¾…çµç®—æ˜ç´°\n${item.name}: +${points} ${unitText}`);
    }

    function getLimitKey(db, id, dateObj) {
        if(id === 'taishin_cx') return `${dateObj.getFullYear()}-${id}`;
        let day = db.settings.billingDays[id.split('_')[0]] || 1;
        const offset = dateObj.getDate() > day ? 1 : 0;
        const d = new Date(dateObj.getFullYear(), dateObj.getMonth() + offset, 1);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${id}`;
    }

    function renderList() {
        const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const data = db.records[monthKey] || {};
        const con = document.getElementById('transaction-list-container'); con.innerHTML = '';
        
        const groups = {};
        let count = 0;
        for(let key in data) {
            const r = data[key];
            if(!groups[r.name]) groups[r.name] = [];
            groups[r.name].push({ ...r, key });
            count++;
        }
        document.getElementById('nav-badge-list').innerText = count;
        document.getElementById('nav-badge-list').style.display = count > 0 ? 'block' : 'none';
        document.getElementById('pending-count').innerText = `${count} ç­†`;

        if(count === 0) { con.innerHTML = '<div class="text-center text-muted py-5">ç›®å‰æ²’æœ‰å¾…çµç®—çš„ç´€éŒ„</div>'; return; }

        for(let name in groups) {
            let html = `<div class="list-group-card"><div class="list-group-header"><span>${name}</span></div><div>`;
            groups[name].forEach(item => {
                html += `
                <div class="list-item">
                    <div class="item-meta">
                        <span>${item.note}</span>
                        <span class="text-muted" style="font-size:0.7rem;">${new Date(parseInt(item.key.split('_')[1])).toLocaleDateString()}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="item-val">
                            <div class="${item.spend<0?'text-danger':''}">${item.spend.toLocaleString()}</div>
                            <div class="text-primary small">+${item.miles} ${item.unit}</div>
                        </div>
                        <div class="btn-item-del" onclick="delTx('${monthKey}','${item.key}')"><i class="fa-solid fa-trash-can"></i></div>
                    </div>
                </div>`;
            });
            html += '</div></div>';
            con.innerHTML += html;
        }
    }

    function delTx(monthKey, txId) {
        showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ\n(åŒæ™‚æœƒé€€é‚„ç´¯ç©é¡åº¦)', () => {
            const db = loadDB();
            const rec = db.records[monthKey][txId];
            if(rec) {
                const limitKey = getLimitKey(db, rec.id, new Date());
                if(db.limits[limitKey]) { db.limits[limitKey].spend -= rec.spend; }
                delete db.records[monthKey][txId];
                saveDB(db); updateUI();
            }
        });
    }

    function renderStatus() {
        const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const data = db.records[monthKey] || {};
        const agg = {};
        for(let key in data) {
            const r = data[key];
            if(!agg[r.id]) agg[r.id] = { name: r.name, spend: 0, miles: 0, unit: r.unit };
            agg[r.id].spend += r.spend;
            agg[r.id].miles += r.miles;
        }
        
        const statusCon = document.getElementById('status-container');
        if(Object.keys(agg).length === 0) statusCon.innerHTML = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´¯ç©</div>';
        else {
            let h = '';
            for(let id in agg) {
                const item = agg[id];
                let u = item.unit;
                if(!u || u==='undefined') { u = (id.includes('hsbc')) ? 'ç©åˆ†' : 'å“©'; }
                h += `<div class="summary-card"><div><div class="summary-name">${item.name}</div><div class="summary-spend">$${item.spend.toLocaleString()}</div></div><div class="summary-miles">${item.miles.toLocaleString()} <small style="font-size:0.6em">${u}</small></div></div>`;
            }
            statusCon.innerHTML = h;
        }

        const limitsCon = document.getElementById('limits-container'); let lh = '';
        const cards = [];
        db.settings.enabledBuiltins.forEach(id => cards.push({ id, name: BUILTIN_DEFS.find(d=>d.id===id).name, limit: getLimitVal(id) }));
        cards.forEach(c => {
            const lKey = getLimitKey(db, c.id, now);
            const curr = db.limits[lKey] ? db.limits[lKey].spend : 0;
            const pct = Math.min(100, (curr/c.limit)*100);
            lh += `<div class="mb-3"><div class="d-flex justify-content-between small mb-1"><strong>${c.name}</strong><span>$${curr.toLocaleString()} / $${c.limit.toLocaleString()}</span></div><div class="progress" style="height:6px"><div class="progress-bar ${pct>80?'bg-warning':'bg-success'}" style="width:${pct}%"></div></div></div>`;
        });
        limitsCon.innerHTML = lh;
    }

    function getLimitVal(id) { 
        if(id==='hsbc_live') return 29600; 
        if(id==='ctbc_ci_inf') return 600000; 
        if(id==='taishin_cx') return 1000000; 
        if(id==='ctbc_ci') return 1440000; 
        return 999999; 
    }

    function renderWarehouse() {
        const db = loadDB(); const list = document.getElementById('warehouse-list'); list.innerHTML = '';
        if(db.warehouse.length === 0) { list.innerHTML = '<div class="text-muted text-center py-4">å€‰åº«æ˜¯ç©ºçš„</div>'; return; }
        
        const groups = {};
        db.warehouse.forEach((asset, idx) => {
            const key = asset.targetAirline;
            if(!groups[key]) groups[key] = { total: 0, items: [] };
            let equiv = 0;
            if(asset.type === 'airline') { equiv = asset.current; } 
            else { 
               const ratio = (asset.unitMiles / asset.unitPoints);
               equiv = Math.floor(asset.current * ratio);
            }
            groups[key].total += equiv;
            groups[key].items.push({ ...asset, idx });
        });

        for(let key in groups) {
            const g = groups[key];
            let itemsHtml = '';
            g.items.forEach(item => {
                itemsHtml += `
                <div class="asset-item">
                    <div class="asset-info">
                        <div class="asset-name">${item.name}</div>
                        <div class="asset-detail text-muted">æŒæœ‰: ${item.current.toLocaleString()} / ä¼°å€¼: ${Math.floor(item.current * (item.unitMiles/item.unitPoints)).toLocaleString()} å“©</div>
                    </div>
                    <div>
                        <i class="fa-solid fa-pen btn-asset-del me-2 text-primary" onclick="openEditAsset(${item.idx})"></i>
                        <i class="fa-solid fa-trash-can btn-asset-del text-danger" onclick="delAsset(${item.idx})"></i>
                    </div>
                </div>`;
            });

            const div = document.createElement('div'); div.className = 'airline-group-card';
            div.innerHTML = `
            <div class="airline-header"><div class="airline-title"><i class="fa-solid fa-plane-up me-2"></i>${key}</div><div class="airline-total">${g.total.toLocaleString()} <small style="font-size:0.5em;">å“©(ä¼°)</small></div></div>
            <div class="airline-body">${itemsHtml}</div>`;
            list.appendChild(div);
        }
    }
    
    function addNativeAsset() {
        const name = document.getElementById('native-airline-name').value; const val = parseFloat(document.getElementById('native-current').value);
        if(!name || isNaN(val)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'airline', targetAirline: name, name: name, current: val, unitPoints:1, unitMiles:1 });
        saveDB(db); renderWarehouse(); document.getElementById('native-airline-name').value=''; document.getElementById('native-current').value='';
    }
    
    function addTransferAsset() {
        const src = document.getElementById('trans-source-name').value; 
        const val = parseFloat(document.getElementById('trans-current').value); 
        const target = document.getElementById('trans-target-airline').value;
        const uP = parseFloat(document.getElementById('trans-unit-points').value); 
        const uM = parseFloat(document.getElementById('trans-unit-miles').value);
        if(!src || !target || isNaN(val) || isNaN(uP) || isNaN(uM)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'transfer', targetAirline: target, name: src, current: val, unitPoints: uP, unitMiles: uM });
        saveDB(db); renderWarehouse(); document.getElementById('trans-source-name').value=''; document.getElementById('trans-current').value='';
    }

    function delAsset(idx) { showConfirm('ç¢ºå®šè¦åˆªé™¤é€™é …è³‡ç”¢å—ï¼Ÿ', () => { const db = loadDB(); db.warehouse.splice(idx, 1); saveDB(db); renderWarehouse(); }); }
    function openEditAsset(idx) { editAssetTargetIdx = idx; const db = loadDB(); const asset = db.warehouse[idx]; document.getElementById('edit-asset-name').innerText = asset.name; document.getElementById('edit-asset-val').value = asset.current; new bootstrap.Modal(document.getElementById('editAssetModal')).show(); }
    function saveAssetEdit() { const val = parseFloat(document.getElementById('edit-asset-val').value); if(isNaN(val)) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼'); const db = loadDB(); db.warehouse[editAssetTargetIdx].current = val; saveDB(db); renderWarehouse(); bootstrap.Modal.getOrCreateInstance(document.getElementById('editAssetModal')).hide(); }

    function batchImport() {
        showConfirm('ç¢ºå®šå°‡æ˜ç´°å…¨éƒ¨å­˜å…¥å€‰åº«ï¼Ÿ', () => {
            const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const data = db.records[monthKey];
            if(!data) return;
            for(let k in data) {
                const r = data[k];
                const rule = AUTO_ASSETS[r.id];
                if(rule) {
                    let asset = db.warehouse.find(a => a.targetAirline === rule.target);
                    if(!asset) { asset = { type: rule.type, targetAirline: rule.target, name: rule.target, current: 0, unitPoints:rule.unitPoints, unitMiles:rule.unitMiles }; db.warehouse.push(asset); }
                    asset.current += r.miles;
                }
            }
            db.records[monthKey] = {};
            saveDB(db); updateUI(); showAlert('âœ… å·²å…¨éƒ¨å…¥åº«ï¼');
        });
    }
    
    function clearCurrentStats() { 
        showConfirm('ç¢ºå®šè¦é‡ç½®æœ¬æœŸæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\n(é€™æœƒå°‡æœ¬æœˆç›¸é—œçš„é¡åº¦å…¨éƒ¨é€€é‚„)', () => { 
            const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            if(db.records[monthKey]) {
                for(let id in db.records[monthKey]) {
                    const rec = db.records[monthKey][id];
                    const limitKey = getLimitKey(db, rec.id, now);
                    if(db.limits[limitKey]) { db.limits[limitKey].spend -= rec.spend; }
                }
                db.records[monthKey] = {}; saveDB(db); updateUI(); 
            }
        }); 
    }

    function switchPage(p, btn) {
        document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
        document.getElementById(`page-${p}`).style.display='block';
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        if(p==='warehouse') renderWarehouse();
        window.scrollTo(0,0);
    }

    function openCorrection(id, name) { correctionTarget = { id, name }; const k = document.getElementById('keyword-input').value; if(!k) return showAlert('è«‹å…ˆåœ¨ä¸»ç•«é¢è¼¸å…¥ã€Œé—œéµå­—ã€æ‰èƒ½è¨­å®šä¿®æ­£è¦å‰‡'); document.getElementById('modal-card-name').innerText = name; document.getElementById('modal-keyword').innerText = k; document.getElementById('modal-new-rate').value = ''; new bootstrap.Modal(document.getElementById('correctionModal')).show(); }
    function saveCorrection() { const rate = parseFloat(document.getElementById('modal-new-rate').value); if(isNaN(rate)) return showAlert('è«‹è¼¸å…¥æ•¸å€¼'); const k = document.getElementById('modal-keyword').innerText; const ruleKey = `${k}|${correctionTarget.id}`; const rules = loadRules(); rules[ruleKey] = rate; saveRules(rules); bootstrap.Modal.getOrCreateInstance(document.getElementById('correctionModal')).hide(); calculate(); }

    function updateUI() { renderList(); renderStatus(); }
    function showConfirm(msg, cb) { if(confirm(msg)) cb(); }
    function showAlert(msg) { document.getElementById('alert-msg').innerText=msg; new bootstrap.Modal(document.getElementById('customAlertModal')).show(); }

    // Enhanced Guide with Warehouse & Settings
    function openGuide() {
        const content = `
        <div class="guide-slide p-4 mb-4" style="background:var(--m-sage); color:white;">
            <div class="g-badge bg-white/20 mb-2">æ ¸å¿ƒæ¶æ§‹</div>
            <div class="g-title font-black mb-3">å¸³å‹™æµç¨‹åœ–è§£</div>
            <ul class="g-list text-sm">
                <li><b>Step 1 è¨ˆç®— (Calc)ï¼š</b>è¼¸å…¥é‡‘é¡èˆ‡åŒ¯ç‡ï¼Œç³»çµ±è‡ªå‹•æ¯”æ‹šæœ€å„ªå¡ç‰‡ã€‚</li>
                <li><b>Step 2 æ ¸å° (List)ï¼š</b>è¨˜å¸³å¾Œé€²å…¥ã€Œæ˜ç´°ã€åˆ†é ï¼ˆæš«å­˜å€ï¼‰ï¼Œå¯é€ç­†æª¢æŸ¥éŒ¯èª¤ä¸¦åˆªé™¤ã€‚</li>
                <li><b>Step 3 é€²å€‰ (Status)ï¼š</b>ç¢ºèªç„¡èª¤å¾Œï¼Œè‡³ã€Œç›£æ§ã€åˆ†é æŒ‰ã€Œä¸€éµé€²å€‰ã€æ­¸æˆ¶ã€‚</li>
            </ul>
        </div>
        <div class="guide-slide p-4 mb-4" style="background:var(--m-stone); color:white;">
            <div class="g-badge bg-white/20 mb-2">å€‰åº«ä½¿ç”¨æŒ‡å—</div>
            <div class="g-title font-black mb-3">åŸç”Ÿ vs è½‰é»</div>
            <p class="text-sm mb-2"><b>âœˆï¸ åŸç”Ÿå“©ç¨‹ï¼š</b>ç›´æ¥å­˜åœ¨èˆªç©ºå…¬å¸çš„å“©ç¨‹ (1:1)ã€‚</p>
            <p class="text-sm mb-2"><b>â‡„ è½‰é»ç©åˆ†ï¼š</b>å­˜åœ¨éŠ€è¡Œçš„ç©åˆ† (å¦‚å°æ¨¹é»)ã€‚</p>
            <div class="g-box text-xs">
                <b>è¨­å®šæ•™å­¸ï¼š</b><br>
                1. å¡«å¯«ä¾†æº (å¦‚ï¼šå°æ¨¹é»)ã€‚<br>
                2. å¡«å¯«å…¬å¼ (å¦‚ï¼š360é» = 1000å“©)ã€‚<br>
                3. æŒ‰ä¸‹ã€Œå­˜å…¥ã€ï¼Œç³»çµ±è‡ªå‹•ä¼°ç®—ç¸½åƒ¹å€¼ã€‚
            </div>
        </div>
        <div class="guide-slide p-4 mb-4" style="background:var(--m-sand); color:#5e503f;">
            <div class="g-badge bg-white/40 mb-2">è¨­å®šæ•™å­¸</div>
            <div class="g-title font-black mb-3">æ–°å¢è‡ªè¨‚å¡ç‰‡</div>
            <p class="text-sm mb-2">è‹¥ä¸»åŠ›å¡ç‰‡ä¸åœ¨å…§å»ºåå–® (å¦‚ç‰å±± Only)ï¼š</p>
            <ol class="text-sm ps-3" style="list-style-type:decimal;">
                <li>é»æ“Šå³ä¸Šè§’ <b>âš™ï¸ è¨­å®š</b> æŒ‰éˆ•ã€‚</li>
                <li>æ»‘å‹•è‡³ã€Œè‡ªè¨‚å¡ç‰‡ã€å€å¡Šã€‚</li>
                <li>è¼¸å…¥åç¨± (å¦‚ï¼šç‰å±± Only)ã€‚</li>
                <li>è¼¸å…¥ <b>åœ‹å…§/åœ‹å¤–</b> çš„ã€Œå¹¾å…ƒä¸€å“©ã€æ•¸å€¼ã€‚</li>
                <li>æŒ‰ä¸‹ã€Œç¢ºèªæ–°å¢ã€ï¼Œè¨ˆç®—æ©Ÿå°±æœƒå°‡å…¶ç´å…¥æ¯”æ‹šã€‚</li>
            </ol>
        </div>
        <div class="guide-slide p-4 mb-4" style="background:var(--m-dusty); color:white;">
            <div class="g-badge bg-white/20 mb-2">é˜²å‘†æ©Ÿåˆ¶</div>
            <div class="g-title font-black mb-3">å®˜ç¶²èˆ‡å¯¦é«”</div>
            <p class="text-sm">ç³»çµ±å…§å»ºåš´æ ¼åˆ¤å®šï¼šåªè¦é¡åˆ¥æ˜¯ã€Œå®˜ç¶²è³¼ç¥¨ã€æˆ–ã€Œè¨‚æˆ¿ç¶²ã€ï¼Œç³»çµ±å¼·åˆ¶é–å®šç‚º <b>Online</b> äº¤æ˜“ã€‚å³ä¾¿æ‚¨èª¤é¸å¯¦é«”å¡ï¼Œç³»çµ±ä¹Ÿæœƒæ“‹ä¸‹ï¼Œé¿å…éŒ¯èª¤è¨ˆç®—ä¸­ä¿¡ç”Ÿæ—¥åŠ ç¢¼ ($6.6)ã€‚</p>
        </div>
        <div class="guide-slide p-4" style="background:var(--m-slate); color:white;">
            <div class="g-badge bg-white/20 mb-2">é€²éšæŠ€å·§</div>
            <div class="g-title font-black mb-3">éŠ·å¸³/æ²–å¸³æ•™å­¸</div>
            <p class="text-sm">è‹¥å·²é€²å€‰ç„¡æ³•åˆªé™¤ï¼Œè«‹åœ¨è¨ˆç®—é è¼¸å…¥åŒé‡‘é¡ï¼ŒæŒ‰ä¸‹ <b>[é€€åˆ·/ä¿®æ­£]</b> è®Šç‚ºè² æ•¸ï¼Œå†è¨˜å¸³ä¸€æ¬¡å³å¯æŠµéŠ·ã€‚</p>
        </div>
        `;
        document.getElementById('guide-content').innerHTML = content;
        new bootstrap.Modal(document.getElementById('guideModal')).show();
    }
    
    function openSettings() { new bootstrap.Modal(document.getElementById('settingsModal')).show(); renderSettings(); }
    function renderSettings() {
        const db = loadDB(); document.getElementById('setting-hsbc-autopay').checked = db.settings.hsbc_autopay;
        const builtinCon = document.getElementById('builtin-cards-list'); builtinCon.innerHTML = ''; 
        BUILTIN_DEFS.forEach(def => { const isOn = db.settings.enabledBuiltins.includes(def.id); builtinCon.innerHTML += `<div class="switch-group mb-2"><span class="switch-label">${def.name}</span><input class="form-check-input" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')"></div>`; });
        const customCon = document.getElementById('custom-cards-list'); customCon.innerHTML = ''; 
        db.customCards.forEach((c, idx) => { customCon.innerHTML += `<div class="custom-card-item"><div><div class="fw-bold">${c.name}</div></div><div class="delete-btn" onclick="delCustomCard(${idx})"><i class="fa-solid fa-trash"></i></div></div>`; });
    }
    function updateGlobalSetting(key, val) { const db = loadDB(); db.settings[key] = val; saveDB(db); }
    function toggleBuiltin(id) { const db = loadDB(); const idx = db.settings.enabledBuiltins.indexOf(id); if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1); else db.settings.enabledBuiltins.push(id); saveDB(db); }
    function addCustomCard() { const name = document.getElementById('new-card-name').value; const dom = parseFloat(document.getElementById('new-card-dom').value); const fore = parseFloat(document.getElementById('new-card-for').value); if(!name || isNaN(dom)) return; const db = loadDB(); db.customCards.push({ id:`cust_${Date.now()}`, name, domRate:dom, forRate:fore }); saveDB(db); renderSettings(); }
    function delCustomCard(idx) { const db = loadDB(); db.customCards.splice(idx, 1); saveDB(db); renderSettings(); }

    window.onload = function() { 
        autoFixMissingCards(); 
        updateUI(); 
        toggleFxInput('TWD'); 
        renderWarehouse(); 
    };
  </script>
</body>
</html>

